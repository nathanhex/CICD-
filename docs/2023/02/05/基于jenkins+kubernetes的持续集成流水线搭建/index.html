<!DOCTYPE html><html lang="[&quot;zh-CN&quot;,&quot;en&quot;,&quot;default&quot;]" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>基于jenkins+kubernetes的持续集成流水线搭建 | 老丶黄的个人博客</title><meta name="author" content="老黄"><meta name="copyright" content="老黄"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="jenkins是什么？Jenkins是一款开源 CICD 软件，用于自动化各种任务，包括构建、测试和部署软件。 Jenkins 支持各种运行方式，可通过系统包、Docker 或者通过一个独立的 Java 程序。 why jenkins kubernetes持续构建与发布是我们日常工作中必不可少的一个步骤，jenkins需要的资源有时候单台机器不一定能满足全公司的构建发布需求，所以使用一般需要Jen">
<meta property="og:type" content="article">
<meta property="og:title" content="基于jenkins+kubernetes的持续集成流水线搭建">
<meta property="og:url" content="https://nathanhex.github.io/CICD-Practice/2023/02/05/%E5%9F%BA%E4%BA%8Ejenkins+kubernetes%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%90%AD%E5%BB%BA/index.html">
<meta property="og:site_name" content="老丶黄的个人博客">
<meta property="og:description" content="jenkins是什么？Jenkins是一款开源 CICD 软件，用于自动化各种任务，包括构建、测试和部署软件。 Jenkins 支持各种运行方式，可通过系统包、Docker 或者通过一个独立的 Java 程序。 why jenkins kubernetes持续构建与发布是我们日常工作中必不可少的一个步骤，jenkins需要的资源有时候单台机器不一定能满足全公司的构建发布需求，所以使用一般需要Jen">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg">
<meta property="article:published_time" content="2023-02-04T16:00:00.000Z">
<meta property="article:modified_time" content="2023-03-04T04:28:24.290Z">
<meta property="article:author" content="老黄">
<meta property="article:tag" content="jenkins">
<meta property="article:tag" content="kubernetes">
<meta property="article:tag" content="CICD">
<meta property="article:tag" content="持续交付">
<meta property="article:tag" content="devops">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><link rel="shortcut icon" href="/CICD-Practice/img/favicon.png"><link rel="canonical" href="https://nathanhex.github.io/CICD-Practice/2023/02/05/%E5%9F%BA%E4%BA%8Ejenkins+kubernetes%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%90%AD%E5%BB%BA/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/CICD-Practice/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/CICD-Practice/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: 老黄","link":"链接: ","source":"来源: 老丶黄的个人博客","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '基于jenkins+kubernetes的持续集成流水线搭建',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-03-04 12:28:24'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = url => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      link.onload = () => resolve()
      link.onerror = () => reject()
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/CICD-Practice/archives/"><div class="headline">文章</div><div class="length-num">3</div></a><a href="/CICD-Practice/tags/"><div class="headline">标签</div><div class="length-num">6</div></a><a href="/CICD-Practice/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/CICD-Practice/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/CICD-Practice/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/CICD-Practice/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/CICD-Practice/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg')"><nav id="nav"><span id="blog-info"><a href="/CICD-Practice/" title="老丶黄的个人博客"><img class="site-icon" src="/CICD-Practice/images/main-logo.jpg"/><span class="site-name">老丶黄的个人博客</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/CICD-Practice/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/CICD-Practice/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/CICD-Practice/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/CICD-Practice/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">基于jenkins+kubernetes的持续集成流水线搭建</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-02-04T16:00:00.000Z" title="发表于 2023-02-05 00:00:00">2023-02-05</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-03-04T04:28:24.290Z" title="更新于 2023-03-04 12:28:24">2023-03-04</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/CICD-Practice/categories/CICD/">CICD</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/CICD-Practice/categories/CICD/%E7%B3%BB%E7%BB%9F%E5%B7%A5%E5%85%B7/">系统工具</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="基于jenkins+kubernetes的持续集成流水线搭建"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="jenkins是什么？"><a href="#jenkins是什么？" class="headerlink" title="jenkins是什么？"></a>jenkins是什么？</h1><p>Jenkins是一款开源 CICD 软件，用于自动化各种任务，包括构建、测试和部署软件。</p>
<p>Jenkins 支持各种运行方式，可通过系统包、Docker 或者通过一个独立的 Java 程序。</p>
<h1 id="why-jenkins-kubernetes"><a href="#why-jenkins-kubernetes" class="headerlink" title="why jenkins kubernetes"></a>why jenkins kubernetes</h1><p>持续构建与发布是我们日常工作中必不可少的一个步骤，jenkins需要的资源有时候单台机器不一定能满足全公司的构建发布需求，所以使用一般需要Jenkins 集群来搭建符合需求的 CI&#x2F;CD 流程，然而传统的 Jenkins Slave 一主多从方式会存在一些痛点:</p>
<p>痛点1：主 Master 发生单点故障时，整个流程都不可用了；</p>
<p>痛点2：每个 Slave 的配置环境不一样，来完成不同语言的编译打包等操作，但是这些差异化的配置导致管理起来非常不方便，维护起来也是比较费劲；</p>
<p>痛点3：资源分配不均衡，有的 Slave 要运行的 job 出现排队等待，而有的 Slave 处于空闲状态；</p>
<p>痛点4：最后资源有浪费，每台 Slave 可能是实体机或者 VM，当 Slave 处于空闲状态时，也不会完全释放掉资源。</p>
<h1 id="如何解决传统jenkins-集群问题："><a href="#如何解决传统jenkins-集群问题：" class="headerlink" title="如何解决传统jenkins 集群问题："></a>如何解决传统jenkins 集群问题：</h1><p>1.kubernetes deployment可以检测到jenkins master实例挂掉后在新的节点上重启一个新的jenkins master示例，重启的这段时间内jenkins还是无法使用，这个方案暂时不完美，但是可以通过冷备的方式解决master单点故障问题。</p>
<p>2.由docker提供slave节点需要的系统配置，确保了按需提供slave节点的软件环境，在pipline里声明任务所需的系统和软件环境，非常自由方便</p>
<p>3.slave节点由kubernetes管理，按需创建，使用完slave节点pod就销毁了，资源释放给其他任务使用，不会出现slave节点资源闲置浪费或等待排队的情况</p>
<h1 id="kubernetes集群安装"><a href="#kubernetes集群安装" class="headerlink" title="kubernetes集群安装"></a>kubernetes集群安装</h1><h2 id="动态存储"><a href="#动态存储" class="headerlink" title="动态存储"></a>动态存储</h2><h3 id="安装nfs"><a href="#安装nfs" class="headerlink" title="安装nfs"></a>安装nfs</h3><p>在主机192.168.0.105的centos系统下安装nfs：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装nfs</span></span><br><span class="line">sudo yum install nfs-utils</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建nfs数据文件夹夹</span></span><br><span class="line">sudo mkdir /data</span><br><span class="line">sudo chmod 755 /data</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">nfs配置</span></span><br><span class="line">sudo echo  &quot;/data/    *(rw,sync,no_root_squash,no_all_squash)&quot; &gt;&gt; /etc/exports</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动nfs相关服务</span></span><br><span class="line"> sudo systemctl enable rpcbind</span><br><span class="line">sudo systemctl enable nfs</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">可选操作，如果开启了防火墙，则需要使用如下命令开放nfs相关服务的端口</span></span><br><span class="line">sudo firewall-cmd --zone=public --permanent --add-service=&#123;rpc-bind,mountd,nfs&#125;</span><br><span class="line">sudo firewall-cmd --reload</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>nfs配置说明</p>
<ol>
<li><p><code>/data</code>: 共享目录位置。</p>
</li>
<li><p><code>*</code>: 客户端 IP 范围<code>*</code> 代表所有，即没有限制。<code>192.168.0.0/24</code>客户端 IP 范围在192.168.0.0-192.168.255.255之间的ip可以访问</p>
</li>
<li><p><code>rw</code>: 权限设置，可读可写。</p>
</li>
<li><p><code>sync</code>: 同步共享目录。</p>
</li>
<li><p><code>no_root_squash</code>: 可以使用 root 授权。</p>
</li>
<li><p><code>no_all_squash</code>: 可以使用普通用户授权。</p>
</li>
</ol>
<h3 id="安装StorageClass使用nfs提供动态存储卷"><a href="#安装StorageClass使用nfs提供动态存储卷" class="headerlink" title="安装StorageClass使用nfs提供动态存储卷"></a>安装StorageClass使用nfs提供动态存储卷</h3><ul>
<li>说明：假设nfs安装在192.168.0.105主机上，以下创建nfs-storage.yaml文件,内容如下:</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-provisioner</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-provisioner-runner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span>  <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">     <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumes&quot;</span>]</span><br><span class="line">     <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span>  <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">     <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class="line">     <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span>  <span class="attr">apiGroups:</span> [<span class="string">&quot;storage.k8s.io&quot;</span>]</span><br><span class="line">     <span class="attr">resources:</span> [<span class="string">&quot;storageclasses&quot;</span>]</span><br><span class="line">     <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span>  <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">     <span class="attr">resources:</span> [<span class="string">&quot;events&quot;</span>]</span><br><span class="line">     <span class="attr">verbs:</span> [<span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span>  <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">     <span class="attr">resources:</span> [<span class="string">&quot;services&quot;</span>, <span class="string">&quot;endpoints&quot;</span>]</span><br><span class="line">     <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;create&quot;</span>,<span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>,<span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span>  <span class="attr">apiGroups:</span> [<span class="string">&quot;extensions&quot;</span>]</span><br><span class="line">     <span class="attr">resources:</span> [<span class="string">&quot;podsecuritypolicies&quot;</span>]</span><br><span class="line">     <span class="attr">resourceNames:</span> [<span class="string">&quot;nfs-provisioner&quot;</span>]</span><br><span class="line">     <span class="attr">verbs:</span> [<span class="string">&quot;use&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">run-nfs-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-provisioner</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-provisioner-runner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="comment"># namespace: default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nfs-provisioner</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span>  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">           <span class="attr">image:</span> <span class="string">quay.io/external_storage/nfs-client-provisioner:v3.1.0-k8s1.11</span></span><br><span class="line">           <span class="attr">volumeMounts:</span></span><br><span class="line">             <span class="bullet">-</span>  <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">                <span class="attr">mountPath:</span>  <span class="string">/persistentvolumes</span></span><br><span class="line">           <span class="attr">env:</span></span><br><span class="line">             <span class="bullet">-</span>  <span class="attr">name:</span> <span class="string">PROVISIONER_NAME</span></span><br><span class="line">                <span class="attr">value:</span> <span class="string">fuseim.pri/nfs</span></span><br><span class="line">             <span class="bullet">-</span>  <span class="attr">name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line">                <span class="attr">value:</span>  <span class="number">192.168</span><span class="number">.0</span><span class="number">.105</span></span><br><span class="line">             <span class="bullet">-</span>  <span class="attr">name:</span> <span class="string">NFS_PATH</span></span><br><span class="line">                <span class="attr">value:</span> <span class="string">/data/</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">            <span class="attr">server:</span>  <span class="number">192.168</span><span class="number">.0</span><span class="number">.105</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/data/</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-storage</span></span><br><span class="line">  <span class="comment"># namespace: default</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">storageclass.kubernetes.io/is-default-class:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 存储分配器，和PROVISIONER_NAME环境变量一直，其他可选值可以参看：https://kubernetes.io/zh/docs/concepts/storage/storage-classes/#%e4%bb%8b%e7%bb%8d</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">fuseim.pri/nfs</span></span><br><span class="line"><span class="attr">reclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>执行命令：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply  -f nfs-storage.yaml</span><br></pre></td></tr></table></figure>

<p>yaml说明：</p>
<blockquote>
<p>1.创建了名称为nfs-provisioner的serviceAccount,</p>
</blockquote>
<blockquote>
<p>2.创建了名称为nfs-provisioner-runner的cluterRole，指定该角色的资源权限用于访问集群的pv和pvc，storageclasses等kubernetes资。</p>
</blockquote>
<blockquote>
<p>3.创建名称为run-nfs-provisioner的ClusterRoleBinding，用于绑定serviceaccount和clusterrole,将该nfs-provisioner-runner角色赋给nfs-provisioner的serviceAccount，使该sa可以访问改角色指定的资源</p>
</blockquote>
<blockquote>
<p>4.创建nfs-client-provisioner的deployment，运行nfs的客户端应用，挂载了nsf到pod内部的 &#x2F;persistentvolumes目录，通过环境变量NFS_SERVER来指定nfs的服务器地址为192.168.0.105，NFS_PATH来指定nfs服务器路径为：&#x2F;nfs，PROVISIONER_NAME指定一个名称用于绑定给StorageClass，由他该来提供nfs的动态存储给其他pod使用。</p>
</blockquote>
<blockquote>
<p>5.创建nfs-storage的StorageClass，通过provisioner指定的名称绑定具体的实际存储提供者。为pod提供动态的存储服务</p>
</blockquote>
<h1 id="安装jenkins"><a href="#安装jenkins" class="headerlink" title="安装jenkins"></a>安装jenkins</h1><h2 id="安装jenkins应用"><a href="#安装jenkins应用" class="headerlink" title="安装jenkins应用"></a>安装jenkins应用</h2><p>使用了nfs动态存储卷提供存储服务，创建jenkins-master.yaml文件，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 创建namespace</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment">##创建nfs-pvc</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins-pvc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 引用指定的StorageClass</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs-storage</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1024Mi</span></span><br><span class="line"><span class="comment">## namespace jenkins 的RBAC授权配置</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>,<span class="string">&quot;delete&quot;</span>,<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;patch&quot;</span>,<span class="string">&quot;update&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;pods/exec&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>,<span class="string">&quot;delete&quot;</span>,<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;patch&quot;</span>,<span class="string">&quot;update&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;pods/log&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>,<span class="string">&quot;list&quot;</span>,<span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;events&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;secrets&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;configmap&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment">##创建jenkins master</span></span><br><span class="line"><span class="attr">apiVersion:</span>  <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins-master</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">jenkins-master</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="comment"># 指定serviceAccount，便于控制jenkins访问kubernetes集群的权限</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">jenkins</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jenkins-master</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">jenkins/jenkins:lts-alpine</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="comment">#        env:</span></span><br><span class="line">          <span class="comment">#          - name: JAVA_OPTS</span></span><br><span class="line">          <span class="comment">#            value: -Dhttp.proxyPort=1082 -Dhttp.proxyHost=192.168.0.109 -Dhttps.proxyPort=1082 -Dhttp.nonProxyHosts=&#x27;localhost|127.0.0.1&#x27; -Dhttps.proxyHost=192.168.0.109 -Dhttps.nonProxyHosts=&#x27;localhost|127.0.0.1&#x27;</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jenkins-home</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/var/jenkins_home</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">50000</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">agent</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jenkins-home</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">jenkins-pvc</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins-master-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">jenkins</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">jenkins-master</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">50000</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">agent</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">50000</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">jenkins-master</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins-master-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="comment"># 将xxx.xxx.xxx修改成指定域名</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">xxx.xxx.xxx</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">serviceName:</span> <span class="string">jenkins-master-service</span></span><br><span class="line">              <span class="attr">servicePort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>

<p>yaml说明：</p>
<blockquote>
<p>1.创建jenkins-pvc，用于持久化存储jenkins的应用数据，防止重启后jenkins的数据丢失，通过storageClassName绑定使用那个动态存储卷提供持久化存储服务</p>
</blockquote>
<blockquote>
<p>2.创建名称为jenkins的namespace，用于将jenkins的相关service，deployment等等资源部署在该命名空间下</p>
</blockquote>
<blockquote>
<p>3.创建名称为jenkins的ServiceAccount，用于部署deployment时指定serviceAccont，这样deployment创建出来的pod就可以通过该serviceAccount方法kubernetes的资源</p>
</blockquote>
<blockquote>
<p>4.创建一个Role，权限只包含了访问kubernetes集群jenkins命名空间下的pod资源。</p>
</blockquote>
<blockquote>
<p>5.创建RoleBinding，用于给serviceAccount指定一个上面创建的角色，让jenkins可以访问kubernetes集群以动态的创建和销毁执行jenkins任务的pod</p>
</blockquote>
<blockquote>
<p>6.创建deployment，指定serviceAccountName为jenkins，让jenkins执行构建任务时会通过jenkins这个ServiceAccount身份操作kubernetes集群，在集群内生成一个pod作为jenkins agent节点执行任务</p>
</blockquote>
<blockquote>
<p>7.创建service，暴露8080和50000两个端口，8080是jenkins的web页面访问端口，50000是jnpl端口，用于slave节点连接到master节点的端口</p>
</blockquote>
<blockquote>
<p>8.创建ingress，用于向外提供访问域名，ingress host 的值“xxx.xxx.xxx”修改成自己的域名</p>
</blockquote>
<h2 id="安装并配置jenkins-kubernetes插件"><a href="#安装并配置jenkins-kubernetes插件" class="headerlink" title="安装并配置jenkins kubernetes插件"></a>安装并配置jenkins kubernetes插件</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>管理员账户登录 Jenkins Master 页面，点击 “系统管理” —&gt; “管理插件” —&gt; “可选插件” —&gt; “Kubernetes plugin” 勾选安装即可。</p>
<p><img src="/CICD-Practice/2023/02/05/%E5%9F%BA%E4%BA%8Ejenkins+kubernetes%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%90%AD%E5%BB%BA/300204872F112pff5d3d3e81371b3aeacfd15e75023a6d"></p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>点击”系统管理”-&gt;”节点管理”-&gt;”configure Clouds”-&gt;</p>
<p><img src="/CICD-Practice/2023/02/05/%E5%9F%BA%E4%BA%8Ejenkins+kubernetes%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%90%AD%E5%BB%BA/dAeEa3f141112pe58ca0f83f3db28e0401ff333281cb4f"></p>
<p><img src="/CICD-Practice/2023/02/05/%E5%9F%BA%E4%BA%8Ejenkins+kubernetes%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%90%AD%E5%BB%BA/344823F12C112p9d84f700d4209f62a2bd9c558c8c6e0a"></p>
<p>1.配置kubernetes集群地址</p>
<p><img src="/CICD-Practice/2023/02/05/%E5%9F%BA%E4%BA%8Ejenkins+kubernetes%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%90%AD%E5%BB%BA/1d1efC0B7d112p5a979300adac9d4505563d91b3902e6f"></p>
<blockquote>
<p>配置说明：</p>
</blockquote>
<blockquote>
<p>1.配置kubernetes集群地址，这里填写kubernetes.default。kubernetes集群在安装的时候都会在default命名空间下创建一个kubernetes的service，该service是kubernetes apiserver的服务，所以在集群内的任何pod都可以使用kubernetes.default来访问kubernetes集群的api。由于jenkins master部署在kubernetes内该，所以也jenkins master可以以serviceAccount指定的身份通过kubernetes.default这个服务名访问kubernetes的相关api。</p>
</blockquote>
<blockquote>
<p>2.在jenkins mster安装的那个步骤有访问权限相关配置和说明，所以kubernetes服务证书key这些我们可以不用再填写了</p>
</blockquote>
<blockquote>
<p>3.点击“连接测试”按钮，如果出现“Connected to Kubernetes v x.xx”字样，则表示连接kubernetes集群成功</p>
</blockquote>
<p><img src="/CICD-Practice/2023/02/05/%E5%9F%BA%E4%BA%8Ejenkins+kubernetes%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%90%AD%E5%BB%BA/c66BcFf442112pf016cb408d7c38e5488a91533a630eb0"></p>
<blockquote>
<p>1.jenkins地址：<a target="_blank" rel="noopener" href="http://jenkins-master-service:8080/">http://jenkins-master-service:8080</a>,</p>
</blockquote>
<blockquote>
<p>说明：jenkins web服务的地址，在安装jenkins时为jenkins的web服务声明jenkins-master-service服务名。通过该服务名+端口号就可访问到jenkins</p>
</blockquote>
<blockquote>
<p>2.jenkins 通道： jenkins-master-service:5000</p>
</blockquote>
<blockquote>
<p>说明：用于jenkins的slave节点和jenkins master通信的地址</p>
</blockquote>
<h2 id="安装jenkins-钉钉通知插件"><a href="#安装jenkins-钉钉通知插件" class="headerlink" title="安装jenkins 钉钉通知插件"></a>安装jenkins 钉钉通知插件</h2><p>在群设置的-&gt;”智能群助手”-&gt;”添加机器人”-&gt;”自定义机器人”</p>
<p><img src="/CICD-Practice/2023/02/05/%E5%9F%BA%E4%BA%8Ejenkins+kubernetes%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%90%AD%E5%BB%BA/5faEFDeeb8112pe125ab928d3b3be40ce4317666844fa5"></p>
<p><img src="/CICD-Practice/2023/02/05/%E5%9F%BA%E4%BA%8Ejenkins+kubernetes%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%90%AD%E5%BB%BA/A4d89BBA3C112p0837713edbdefacc90933f52d8c1994e"></p>
<p><img src="/CICD-Practice/2023/02/05/%E5%9F%BA%E4%BA%8Ejenkins+kubernetes%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%90%AD%E5%BB%BA/937D37cfae112pde8a20fe9343a42087c5bb0b2e99d809"></p>
<p><img src="/CICD-Practice/2023/02/05/%E5%9F%BA%E4%BA%8Ejenkins+kubernetes%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%90%AD%E5%BB%BA/ab73faffdB112pc3e029bc84d22c22b9b97bacf615aa5e"></p>
<p>配置说明：</p>
<blockquote>
<p>在钉钉群设置中添加一个机器人，安全配置选择加签方式，最后会获得一个带access_token的webhook地址</p>
</blockquote>
<p>在jenkins中安装钉钉插件：“系统管理”-&gt;“插件管理”搜索“Dindtalk”</p>
<p><img src="/CICD-Practice/2023/02/05/%E5%9F%BA%E4%BA%8Ejenkins+kubernetes%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%90%AD%E5%BB%BA/fd14bB26d3112p106796d0326456600342cfc4fc320252"></p>
<p>在jenkins的配置钉钉机器人：“系统管理”-&gt;”系统配置”-&gt;”钉钉”</p>
<p><img src="/CICD-Practice/2023/02/05/%E5%9F%BA%E4%BA%8Ejenkins+kubernetes%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%90%AD%E5%BB%BA/ecb433a30B112p7631ef276ba05105d1df6578241d61c3"></p>
<blockquote>
<p>配置说明：</p>
</blockquote>
<blockquote>
<p>id：自定义字符串，机器人的唯一身份标识，后续需通过该id指定访问该机器人</p>
</blockquote>
<blockquote>
<p>名称：机器人名称</p>
</blockquote>
<blockquote>
<p>webhook： 钉钉webhook地址，在上面配置钉钉机器人时钉钉生成的带access_token的webhook地址</p>
</blockquote>
<blockquote>
<p>加密：消息加密字符串，在上面配置钉钉机器人时，选择“加签”方式，钉钉会生成一个加签用的“sec”开头的字符串，将该字符串填入当前选项</p>
</blockquote>
<h1 id="安装nexus"><a href="#安装nexus" class="headerlink" title="安装nexus"></a>安装nexus</h1><p>详见<a target="_blank" rel="noopener" href="https://thoughts.aliyun.com/workspaces/5f37778f55b90500238b43cb/docs/637f33d0e4178b00019890fa"><strong>nexus安装配置教程</strong></a></p>
<h1 id="创建pipeline"><a href="#创建pipeline" class="headerlink" title="创建pipeline"></a>创建pipeline</h1><p>以下以java项目为例子的一个持续集成的时序图：</p>
<p><img src="/CICD-Practice/2023/02/05/%E5%9F%BA%E4%BA%8Ejenkins+kubernetes%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%90%AD%E5%BB%BA/fB578A8D12112qa2cb06aba4e3d0457c2615564ab9c877"></p>
<blockquote>
<p>说明：</p>
</blockquote>
<blockquote>
<p>万事开头难，所有应该尽量在满足持续集成的需求和配置复杂度之间取一个平衡点。</p>
</blockquote>
<blockquote>
<p>以上是经过团队的试错和磨合推敲出的一个可行的持续集成步骤。</p>
</blockquote>
<blockquote>
<p>1.持续集成的规约：</p>
</blockquote>
<blockquote>
<p>1.1 一个微服务一个源码仓库</p>
</blockquote>
<blockquote>
<p>1.2 配置也是代码的一部分，配置也要纳入版本管理</p>
</blockquote>
<blockquote>
<p>1.3 每个源码仓库包含2个分支，dev分支和master分支</p>
</blockquote>
<blockquote>
<p>1.4 产品严格按照功能优先级定义和开发，测试验收通过后的功能能马上发布生产环境，尽量避免功能做好了却不发布生产环境进行使用。（如果积累着测试完成的功能不发布也已经和持续集成目标相矛盾了）</p>
</blockquote>
<blockquote>
<p>1.5 合并master分支的代码必须是dev环境测试通过的的</p>
</blockquote>
<blockquote>
<p>1.6 单元测试必须覆盖所有public的方法</p>
</blockquote>
<blockquote>
<p>1.7  每天15点后必须将当天完成的某些功能添加&#x2F;修改，bug修复的代码合并到master分支，如果合并master后部署失败，当天必须解决</p>
</blockquote>
<blockquote>
<p>1.8 提倡单个功能新增&#x2F;修改或单个bug修复，提交dev构建测试完成后马上合并master进行测试环境的构建</p>
</blockquote>
<blockquote>
</blockquote>
<blockquote>
<p>2.步骤说明：</p>
</blockquote>
<blockquote>
<p>一、所有开发人员在dev分支开发和push代码，开发人员尽量保证每次push代码需要是一次可发布的产品；</p>
</blockquote>
<blockquote>
<p>二、开发人员在dev push代码后，源码仓库将通过webhook的方式通知jenkins执行pipeline的一系列步骤，编译源码-&gt;单元测试-&gt;构建docker镜像（版本号为latest）-&gt;推送镜像到nexus私人docker仓库的-&gt;部署最新镜像到开发k8s集群</p>
</blockquote>
<blockquote>
<p>三、开发人员在开发环境自行验证相关功能正常后将代码合并到master分支</p>
</blockquote>
<blockquote>
<p>四、jenkins收到master分支push代码的webhook通知后执行pipeline：</p>
</blockquote>
<blockquote>
<p>编译源码-&gt;单元测试-&gt;构建docker镜像（版本号为此时源码的commit id）-&gt;推送该镜像到nexus私人docker仓库-&gt;部署最新镜像到测试k8s集群</p>
</blockquote>
<blockquote>
<p>五、通知测试人员对测试环境进行测试</p>
</blockquote>
<blockquote>
<p>六、测试人员测试验收通过后，在源码仓库的master分支打上test-over标签。此标签类似记录了一个commit id</p>
</blockquote>
<blockquote>
<p>七、通知产品负责人确认是否部署到生产环境</p>
</blockquote>
<blockquote>
<p>八、得到确认后，相关人员对指定test-over标签再次进行打打release-vxxx的标签，并删除对应的test-over标签</p>
</blockquote>
<blockquote>
<p>九、jenkins收到master分支push代码的webhook通知后执行pipeline：拉取指定commit id对应的docker镜像-&gt;推送该镜像到生产环境docker仓库-&gt;部署最新镜像到生产k8s集群</p>
</blockquote>
<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><ul>
<li><p>配置jenkins命名空间的免密拉取镜像，用于jenkins slave pod执行时拉取特殊镜像</p>
</li>
<li><p>准备maven仓库本地共享卷，用于在构建任务中缓存到maven本地仓库</p>
</li>
<li><p>准备yarn缓存仓库本地共享卷，用于在构建任务中使用yarn缓存仓库</p>
</li>
<li><p>准备docker的配置文件，用于docker in docker中推送和拉取镜像</p>
</li>
<li><p>准备kubectl的配置文件，用于持续集成中操作对应的kubernetes集群，主要是部署应用到对应集群</p>
</li>
<li><p>准备maven的setting.xml配置文件</p>
</li>
<li><p>准备阿里云oss的client配置文件。流水线打包好的静态文件上传到阿里oss需要客户端配置交互凭证</p>
</li>
<li><p>准备node modules文件夹压缩包存放目录本地共享卷，用于前端项目缓存node_modules文件夹</p>
</li>
</ul>
<h3 id="1-配置文件格式："><a href="#1-配置文件格式：" class="headerlink" title="1.配置文件格式："></a>1.配置文件格式：</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">一：创建docker.conf文件，内容如下：</span></span><br><span class="line"><span class="meta prompt_">cat&gt;</span><span class="language-bash">docker.conf&lt;&lt;<span class="string">EOF</span></span></span><br><span class="line">&#123;&quot;auths&quot;:</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;registry.cn-shanghai.aliyuncs.com&quot;:</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;auth&quot;:&quot;YWRtaW46MTIzNDU2Cg==&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;registry-vpc.cn-shanghai.aliyuncs.com&quot;:</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;auth&quot;:&quot;YWRtaW46MTIzNDU2Cg==&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;docker-repo-dev.xxx.xxx&quot;:&#123;</span><br><span class="line">            &quot;auth&quot;: &quot;YWRtaW46MTIzNDU2Cg==&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">这里假设访问几个仓库的用户名是admin,密码是：123456，字符串&quot;admin:123456&quot;得到的base64编码就是：YWRtaW46MTIzNDU2Cg==</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">二：对docker.conf文件镜像base64编码，得到base64字符串</span></span></span><br><span class="line">base64 docker.conf</span><br><span class="line">eyJhdXRocyI6CiAgICB7CiAgICAgICAgInJlZ2lzdHJ5LmNuLXNoYW5naGFpLmFsaXl1bmNzLmNv</span><br><span class="line">bSI6CiAgICAgICAgeyAKICAgICAgICAgICAgImF1dGgiOiJZV1J0YVc0Nk1USXpORFUyQ2c9PSIK</span><br><span class="line">ICAgICAgICB9LAogICAgICAgICJyZWdpc3RyeS12cGMuY24tc2hhbmdoYWkuYWxpeXVuY3MuY29t</span><br><span class="line">IjoKICAgICAgICB7CiAgICAgICAgICAgICJhdXRoIjoiWVdSdGFXNDZNVEl6TkRVMkNnPT0iCiAg</span><br><span class="line">ICAgICAgfSwKICAgICAgICAiZG9ja2VyLXJlcG8tZGV2Lnh4eC54eHgiOnsKICAgICAgICAgICAg</span><br><span class="line">ImF1dGgiOiAiWVdSdGFXNDZNVEl6TkRVMkNnPT0iCiAgICAgICAgfQogICAgfQp9Cg==</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">三：创建oss.conf文件，内容如下：</span></span></span><br><span class="line"><span class="meta prompt_">cat&gt;</span><span class="language-bash"><span class="string">oss.conf&lt;&lt;EOF</span></span></span><br><span class="line">[Credentials]</span><br><span class="line">language=CH</span><br><span class="line">accessKeyID=********</span><br><span class="line">accessKeySecret=******</span><br><span class="line">endpoint=oss-cn-shanghai.aliyuncs.com</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">请将星号替换成具体的值</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">四：对oss.conf文件<span class="built_in">base64</span>编码，得到字符串：</span></span><br><span class="line">base64 oss.conf</span><br><span class="line">W0NyZWRlbnRpYWxzXQpsYW5ndWFnZT1DSAphY2Nlc3NLZXlJRD0qKioqKioqKgphY2Nlc3NLZXlTZWNyZXQ9KioqKioqCmVuZHBvaW50PW9zcy1jbi1zaGFuZ2hhaS5hbGl5dW5jcy5jb20K</span><br></pre></td></tr></table></figure>

<h3 id="2-将base64字符串用于创建的对应的config-yaml文件："><a href="#2-将base64字符串用于创建的对应的config-yaml文件：" class="headerlink" title="2.将base64字符串用于创建的对应的config.yaml文件："></a>2.将base64字符串用于创建的对应的config.yaml文件：</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># maven仓库本地共享卷</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mvn-pvc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">4Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs-storage</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># node modules文件夹压缩包存放目录本地共享卷</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-modules-pvc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">4Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs-storage</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># yarn缓存仓库本地共享卷</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">yarn-cache-pvc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">4Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs-storage</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="string">.dockerconfigjson:</span> <span class="string">eyJhdXRocyI6CiAgICB7CiAgICAgICAgInJlZ2lzdHJ5LmNuLXNoYW5naGFpLmFsaXl1bmNzLmNvbSI6CiAgICAgICAgeyAKICAgICAgICAgICAgImF1dGgiOiJZV1J0YVc0Nk1USXpORFUyQ2c9PSIKICAgICAgICB9LAogICAgICAgICJyZWdpc3RyeS12cGMuY24tc2hhbmdoYWkuYWxpeXVuY3MuY29tIjoKICAgICAgICB7CiAgICAgICAgICAgICJhdXRoIjoiWVdSdGFXNDZNVEl6TkRVMkNnPT0iCiAgICAgICAgfSwKICAgICAgICAiZG9ja2VyLXJlcG8tZGV2Lnh4eC54eHgiOnsKICAgICAgICAgICAgImF1dGgiOiAiWVdSdGFXNDZNVEl6TkRVMkNnPT0iCiAgICAgICAgfQogICAgfQp9Cg==</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">docker-secret</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes.io/dockerconfigjson</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="string">.ossutilconfig:</span> <span class="string">W0NyZWRlbnRpYWxzXQpsYW5ndWFnZT1DSAphY2Nlc3NLZXlJRD0qKioqKioqKgphY2Nlc3NLZXlTZWNyZXQ9KioqKioqCmVuZHBvaW50PW9zcy1jbi1zaGFuZ2hhaS5hbGl5dW5jcy5jb20K</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">oss-config-secret</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">docker.config.json:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;auths&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;registry.cn-shanghai.aliyuncs.com&quot;:</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">                &quot;auth&quot;:&quot;YWRtaW46MTIzNDU2Cg==&quot;</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            &quot;registry-vpc.cn-shanghai.aliyuncs.com&quot;:</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">                &quot;auth&quot;:&quot;YWRtaW46MTIzNDU2Cg==&quot;</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            &quot;https://docker-repo-dev.xxx.xxx/v1&quot;:&#123;</span></span><br><span class="line"><span class="string">                &quot;auth&quot;: &quot;YWRtaW46MTIzNDU2Cg==&quot;</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            &quot;docker-repo-dev.xxx.xxx&quot;:&#123;</span></span><br><span class="line"><span class="string">                &quot;auth&quot;: &quot;YWRtaW46MTIzNDU2Cg==&quot;</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            &quot;http://docker-public.nexus:80/v1/&quot;: &#123;</span></span><br><span class="line"><span class="string">                &quot;auth&quot;: &quot;YWRtaW46MTIzNDU2Cg==&quot;</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            &quot;docker-public.nexus:80&quot;: &#123;</span></span><br><span class="line"><span class="string">                &quot;auth&quot;: &quot;YWRtaW46MTIzNDU2Cg==&quot;</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            &quot;http://docker-private.nexus:80/v1/&quot;: &#123;</span></span><br><span class="line"><span class="string">                &quot;auth&quot;: &quot;YWRtaW46MTIzNDU2Cg==&quot;</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            &quot;docker-private.nexus:80&quot;: &#123;</span></span><br><span class="line"><span class="string">                &quot;auth&quot;: &quot;YWRtaW46MTIzNDU2Cg==&quot;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">docker-config-json</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">settings.xml:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="string">    &lt;settings xmlns=&quot;http://maven.apache.org/SETTINGS/1.0.0&quot;</span></span><br><span class="line"><span class="string">              xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line"><span class="string">              xsi:schemaLocation=&quot;http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;localRepository&gt;/root/.m2/repository&lt;/localRepository&gt;</span></span><br><span class="line"><span class="string">        &lt;pluginGroups&gt;</span></span><br><span class="line"><span class="string">        &lt;/pluginGroups&gt;</span></span><br><span class="line"><span class="string">        &lt;proxies&gt;</span></span><br><span class="line"><span class="string">        &lt;/proxies&gt;</span></span><br><span class="line"><span class="string">        &lt;servers&gt;</span></span><br><span class="line"><span class="string">            &lt;server&gt;</span></span><br><span class="line"><span class="string">                &lt;id&gt;nexus-public&lt;/id&gt;</span></span><br><span class="line"><span class="string">                &lt;username&gt;admin&lt;/username&gt;</span></span><br><span class="line"><span class="string">                &lt;password&gt;123456&lt;/password&gt;</span></span><br><span class="line"><span class="string">            &lt;/server&gt;</span></span><br><span class="line"><span class="string">        &lt;/servers&gt;</span></span><br><span class="line"><span class="string">        &lt;mirrors&gt;</span></span><br><span class="line"><span class="string">            &lt;mirror&gt;</span></span><br><span class="line"><span class="string">                &lt;id&gt;nexus-public&lt;/id&gt;</span></span><br><span class="line"><span class="string">                &lt;name&gt;nexus repo&lt;/name&gt;</span></span><br><span class="line"><span class="string">                &lt;url&gt;http://nexus3.nexus/repository/maven-public/&lt;/url&gt;</span></span><br><span class="line"><span class="string">                &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;</span></span><br><span class="line"><span class="string">            &lt;/mirror&gt;</span></span><br><span class="line"><span class="string">        &lt;/mirrors&gt;</span></span><br><span class="line"><span class="string">        &lt;profiles&gt;</span></span><br><span class="line"><span class="string">            &lt;profile&gt;</span></span><br><span class="line"><span class="string">                &lt;id&gt;public&lt;/id&gt;</span></span><br><span class="line"><span class="string">                &lt;repositories&gt;</span></span><br><span class="line"><span class="string">                    &lt;repository&gt;</span></span><br><span class="line"><span class="string">                        &lt;id&gt;nexus-public&lt;/id&gt;</span></span><br><span class="line"><span class="string">                        &lt;name&gt;maven-public&lt;/name&gt;</span></span><br><span class="line"><span class="string">                        &lt;url&gt;http://nexus3.nexus/repository/maven-public&lt;/url&gt;</span></span><br><span class="line"><span class="string">                        &lt;releases&gt;</span></span><br><span class="line"><span class="string">                            &lt;enabled&gt;true&lt;/enabled&gt;</span></span><br><span class="line"><span class="string">                        &lt;/releases&gt;</span></span><br><span class="line"><span class="string">                        &lt;snapshots&gt;</span></span><br><span class="line"><span class="string">                            &lt;enabled&gt;true&lt;/enabled&gt;</span></span><br><span class="line"><span class="string">                        &lt;/snapshots&gt;</span></span><br><span class="line"><span class="string">                    &lt;/repository&gt;</span></span><br><span class="line"><span class="string">                &lt;/repositories&gt;</span></span><br><span class="line"><span class="string">                &lt;pluginRepositories&gt;</span></span><br><span class="line"><span class="string">                    &lt;pluginRepository&gt;</span></span><br><span class="line"><span class="string">                        &lt;id&gt;maven-public&lt;/id&gt;</span></span><br><span class="line"><span class="string">                        &lt;name&gt;maven-public&lt;/name&gt;</span></span><br><span class="line"><span class="string">                        &lt;url&gt;http://nexus3.nexus/repository/maven-public&lt;/url&gt;</span></span><br><span class="line"><span class="string">                    &lt;/pluginRepository&gt;</span></span><br><span class="line"><span class="string">                &lt;/pluginRepositories&gt;</span></span><br><span class="line"><span class="string">            &lt;/profile&gt;</span></span><br><span class="line"><span class="string">        &lt;/profiles&gt;</span></span><br><span class="line"><span class="string">        &lt;activeProfiles&gt;</span></span><br><span class="line"><span class="string">            &lt;activeProfile&gt;public&lt;/activeProfile&gt;</span></span><br><span class="line"><span class="string">        &lt;/activeProfiles&gt;</span></span><br><span class="line"><span class="string">    &lt;/settings&gt;</span></span><br><span class="line"><span class="string"></span><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">maven-setting-xml</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">config:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    apiVersion: v1</span></span><br><span class="line"><span class="string">    clusters:</span></span><br><span class="line"><span class="string">    - cluster:</span></span><br><span class="line"><span class="string">        certificate-authority-data: LS0tL***S0tLQo=</span></span><br><span class="line"><span class="string">        server: https://kubernetes.default</span></span><br><span class="line"><span class="string">      name: kubernetes</span></span><br><span class="line"><span class="string">    contexts:</span></span><br><span class="line"><span class="string">    - context:</span></span><br><span class="line"><span class="string">        cluster: kubernetes</span></span><br><span class="line"><span class="string">        user: kubernetes-admin</span></span><br><span class="line"><span class="string">      name: kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="string">    current-context: kubernetes-admin@kubernetes</span></span><br><span class="line"><span class="string">    kind: Config</span></span><br><span class="line"><span class="string">    preferences: &#123;&#125;</span></span><br><span class="line"><span class="string">    users:</span></span><br><span class="line"><span class="string">    - name: kubernetes-admin</span></span><br><span class="line"><span class="string">      user:</span></span><br><span class="line"><span class="string">        client-certificate-data: LS0tLS1CRUd***LQo=</span></span><br><span class="line"><span class="string">        client-key-data: LS0t***LQo=</span></span><br><span class="line"><span class="string"></span><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">daemon.json:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;debug&quot;: true,</span></span><br><span class="line"><span class="string">        &quot;registry-mirrors&quot;: [&quot;https://docker-repo-dev.xxx.xxx&quot;],</span></span><br><span class="line"><span class="string">        &quot;insecure-registries&quot;: [&quot;docker-public.nexus:80&quot;,&quot;docker-private.nexus:80&quot; ]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">docker-daemon-json</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">jenkins</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-执行命令："><a href="#3-执行命令：" class="headerlink" title="3.执行命令："></a>3.执行命令：</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl  apply -f  config.yaml -n jenkins</span><br></pre></td></tr></table></figure>

<h2 id="配置jenkins命名空间的免密拉取镜像，用于jenkins-slave-pod执行时拉取私有镜像仓库的镜像"><a href="#配置jenkins命名空间的免密拉取镜像，用于jenkins-slave-pod执行时拉取私有镜像仓库的镜像" class="headerlink" title="配置jenkins命名空间的免密拉取镜像，用于jenkins slave pod执行时拉取私有镜像仓库的镜像"></a>配置jenkins命名空间的免密拉取镜像，用于jenkins slave pod执行时拉取私有镜像仓库的镜像</h2><p><a target="_blank" rel="noopener" href="https://thoughts.aliyun.com/workspaces/5f37778f55b90500238b43cb/docs/63bf6504e87e050001aeb61d"><strong>kubernetes免密拉取镜像</strong></a></p>
<h2 id="创建jenkins-pipeline"><a href="#创建jenkins-pipeline" class="headerlink" title="创建jenkins pipeline"></a>创建jenkins pipeline</h2><p>“dashboard”-&gt;”新建任务”</p>
<p><img src="/CICD-Practice/2023/02/05/%E5%9F%BA%E4%BA%8Ejenkins+kubernetes%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%90%AD%E5%BB%BA/D29A06996e112qbd113d3aec61e80882be36e6fd0895b7"></p>
<p><img src="/CICD-Practice/2023/02/05/%E5%9F%BA%E4%BA%8Ejenkins+kubernetes%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%90%AD%E5%BB%BA/87447Bc7FC112q4a3834a7f0053aec387e12610c45d241"></p>
<p><img src="/CICD-Practice/2023/02/05/%E5%9F%BA%E4%BA%8Ejenkins+kubernetes%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%90%AD%E5%BB%BA/6F29dbb0bE112qa37fbd7c60ef90805900b0172ac7b1d3"></p>
<p><img src="/CICD-Practice/2023/02/05/%E5%9F%BA%E4%BA%8Ejenkins+kubernetes%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%90%AD%E5%BB%BA/3FcC77F7cD112qd9df49d49996225b8f9008295552f4d5"></p>
<p><img src="/CICD-Practice/2023/02/05/%E5%9F%BA%E4%BA%8Ejenkins+kubernetes%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%90%AD%E5%BB%BA/c41F7035d5112qc69d9b5533a4ed13794a641793ae1f22"></p>
<p><img src="/CICD-Practice/2023/02/05/%E5%9F%BA%E4%BA%8Ejenkins+kubernetes%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%90%AD%E5%BB%BA/FBCF0EE0E2112qc7a349bb8f5a4e477c2a93ba7cbef679"></p>
<p><img src="/CICD-Practice/2023/02/05/%E5%9F%BA%E4%BA%8Ejenkins+kubernetes%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%90%AD%E5%BB%BA/AAC6B6bD97112q1ff6a7a9a29b3e05a327a3f5158d807a"></p>
<p><img src="/CICD-Practice/2023/02/05/%E5%9F%BA%E4%BA%8Ejenkins+kubernetes%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%90%AD%E5%BB%BA/8b9dca057e112q94b10ad383515359caa9a6f257c78c5f"></p>
<p><img src="/CICD-Practice/2023/02/05/%E5%9F%BA%E4%BA%8Ejenkins+kubernetes%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%90%AD%E5%BB%BA/9dBB9fF7e2112q14416b33e782336650206502874b9ff2"></p>
<p><img src="/CICD-Practice/2023/02/05/%E5%9F%BA%E4%BA%8Ejenkins+kubernetes%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%90%AD%E5%BB%BA/B805c09eE2112q6bbd2bec1266a7b138bdbe5925848296"></p>
<p><img src="/CICD-Practice/2023/02/05/%E5%9F%BA%E4%BA%8Ejenkins+kubernetes%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%90%AD%E5%BB%BA/66Fb00D02d112qe8591af606b90c6a1b299e2176a1f389"></p>
<blockquote>
<p>新建一个名称为pbm-server的流水线任务</p>
</blockquote>
<blockquote>
<p>1.定义了两个手动构建参数，</p>
</blockquote>
<blockquote>
<p>2.定义了两个环境变量，从webhook通知的请求体中提取两个参数，赋值给对应的环境变量</p>
</blockquote>
<blockquote>
<p>3.配置webhook请求授权token</p>
</blockquote>
<blockquote>
<p>4.配置过滤需要监听的分支</p>
</blockquote>
<blockquote>
<p>5.配置源码仓库</p>
</blockquote>
<blockquote>
<p>6.配置构建时加载的源码分支</p>
</blockquote>
<h2 id="前端项目jenkinsfile"><a href="#前端项目jenkinsfile" class="headerlink" title="前端项目jenkinsfile"></a>前端项目jenkinsfile</h2><p>Dockerfile示例：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> nginx:<span class="number">1.23</span>.<span class="number">3</span>-alpine-slim</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> dist /usr/share/nginx/html</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>在项目根目录创建Jenkinsfile文件，内容如下：</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env groovy</span></span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat</span><br><span class="line"></span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent &#123;</span><br><span class="line">        kubernetes &#123;</span><br><span class="line">            yamlFile <span class="string">&#x27;KubernetesPod.yaml&#x27;</span></span><br><span class="line">            workspaceVolume emptyDirWorkspaceVolume(<span class="string">&quot;memory&quot;</span>: <span class="literal">true</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    environment &#123;</span><br><span class="line">        DEPLOY_FOLDER_NAME=<span class="string">&#x27;mp4agency-ui&#x27;</span></span><br><span class="line">        ACCESS_ADDR=<span class="string">&quot;http://192.168.1.33:8080/dev/$&#123;DEPLOY_FOLDER_NAME&#125;/index.html&quot;</span></span><br><span class="line">        OSS_bucket_4_test=<span class="string">&quot;kycic-site-test&quot;</span></span><br><span class="line">        OSS_bucket_4_prod=<span class="string">&quot;kycic-site&quot;</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;npm install&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                script &#123;</span><br><span class="line">                    env.PACKAGE_MD5 = sh (<span class="attr">script:</span> <span class="string">&quot;md5sum -t package.json |awk &#x27;&#123;print \$1&#125;&#x27;&quot;</span>, <span class="attr">returnStdout:</span> <span class="literal">true</span>).trim()</span><br><span class="line">                &#125;</span><br><span class="line">                container(<span class="string">&#x27;node&#x27;</span>) &#123;</span><br><span class="line">                    sh <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                        if [ ! -f &quot;/root/node-modules-zip/$&#123;DEPLOY_FOLDER_NAME&#125;-$&#123;PACKAGE_MD5&#125;.tar.gz&quot; ]; then</span></span><br><span class="line"><span class="string">                            echo &#x27;yarn install&#x27;</span></span><br><span class="line"><span class="string">                            yarn config list</span></span><br><span class="line"><span class="string">                            #删除代理</span></span><br><span class="line"><span class="string">                            yarn config delete proxy</span></span><br><span class="line"><span class="string">                            #更换淘宝镜像</span></span><br><span class="line"><span class="string">                            yarn config set registry https://registry.npm.taobao.org</span></span><br><span class="line"><span class="string">                            yarn install</span></span><br><span class="line"><span class="string">                            tar -zcf /root/node-modules-zip/$&#123;DEPLOY_FOLDER_NAME&#125;-$&#123;PACKAGE_MD5&#125;.tar.gz node_modules</span></span><br><span class="line"><span class="string">                            md5sum -t package.json&gt;/root/node-modules-zip/$&#123;DEPLOY_FOLDER_NAME&#125;.md5sum</span></span><br><span class="line"><span class="string">                        else</span></span><br><span class="line"><span class="string">                            echo &#x27;uzip node_modules&#x27;</span></span><br><span class="line"><span class="string">                            tar -zxf /root/node-modules-zip/$&#123;DEPLOY_FOLDER_NAME&#125;-$&#123;PACKAGE_MD5&#125;.tar.gz</span></span><br><span class="line"><span class="string">                        fi</span></span><br><span class="line"><span class="string">                    &#x27;&#x27;&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;deploy-dev&#x27;</span>) &#123;</span><br><span class="line">            when &#123;</span><br><span class="line">                anyOf &#123;</span><br><span class="line">                    environment <span class="attr">name:</span> <span class="string">&#x27;gitlabTargetBranch&#x27;</span>, <span class="attr">value:</span> <span class="string">&#x27;heads/dev&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line">                container(<span class="string">&#x27;node&#x27;</span>) &#123;</span><br><span class="line">                    sh <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                      rm -rf dist &amp;&amp; \</span></span><br><span class="line"><span class="string">                       npm run build:dev</span></span><br><span class="line"><span class="string">                    &#x27;&#x27;&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">                container(<span class="string">&#x27;aliyun-tools&#x27;</span>) &#123;</span><br><span class="line">                    sh <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                      ossutil64 rm -f -r oss://$&#123;OSS_bucket_4_test&#125;/dev/$&#123;DEPLOY_FOLDER_NAME&#125;/ --config-file=/root/.ossutilconfig &amp;&amp; \</span></span><br><span class="line"><span class="string">                      ossutil64 cp -r dist/ oss://$&#123;OSS_bucket_4_test&#125;/dev/$&#123;DEPLOY_FOLDER_NAME&#125; --config-file=/root/.ossutilconfig</span></span><br><span class="line"><span class="string">                    &#x27;&#x27;&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">                script &#123;</span><br><span class="line">                    ACCESS_ADDR = <span class="string">&quot;http://192.168.1.33/dev/$&#123;DEPLOY_FOLDER_NAME&#125;/index.html&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;deploy-test&#x27;</span>) &#123;</span><br><span class="line">            when &#123;</span><br><span class="line">                anyOf &#123;</span><br><span class="line">                    environment <span class="attr">name:</span> <span class="string">&#x27;gitlabTargetBranch&#x27;</span>, <span class="attr">value:</span> <span class="string">&#x27;heads/master&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            steps &#123;</span><br><span class="line">                container(<span class="string">&#x27;node&#x27;</span>) &#123;</span><br><span class="line">                    sh <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                      rm -rf dist &amp;&amp; \</span></span><br><span class="line"><span class="string">                      npm run build:test</span></span><br><span class="line"><span class="string">                    &#x27;&#x27;&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">                container(<span class="string">&#x27;aliyun-tools&#x27;</span>) &#123;</span><br><span class="line">                    sh <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                      ossutil64 rm -f -r oss://$&#123;OSS_bucket_4_test&#125;/test/$&#123;DEPLOY_FOLDER_NAME&#125;/ --config-file=/root/.ossutilconfig &amp;&amp; \</span></span><br><span class="line"><span class="string">                      ossutil64 cp -r dist/ oss://$&#123;OSS_bucket_4_test&#125;/test/$&#123;DEPLOY_FOLDER_NAME&#125; --config-file=/root/.ossutilconfig</span></span><br><span class="line"><span class="string">                    &#x27;&#x27;&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">                script &#123;</span><br><span class="line">                    ACCESS_ADDR = <span class="string">&quot;http://192.168.1.33/test/$&#123;DEPLOY_FOLDER_NAME&#125;/index.html&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;deploy-staging&#x27;</span>) &#123;</span><br><span class="line">                    when &#123;</span><br><span class="line">                        allOf &#123;</span><br><span class="line">                            environment <span class="attr">ignoreCase:</span> <span class="literal">true</span>, <span class="attr">name:</span> <span class="string">&#x27;gitlabActionType&#x27;</span>, <span class="attr">value:</span> <span class="string">&#x27;TAG_PUSH&#x27;</span></span><br><span class="line">                            expression &#123; <span class="keyword">return</span> env.gitlabTargetBranch ==~ <span class="regexp">/tags\/</span>staging-.*/ &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    steps &#123;</span><br><span class="line">                        container(<span class="string">&#x27;node&#x27;</span>) &#123;</span><br><span class="line">                            sh <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                              rm -rf dist &amp;&amp; \</span></span><br><span class="line"><span class="string">                              npm run build:staging</span></span><br><span class="line"><span class="string">                            &#x27;&#x27;&#x27;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        container(<span class="string">&#x27;aliyun-tools&#x27;</span>) &#123;</span><br><span class="line">                            sh <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                              ossutil64 rm -f -r oss://$&#123;OSS_bucket_4_test&#125;/staging/$&#123;DEPLOY_FOLDER_NAME&#125;/ --config-file=/root/.ossutilconfig &amp;&amp; \</span></span><br><span class="line"><span class="string">                              ossutil64 cp -r dist/ oss://$&#123;OSS_bucket_4_test&#125;/staging/$&#123;DEPLOY_FOLDER_NAME&#125; --config-file=/root/.ossutilconfig</span></span><br><span class="line"><span class="string">                            &#x27;&#x27;&#x27;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        script &#123;</span><br><span class="line">                            ACCESS_ADDR = <span class="string">&quot;http://192.168.1.33/staging/$&#123;DEPLOY_FOLDER_NAME&#125;/index.html&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;deploy-prod&#x27;</span>) &#123;</span><br><span class="line">            when &#123;</span><br><span class="line">                allOf &#123;</span><br><span class="line">                    environment <span class="attr">ignoreCase:</span> <span class="literal">true</span>, <span class="attr">name:</span> <span class="string">&#x27;gitlabActionType&#x27;</span>, <span class="attr">value:</span> <span class="string">&#x27;TAG_PUSH&#x27;</span></span><br><span class="line">                    expression &#123; <span class="keyword">return</span> env.gitlabTargetBranch ==~ <span class="regexp">/tags\/</span>release-.*/ &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line">                container(<span class="string">&#x27;node&#x27;</span>) &#123;</span><br><span class="line">                    sh <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                      rm -rf dist &amp;&amp; \</span></span><br><span class="line"><span class="string">                      npm run build</span></span><br><span class="line"><span class="string">                    &#x27;&#x27;&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">                container(<span class="string">&#x27;aliyun-tools&#x27;</span>) &#123;</span><br><span class="line">                    sh <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                      echo &#x27;备份目录：/prod/temp/$&#123;DEPLOY_FOLDER_NAME&#125;-&#x27;`date +%Y%m%d%H%M` --config-file=/root/.ossutilconfig&amp;&amp; \</span></span><br><span class="line"><span class="string">                      ossutil64 cp -r oss://kyhk-site/prod/$&#123;DEPLOY_FOLDER_NAME&#125; oss://kyhk-site/prod/temp/$&#123;DEPLOY_FOLDER_NAME&#125;-`date +%Y%m%d%H%M`/ --config-file=/root/.ossutilconfig&amp;&amp; \</span></span><br><span class="line"><span class="string">                      ossutil64 rm -f -r oss://$&#123;OSS_bucket_4_prod&#125;/prod/$&#123;DEPLOY_FOLDER_NAME&#125;/ --config-file=/root/.ossutilconfig&amp;&amp; \</span></span><br><span class="line"><span class="string">                      ossutil64 cp -r dist/ oss://$&#123;OSS_bucket_4_prod&#125;/prod/$&#123;DEPLOY_FOLDER_NAME&#125; --config-file=/root/.ossutilconfig</span></span><br><span class="line"><span class="string">                    &#x27;&#x27;&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">                script &#123;</span><br><span class="line">                    ACCESS_ADDR = <span class="string">&quot;http://192.168.1.33/prod/$&#123;DEPLOY_FOLDER_NAME&#125;/index.html&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    post &#123;</span><br><span class="line">        success &#123;</span><br><span class="line">            echo <span class="string">&#x27;do somethings after success&#x27;</span></span><br><span class="line">            dingtalk (</span><br><span class="line">                    <span class="symbol">robot:</span> <span class="string">&#x27;3fff9e6a&#x27;</span>,</span><br><span class="line">                    <span class="symbol">type:</span> <span class="string">&#x27;ACTION_CARD&#x27;</span>,</span><br><span class="line">                    <span class="symbol">text:</span> [</span><br><span class="line">                            <span class="string">&quot;# $JOB_NAME 构建成功&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;# 页面链接：$ACCESS_ADDR&quot;</span>,</span><br><span class="line">                            getChangeString()</span><br><span class="line">                    ],</span><br><span class="line">                    <span class="symbol">btns:</span> [</span><br><span class="line">                            [</span><br><span class="line">                                    <span class="symbol">title:</span> <span class="string">&#x27;查看详情&#x27;</span>,</span><br><span class="line">                                    <span class="symbol">actionUrl:</span> blueOceanUrl()</span><br><span class="line">                            ],</span><br><span class="line">                            [</span><br><span class="line">                                    <span class="symbol">title:</span> <span class="string">&#x27;访问地址&#x27;</span>,</span><br><span class="line">                                    <span class="symbol">actionUrl:</span> <span class="string">&quot;$ACCESS_ADDR&quot;</span></span><br><span class="line">                            ]</span><br><span class="line">                    ],</span><br><span class="line">                    <span class="symbol">btnLayout:</span> <span class="string">&#x27;V&#x27;</span>,</span><br><span class="line">                    <span class="symbol">at:</span> [<span class="string">&quot;$&#123;env.gitlabUserName&#125;&quot;</span>,]</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">        failure &#123;</span><br><span class="line">            echo <span class="string">&#x27;do somethings after failure&#x27;</span></span><br><span class="line">            dingtalk (</span><br><span class="line">                    <span class="symbol">robot:</span> <span class="string">&#x27;3fff9e6a&#x27;</span>,</span><br><span class="line">                    <span class="symbol">type:</span> <span class="string">&#x27;ACTION_CARD&#x27;</span>,</span><br><span class="line">                    <span class="symbol">text:</span> [</span><br><span class="line">                            <span class="string">&quot;# $JOB_NAME 构建失败&quot;</span>,</span><br><span class="line">                            getChangeString()</span><br><span class="line">                    ],</span><br><span class="line">                    <span class="symbol">btns:</span> [</span><br><span class="line">                            [</span><br><span class="line">                                    <span class="symbol">title:</span> <span class="string">&#x27;查看详情&#x27;</span>,</span><br><span class="line">                                    <span class="symbol">actionUrl:</span> blueOceanUrl()</span><br><span class="line">                            ],</span><br><span class="line">                            [</span><br><span class="line">                                    <span class="symbol">title:</span> <span class="string">&#x27;访问地址&#x27;</span>,</span><br><span class="line">                                    <span class="symbol">actionUrl:</span> <span class="string">&quot;$ACCESS_ADDR&quot;</span></span><br><span class="line">                            ]</span><br><span class="line">                    ],</span><br><span class="line">                    <span class="symbol">btnLayout:</span> <span class="string">&#x27;V&#x27;</span>,</span><br><span class="line">                    <span class="symbol">at:</span> [<span class="string">&quot;$&#123;env.gitlabUserName&#125;&quot;</span>,]</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">        always &#123;</span><br><span class="line">            echo <span class="string">&#x27;do somethings always&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@NonCPS</span></span><br><span class="line"><span class="keyword">def</span> getChangeString() &#123;</span><br><span class="line">    <span class="keyword">def</span> MAX_MSG_LEN = <span class="number">100</span></span><br><span class="line">    <span class="keyword">def</span> changeString = <span class="string">&quot;&quot;</span></span><br><span class="line">    echo <span class="string">&quot;Gathering SCM changes&quot;</span></span><br><span class="line">    <span class="keyword">def</span> duration = currentBuild.duration</span><br><span class="line">    <span class="keyword">def</span> changeLogSets = currentBuild.changeSets</span><br><span class="line">    changeString+=<span class="string">&quot; --- \n - 持续时间： $&#123;duration/1000&#125; s\n&quot;</span></span><br><span class="line">    SimpleDateFormat f = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; changeLogSets.size(); i++) &#123;</span><br><span class="line">        <span class="keyword">def</span> entries = changeLogSets[i].items</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; entries.length; j++) &#123;</span><br><span class="line">            <span class="keyword">def</span> entry = entries[j]</span><br><span class="line">            <span class="keyword">def</span> truncated_msg = entry.msg.take(MAX_MSG_LEN)</span><br><span class="line">            changeString += <span class="string">&quot; - 提交内容：$&#123;truncated_msg&#125;  \n - 提交人：$&#123;entry.author.displayName&#125;\n&quot;</span></span><br><span class="line">            <span class="keyword">def</span> date=<span class="keyword">new</span> Date(entry.timestamp)</span><br><span class="line">            <span class="keyword">def</span> timeFormat=f.format(date)</span><br><span class="line">            changeString+=<span class="string">&quot; - 时间：$&#123;timeFormat&#125;\n&quot;</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> z = <span class="number">0</span>; z &lt; entry.affectedFiles.size(); z++) &#123;</span><br><span class="line">                <span class="keyword">def</span> affectedFile=entry.affectedFiles[z]</span><br><span class="line">                changeString+=<span class="string">&quot; - 文件：$&#123;affectedFile.path&#125; \n - 操作：$&#123;affectedFile.editType.name&#125;\n&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            changeString+=<span class="string">&quot;---\n&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!changeString) &#123;</span><br><span class="line">        changeString = <span class="string">&quot; - No new changes&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> changeString</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> blueOceanUrl()&#123;</span><br><span class="line">    <span class="keyword">def</span> jobName=URLEncoder.encode(<span class="string">&quot;$JOB_NAME&quot;</span>, <span class="string">&quot;UTF-8&quot;</span>)</span><br><span class="line">    <span class="keyword">def</span> url=<span class="string">&quot;http://192.168.1.33:8080/blue/organizations/jenkins/$&#123;jobName&#125;/detail/$JOB_BASE_NAME/$BUILD_NUMBER/pipeline&quot;</span></span><br><span class="line">    <span class="keyword">return</span> url</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在项目根目录下创建KubernetesPod.yaml，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mp4agency-ui</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">mp4agency-ui</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">node</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">node:14</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line">      <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">yarn-cache-repo</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/root/.cache/yarn</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/root/node-modules-zip/</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">node-modules-pvc</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">aliyun-tools</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nathanhuang/aliyun-tools:0.0.1</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line">      <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">oss-config</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/root/.ossutilconfig</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">.ossutilconfig</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">yarn-cache-repo</span></span><br><span class="line">      <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">        <span class="attr">claimName:</span> <span class="string">yarn-cache-pvc</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">oss-config</span></span><br><span class="line">      <span class="attr">secret:</span></span><br><span class="line">        <span class="attr">secretName:</span> <span class="string">oss-config-secret</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">node-modules-pvc</span></span><br><span class="line">      <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">        <span class="attr">claimName:</span> <span class="string">node-modules-pvc</span></span><br></pre></td></tr></table></figure>


<h3 id="优化点："><a href="#优化点：" class="headerlink" title="优化点："></a>优化点：</h3><p>一、workspaceVolume emptyDirWorkspaceVolume(“memory”: true)可以让整个构建过程产生的文件在内存中进行。没有磁盘io，减轻服务器物理磁盘的压力。</p>
<p>二、对前端项目的package.json进行md5计算，判断该文件是否修改过，如果修改过则从新执行yarn install过程。将安装后的node_modelus文件夹进行压缩保存，保存的文件名称带上此次package.json计算出来的MD5值，名称格式如下：&#x2F;root&#x2F;node-modules-zip&#x2F;${DEPLOY_FOLDER_NAME}-${PACKAGE_MD5}.tar.gz。下次再次构建此项目时，如果package.json文件没有变动过，则直接解压该文件，无需执行耗时的yarn install 过程。</p>
<p>三、使用yarn install 替代npm install 让多个项目依赖同一个组件时可以复用缓存，加快前端安装过程。</p>
<p>四、使用淘宝仓库镜像替代npm官方的仓库地址，提高前端项目第一次初始化的安装过程</p>
<p>五、使用阿里云oss作为静态网页的托管网站服务器，简化自建静态资源服务器的复杂度</p>
<h2 id="后端项目jenkinsfile"><a href="#后端项目jenkinsfile" class="headerlink" title="后端项目jenkinsfile"></a>后端项目jenkinsfile</h2><p>Dockerfile示例:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>u322-jdk-oraclelinux8 as openjdk-<span class="number">8</span>u212-jre-alpine-base</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /opt</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> target/*.jar /opt/app.jar</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> java -Djarmode=layertools -jar app.jar extract</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>u322-jdk-oraclelinux8</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cp</span> /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp; <span class="built_in">echo</span> <span class="string">&#x27;Asia/Shanghai&#x27;</span> &gt; /etc/timezone</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /opt</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=openjdk-8u212-jre-alpine-base opt/dependencies ./</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=openjdk-8u212-jre-alpine-base opt/spring-boot-loader ./</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=openjdk-8u212-jre-alpine-base opt/snapshot-dependencies ./</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=openjdk-8u212-jre-alpine-base opt/application ./</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [ <span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;java <span class="variable">$JAVA_OPTIONS</span> org.springframework.boot.loader.JarLauncher <span class="variable">$SPRING_OPTIONS</span>&quot;</span> ]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在项目根目录创建Jenkinsfile文件，内容如下：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env groovy</span></span><br><span class="line"></span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent &#123;</span><br><span class="line">        kubernetes &#123;</span><br><span class="line">            yamlFile <span class="string">&#x27;KubernetesPod.yaml&#x27;</span></span><br><span class="line">            workspaceVolume emptyDirWorkspaceVolume(<span class="string">&quot;memory&quot;</span>: <span class="literal">true</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    environment &#123;</span><br><span class="line"></span><br><span class="line">        WORK_DIR = <span class="string">&quot;.&quot;</span></span><br><span class="line">        SVC_NAME = <span class="string">&quot;sensitive-words&quot;</span></span><br><span class="line">        DEV_DEPLOY_DIR = <span class="string">&quot;kustomize/overlays/dev/$&#123;SVC_NAME&#125;&quot;</span></span><br><span class="line">        TEST_DEPLOY_DIR = <span class="string">&quot;kustomize/overlays/dev/$&#123;SVC_NAME&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">        IMAGE_NAME = <span class="string">&quot;sensitive-words&quot;</span></span><br><span class="line">        DEPLOYMENT_NAME = <span class="string">&quot;sensitive-words&quot;</span></span><br><span class="line">        DOCKER_REG = <span class="string">&quot;docker-private.nexus:80&quot;</span></span><br><span class="line">        <span class="comment">//docker镜像完整路径名</span></span><br><span class="line">        IMG_FULL_NAME = <span class="string">&quot;$&#123;DOCKER_REG&#125;/app/$&#123;IMAGE_NAME&#125;&quot;</span></span><br><span class="line">		<span class="comment">//一般有一个内网镜像地址，和公网可访问的镜像地址，一般使用公网作为默认镜像地址，</span></span><br><span class="line">        SOURCE_IMG_NAME = <span class="string">&quot;public.xxx.xxx/app/$&#123;IMAGE_NAME&#125;&quot;</span></span><br><span class="line">        <span class="comment">//发布正式环境时，一般使用内网镜像地址可以加快镜像拉取速度，</span></span><br><span class="line">        TAG_IMG_NAME = <span class="string">&quot;private.xxx.xxx/app/$&#123;IMAGE_NAME&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;init build evn&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                script &#123;</span><br><span class="line">                    env.imageTag = sh(<span class="attr">script:</span> <span class="string">&#x27;git rev-parse --short HEAD&#x27;</span>, <span class="attr">returnStdout:</span> <span class="literal">true</span>).trim()</span><br><span class="line">                    env.gitCommitId = sh(<span class="attr">script:</span> <span class="string">&#x27;git rev-parse HEAD&#x27;</span>, <span class="attr">returnStdout:</span> <span class="literal">true</span>).trim()</span><br><span class="line">                &#125;</span><br><span class="line">                container(<span class="string">&#x27;docker&#x27;</span>) &#123;</span><br><span class="line">                    sh <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                        mkdir ~/.docker</span></span><br><span class="line"><span class="string">                        cp /etc/docker/docker.config.json ~/.docker/config.json</span></span><br><span class="line"><span class="string">                        docker login $&#123;DOCKER_REG&#125;</span></span><br><span class="line"><span class="string">                       &#x27;&#x27;&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;build sensitive-words&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                container(<span class="string">&#x27;maven&#x27;</span>) &#123;</span><br><span class="line">                    sh <span class="string">&#x27;mvn package&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">                container(<span class="string">&#x27;docker&#x27;</span>) &#123;</span><br><span class="line">                    sh <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                        echo &quot;imageTag:&quot;$&#123;imageTag&#125;&quot;;gitCommitId:&quot;$&#123;gitCommitId&#125;</span></span><br><span class="line"><span class="string">                        cd $&#123;WORK_DIR&#125;</span></span><br><span class="line"><span class="string">                        docker build --cache-from=$&#123;IMG_FULL_NAME&#125;:latest -t $&#123;IMG_FULL_NAME&#125;:latest .</span></span><br><span class="line"><span class="string">                        docker push $&#123;IMG_FULL_NAME&#125;:latest</span></span><br><span class="line"><span class="string">                       &#x27;&#x27;&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;deploy-dev&#x27;</span>) &#123;</span><br><span class="line">            when &#123;</span><br><span class="line">                anyOf &#123;</span><br><span class="line">                    environment <span class="attr">name:</span> <span class="string">&#x27;gitlabTargetBranch&#x27;</span>, <span class="attr">value:</span> <span class="string">&#x27;heads/dev&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line">                container(<span class="string">&#x27;kubetools&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    sh <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                         cd $&#123;DEV_DEPLOY_DIR&#125;</span></span><br><span class="line"><span class="string">                         kustomize edit add annotation git-version:$&#123;gitCommitId&#125;</span></span><br><span class="line"><span class="string">                         kustomize build .</span></span><br><span class="line"><span class="string">                         kustomize build . | kubectl apply -n dev-sensitive-words -f-</span></span><br><span class="line"><span class="string">                         kubectl rollout status deployment $&#123;DEPLOYMENT_NAME&#125; -n dev-sensitive-words</span></span><br><span class="line"><span class="string">                       &#x27;&#x27;&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;deploy-test&#x27;</span>) &#123;</span><br><span class="line">            when &#123;</span><br><span class="line">                anyOf &#123;</span><br><span class="line">                    environment <span class="attr">name:</span> <span class="string">&#x27;gitlabTargetBranch&#x27;</span>, <span class="attr">value:</span> <span class="string">&#x27;heads/master&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line"></span><br><span class="line">                container(<span class="string">&#x27;docker&#x27;</span>) &#123;</span><br><span class="line">                    sh <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                        docker tag $&#123;IMG_FULL_NAME&#125;:latest $&#123;IMG_FULL_NAME&#125;:$&#123;imageTag&#125;-test</span></span><br><span class="line"><span class="string">                        docker push $&#123;IMG_FULL_NAME&#125;:$&#123;imageTag&#125;-test</span></span><br><span class="line"><span class="string">                       &#x27;&#x27;&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">                container(<span class="string">&#x27;kubetools&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    sh <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                         cd $&#123;TEST_DEPLOY_DIR&#125;</span></span><br><span class="line"><span class="string">                         kustomize edit set image $&#123;SOURCE_IMG_NAME&#125;=$&#123;TAG_IMG_NAME&#125;:$&#123;imageTag&#125;-test</span></span><br><span class="line"><span class="string">                         kustomize build .</span></span><br><span class="line"><span class="string">                         kustomize build . | kubectl apply -n test-sensitive-words -f-</span></span><br><span class="line"><span class="string">                         kubectl rollout status deployment $&#123;DEPLOYMENT_NAME&#125; -n test-sensitive-words --timeout=300s</span></span><br><span class="line"><span class="string">                       &#x27;&#x27;&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;deploy-prod&#x27;</span>) &#123;</span><br><span class="line">            when &#123;</span><br><span class="line">                allOf &#123;</span><br><span class="line">                    environment <span class="attr">ignoreCase:</span> <span class="literal">true</span>, <span class="attr">name:</span> <span class="string">&#x27;gitlabActionType&#x27;</span>, <span class="attr">value:</span> <span class="string">&#x27;TAG_PUSH&#x27;</span></span><br><span class="line">                    expression &#123; <span class="keyword">return</span> env.gitlabTargetBranch ==~ <span class="regexp">/tags\/</span>release-.*/ &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line">                container(<span class="string">&#x27;docker&#x27;</span>) &#123;</span><br><span class="line">                    sh <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                        docker pull $&#123;IMG_FULL_NAME&#125;:$&#123;imageTag&#125;</span></span><br><span class="line"><span class="string">                        docker tag $&#123;IMG_FULL_NAME&#125;:$&#123;imageTag&#125; $&#123;IMG_FULL_NAME_ALIYUN&#125;:$&#123;imageTag&#125;</span></span><br><span class="line"><span class="string">                        docker login $&#123;DOCKER_REG_ALIYUN&#125;</span></span><br><span class="line"><span class="string">                        docker push $&#123;IMG_FULL_NAME_ALIYUN&#125;:$&#123;imageTag&#125;</span></span><br><span class="line"><span class="string">                       &#x27;&#x27;&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">                container(<span class="string">&#x27;kubetools&#x27;</span>) &#123;</span><br><span class="line">                    sh <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                         cd $&#123;PROD_DEPLOY_DIR&#125;</span></span><br><span class="line"><span class="string">                         kustomize edit set image $&#123;IMG_FULL_NAME_ALIYUN&#125;=$&#123;IMG_FULL_NAME_ALIYUN&#125;:$&#123;imageTag&#125;</span></span><br><span class="line"><span class="string">                         kustomize build . &gt;target.yaml</span></span><br><span class="line"><span class="string">                       &#x27;&#x27;&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">                container(<span class="string">&#x27;huawei-tools&#x27;</span>) &#123;</span><br><span class="line">                    sh <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                         cd $&#123;PROD_DEPLOY_DIR&#125;</span></span><br><span class="line"><span class="string">                         cat target.yaml</span></span><br><span class="line"><span class="string">                         kubectl apply -n nfkyows -f target.yaml</span></span><br><span class="line"><span class="string">                         kubectl rollout status deployment keyu-ows -n nfkyows</span></span><br><span class="line"><span class="string">                       &#x27;&#x27;&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">                script &#123;</span><br><span class="line">                    ACCESS_ADDR=<span class="string">&quot;https://nfkyows-admin-ui.haokangbao.cn&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    post &#123;</span><br><span class="line">        success &#123;</span><br><span class="line">            echo <span class="string">&#x27;do somethings after success&#x27;</span></span><br><span class="line">            dingtalk(</span><br><span class="line">                    <span class="symbol">robot:</span> <span class="string">&#x27;3fff9e6a-devops&#x27;</span>,</span><br><span class="line">                    <span class="symbol">type:</span> <span class="string">&#x27;TEXT&#x27;</span>,</span><br><span class="line">                    <span class="symbol">title:</span> <span class="string">&#x27;build success&#x27;</span>,</span><br><span class="line">                    <span class="symbol">text:</span> [<span class="string">&quot;$SVC_NAME build success&quot;</span>],</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">        failure &#123;</span><br><span class="line">            echo <span class="string">&#x27;do somethings after failure&#x27;</span></span><br><span class="line">            dingtalk(</span><br><span class="line">                    <span class="symbol">robot:</span> <span class="string">&#x27;3fff9e6a-devops&#x27;</span>,</span><br><span class="line">                    <span class="symbol">type:</span> <span class="string">&#x27;TEXT&#x27;</span>,</span><br><span class="line">                    <span class="symbol">title:</span> <span class="string">&#x27;build success&#x27;</span>,</span><br><span class="line">                    <span class="symbol">text:</span> [<span class="string">&quot;$SVC_NAME build success&quot;</span>],</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">        always &#123;</span><br><span class="line">            echo <span class="string">&#x27;do somethings always&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在项目根目录下创建KubernetesPod.yaml，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">sensitive-words-ci</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">maven</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">maven:alpine</span></span><br><span class="line">      <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line">      <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">maven-repo</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/root/.m2/repository</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">repository</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">maven-setting-xml</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/root/.m2/settings.xml</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">settings.xml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">newman</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">postman/newman:5-alpine</span></span><br><span class="line">      <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line">      <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubetools</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nathanhuang/kubetools:0.0.1-alpine</span></span><br><span class="line">      <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line">      <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kube-config</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/root/.kube/config</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">config</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">docker</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">docker:18.09.7-dind</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/docker/daemon.json</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">docker-daemon-json</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">daemon.json</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/docker/docker.config.json</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">docker-config-json</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">docker.config.json</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">maven-repo</span></span><br><span class="line">      <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">        <span class="attr">claimName:</span> <span class="string">mvn-pvc</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">maven-setting-xml</span></span><br><span class="line">      <span class="attr">configMap:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">maven-setting-xml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">docker-daemon-json</span></span><br><span class="line">      <span class="attr">configMap:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">docker-daemon-json</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">docker-config-json</span></span><br><span class="line">      <span class="attr">configMap:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">docker-config-json</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kube-config</span></span><br><span class="line">      <span class="attr">configMap:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">kube-config</span></span><br></pre></td></tr></table></figure>

<h3 id="优化点：-1"><a href="#优化点：-1" class="headerlink" title="优化点："></a>优化点：</h3><p>一、使用nexus私有仓库代理maven中央仓库，加快项目构建速度</p>
<p>二、使用linux 的tmpfs内存文件系统，使得项目构建过程产生的文件在内存中操作，加快构建速度和减少服务器磁盘压力</p>
<p>三、使用docker in docker 技术，实现每次构建都是原始的、全新的、完整的构建环境</p>
<p><strong>完</strong></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://nathanhex.github.io/CICD-Practice">老黄</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://nathanhex.github.io/CICD-Practice/2023/02/05/%E5%9F%BA%E4%BA%8Ejenkins+kubernetes%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%90%AD%E5%BB%BA/">https://nathanhex.github.io/CICD-Practice/2023/02/05/%E5%9F%BA%E4%BA%8Ejenkins+kubernetes%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%90%AD%E5%BB%BA/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://nathanhex.github.io/CICD-Practice" target="_blank">老丶黄的个人博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/CICD-Practice/tags/jenkins/">jenkins</a><a class="post-meta__tags" href="/CICD-Practice/tags/kubernetes/">kubernetes</a><a class="post-meta__tags" href="/CICD-Practice/tags/CICD/">CICD</a><a class="post-meta__tags" href="/CICD-Practice/tags/%E6%8C%81%E7%BB%AD%E4%BA%A4%E4%BB%98/">持续交付</a><a class="post-meta__tags" href="/CICD-Practice/tags/devops/">devops</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/CICD-Practice/2023/02/04/nexus-install/" title="nexus安装配置教程"><img class="cover" src="/CICD-Practice/images/nexus-install-cover.png" onerror="onerror=null;src='/CICD-Practice/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">nexus安装配置教程</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/CICD-Practice/2023/02/04/nexus-install/" title="nexus安装配置教程"><img class="cover" src="/CICD-Practice/images/nexus-install-cover.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-04</div><div class="title">nexus安装配置教程</div></div></a></div><div><a href="/CICD-Practice/2023/02/04/not-imagePullSecrets-pull/" title="配置免imagePullSecrets拉取私有仓库镜像"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-04</div><div class="title">配置免imagePullSecrets拉取私有仓库镜像</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/CICD-Practice/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">老黄</div><div class="author-info__description">天生我材必有用，千金散尽还复来</div></div><div class="card-info-data site-data is-center"><a href="/CICD-Practice/archives/"><div class="headline">文章</div><div class="length-num">3</div></a><a href="/CICD-Practice/tags/"><div class="headline">标签</div><div class="length-num">6</div></a><a href="/CICD-Practice/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/nathanhex"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#jenkins%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">1.</span> <span class="toc-text">jenkins是什么？</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#why-jenkins-kubernetes"><span class="toc-number">2.</span> <span class="toc-text">why jenkins kubernetes</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E4%BC%A0%E7%BB%9Fjenkins-%E9%9B%86%E7%BE%A4%E9%97%AE%E9%A2%98%EF%BC%9A"><span class="toc-number">3.</span> <span class="toc-text">如何解决传统jenkins 集群问题：</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#kubernetes%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85"><span class="toc-number">4.</span> <span class="toc-text">kubernetes集群安装</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E5%AD%98%E5%82%A8"><span class="toc-number">4.1.</span> <span class="toc-text">动态存储</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85nfs"><span class="toc-number">4.1.1.</span> <span class="toc-text">安装nfs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85StorageClass%E4%BD%BF%E7%94%A8nfs%E6%8F%90%E4%BE%9B%E5%8A%A8%E6%80%81%E5%AD%98%E5%82%A8%E5%8D%B7"><span class="toc-number">4.1.2.</span> <span class="toc-text">安装StorageClass使用nfs提供动态存储卷</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E8%A3%85jenkins"><span class="toc-number">5.</span> <span class="toc-text">安装jenkins</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85jenkins%E5%BA%94%E7%94%A8"><span class="toc-number">5.1.</span> <span class="toc-text">安装jenkins应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%B9%B6%E9%85%8D%E7%BD%AEjenkins-kubernetes%E6%8F%92%E4%BB%B6"><span class="toc-number">5.2.</span> <span class="toc-text">安装并配置jenkins kubernetes插件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">5.2.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-number">5.2.2.</span> <span class="toc-text">配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85jenkins-%E9%92%89%E9%92%89%E9%80%9A%E7%9F%A5%E6%8F%92%E4%BB%B6"><span class="toc-number">5.3.</span> <span class="toc-text">安装jenkins 钉钉通知插件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E8%A3%85nexus"><span class="toc-number">6.</span> <span class="toc-text">安装nexus</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%9B%E5%BB%BApipeline"><span class="toc-number">7.</span> <span class="toc-text">创建pipeline</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">7.1.</span> <span class="toc-text">环境准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%EF%BC%9A"><span class="toc-number">7.1.1.</span> <span class="toc-text">1.配置文件格式：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%B0%86base64%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%94%A8%E4%BA%8E%E5%88%9B%E5%BB%BA%E7%9A%84%E5%AF%B9%E5%BA%94%E7%9A%84config-yaml%E6%96%87%E4%BB%B6%EF%BC%9A"><span class="toc-number">7.1.2.</span> <span class="toc-text">2.将base64字符串用于创建的对应的config.yaml文件：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%EF%BC%9A"><span class="toc-number">7.1.3.</span> <span class="toc-text">3.执行命令：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEjenkins%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E7%9A%84%E5%85%8D%E5%AF%86%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F%EF%BC%8C%E7%94%A8%E4%BA%8Ejenkins-slave-pod%E6%89%A7%E8%A1%8C%E6%97%B6%E6%8B%89%E5%8F%96%E7%A7%81%E6%9C%89%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93%E7%9A%84%E9%95%9C%E5%83%8F"><span class="toc-number">7.2.</span> <span class="toc-text">配置jenkins命名空间的免密拉取镜像，用于jenkins slave pod执行时拉取私有镜像仓库的镜像</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAjenkins-pipeline"><span class="toc-number">7.3.</span> <span class="toc-text">创建jenkins pipeline</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AEjenkinsfile"><span class="toc-number">7.4.</span> <span class="toc-text">前端项目jenkinsfile</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E7%82%B9%EF%BC%9A"><span class="toc-number">7.4.1.</span> <span class="toc-text">优化点：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E9%A1%B9%E7%9B%AEjenkinsfile"><span class="toc-number">7.5.</span> <span class="toc-text">后端项目jenkinsfile</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E7%82%B9%EF%BC%9A-1"><span class="toc-number">7.5.1.</span> <span class="toc-text">优化点：</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/CICD-Practice/2023/02/05/%E5%9F%BA%E4%BA%8Ejenkins+kubernetes%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%90%AD%E5%BB%BA/" title="基于jenkins+kubernetes的持续集成流水线搭建"><img src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/CICD-Practice/img/404.jpg'" alt="基于jenkins+kubernetes的持续集成流水线搭建"/></a><div class="content"><a class="title" href="/CICD-Practice/2023/02/05/%E5%9F%BA%E4%BA%8Ejenkins+kubernetes%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%90%AD%E5%BB%BA/" title="基于jenkins+kubernetes的持续集成流水线搭建">基于jenkins+kubernetes的持续集成流水线搭建</a><time datetime="2023-02-04T16:00:00.000Z" title="发表于 2023-02-05 00:00:00">2023-02-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/CICD-Practice/2023/02/04/nexus-install/" title="nexus安装配置教程"><img src="/CICD-Practice/images/nexus-install-cover.png" onerror="this.onerror=null;this.src='/CICD-Practice/img/404.jpg'" alt="nexus安装配置教程"/></a><div class="content"><a class="title" href="/CICD-Practice/2023/02/04/nexus-install/" title="nexus安装配置教程">nexus安装配置教程</a><time datetime="2023-02-03T16:00:00.000Z" title="发表于 2023-02-04 00:00:00">2023-02-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/CICD-Practice/2023/02/04/not-imagePullSecrets-pull/" title="配置免imagePullSecrets拉取私有仓库镜像"><img src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/CICD-Practice/img/404.jpg'" alt="配置免imagePullSecrets拉取私有仓库镜像"/></a><div class="content"><a class="title" href="/CICD-Practice/2023/02/04/not-imagePullSecrets-pull/" title="配置免imagePullSecrets拉取私有仓库镜像">配置免imagePullSecrets拉取私有仓库镜像</a><time datetime="2023-02-03T16:00:00.000Z" title="发表于 2023-02-04 00:00:00">2023-02-04</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By 老黄</div><div class="footer_custom_text">欢迎来到老黄的<a href="https://nathanhex.github.io/CICD-Practice/">博客</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/CICD-Practice/js/utils.js"></script><script src="/CICD-Practice/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>