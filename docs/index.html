<!DOCTYPE html><html><head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style>
            @charset "utf-8";
            *,
            *::after,
            *::before {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Segoe UI", "Helvetica Neue", "PingFang SC", "Noto Sans", "Noto Sans CJK SC", "Microsoft YaHei", "\5FAE\8F6F\96C5\9ED1", sans-serif;
                font-size: 16px;
                line-height: 24px;
                color: #222;
            }
            ::selection {
                background-color: rgba(107, 112, 184, 0.16);
            }
            #title {
                font-size: 36px;
                line-height: 54px;
                font-weight: 500;
            }
            h1 {
                margin: 28px 0 0;
                font-size: 28px;
                line-height: 42px;
            }
            h2 {
                margin: 24px 0 0;
                font-size: 24px;
                line-height: 26px;
            }
            h3 {
                margin: 20px 0 0;
                font-size: 20px;
                line-height: 30px;
            }
            p {
                margin: 16px 0 0;
                line-height: 24px;
            }
            blockquote {
                margin: 16px 0 0;
                padding: 0 0 0 20px;
                line-height: 24px;
                box-shadow: inset 4px 0 0 0 #EEEEEE;
            }
            ol,
            ul {
                padding: 8px 0 0 32px;
            }
            li {
                margin: 8px 0 0;
                line-height: 24px;
            }
            hr {
                margin: 16px 0 0;
                height: 1px;
                background-color: #e9e9e9;
                border: none;
            }
            img {
                width: 100%;
                display: block;
            }
            pre {
                margin: 12px 0 0;
                border-radius: 4px;
                padding: 12px;
                background-color: #f5f5f5;
                font-size: 14px;
                white-space: pre-wrap;
            }
            code {
                color: #657B83;
                font-size: inherit;
                border-radius: 4px;
                display: block;
            }
            p code,
            table code {
                display: inline;
                padding: 4px;
                background-color: #f5f5f5;
            }
            a,
            a u {
                color: rgb(61, 168, 245);
                font-size: 16px;
                line-height: 20px;
                text-decoration: none;
                cursor: pointer;
            }
            a:hover {
                text-decoration: underline;
            }
            table {
                margin: 32px 0 0;
                border-left: 1px solid #D8D8D8;
                border-top: 1px solid #D8D8D8;
                border-collapse: collapse;
                border-spacing: 0;
            }
            table td {
                table-layout: fixed;
                padding: 8px 12px;
                min-width: 200px;
                max-width: 1000px;
                border-right: 1px solid #D8D8D8;
                border-bottom: 1px solid #D8D8D8;
            }
            table a,
            table blockquote,
            table code,
            table h1,
            table h2,
            table h3,
            table li,
            table p {
                margin: 0;
            }
            table ol,
            table ul {
                padding: 0 0 0 30px;
            }
            footer {
                padding: 48px;
                background-color: #f5f5f5;
                display: flex;
                justify-content: center;
            }
            footer a {
                padding-left: 28px;
                line-height: 24px;
                height: 24px;
                color: #808080;
                background-image: url("https://dn-clients.teambition.net/thoughts/thoughts_logo.svg");
                background-size: 24px 24px;
                background-repeat: no-repeat;
            }
            #page {
                max-width: 1024px;
                min-height: calc(100vh - 120px);
                margin: 0 auto;
                padding: 72px;
            }
            /* 检查项 */
            [data-type="checkbox"] {
                padding-left: 15px;
            }
            [data-check="true"],
            [data-check="false"] {
                list-style-type: none;
                padding-left: 0;
            }
            [data-check="true"]::before,
            [data-check="false"]::before {
                content: "";
                width: 14px;
                height: 14px;
                border-radius: 4px;
                vertical-align: bottom;
                display: inline-block;
                margin: 5px 11px;
                background-position: 50%;
                background-repeat: no-repeat;
                box-shadow: inset 0 0 0 1px#ddd;
            }
            [data-check="true"]::before {
                background-color: #6B70B8;
                box-shadow: inset 0 0 0 1px #6B70B8;
                background-image: url("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMTJweCIgaGVpZ2h0PSIxMnB4IiB2aWV3Qm94PSIwIDAgMTIgMTIiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDU0ICg3NjQ4MCkgLSBodHRwczovL3NrZXRjaGFwcC5jb20gLS0+CiAgICA8dGl0bGU+55S75p2/PC90aXRsZT4KICAgIDxkZXNjPkNyZWF0ZWQgd2l0aCBTa2V0Y2guPC9kZXNjPgogICAgPGcgaWQ9IueUu+advyIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+CiAgICAgICAgPHBvbHlnb24gaWQ9InYiIGZpbGw9IiNGRkZGRkYiIGZpbGwtcnVsZT0ibm9uemVybyIgcG9pbnRzPSIyLjM0NzM1NTA3IDUuOTc5NTQ0MzcgMS42NDkzMzI2MyA2LjY5NTYyMDI1IDQuNTM2MjIwMiA5LjUwOTcyNDczIDEwLjM1MzA5MTMgMy43MDgwMjk4IDkuNjQ2OTA4NzIgMyA0LjUyODE3MzMzIDguMTA1MzgwNjgiPjwvcG9seWdvbj4KICAgIDwvZz4KPC9zdmc+");
            }
            /* 块样式 */
            [data-type="attachment"] a,
            [data-type="relation"] a,
            [data-type="embed"] a {
                font-size: 14px;
                line-height: 24px;
                height: 48px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                width: 100%;
                margin: 16px 0 0;
                display: block;
                padding: 12px 12px 12px 40px;
                color: #222!important;
                border-radius: 4px;
                transition: 0.3s ease;
                box-shadow: inset 0 0 0 1px #eeeeee;
                background-repeat: no-repeat;
                background-position: 12px 50%;
            }
            [data-type="attachment"] a:hover,
            [data-type="relation"] a:hover,
            [data-type="embed"] a:hover {
                text-decoration: none!important;
                background-color: #f5f5f5;
            }
            /* 行内样式 */
            [data-type="document"],
            [data-type="file"],
            [data-type="folder"],
            [data-type="teambition-task"],
            [data-type="teambition-file"],
            [data-type="teambition-folder"],
            [data-type="teambition-date"],
            [data-type="DATE"] {
                background-position: 4px 50%;
                padding: 0 4px 0 26px;
                background-repeat: no-repeat;
            }
            /* 类型图标 */
            [data-type="embed"] a {
                background-image: url("data:image/svg+xml;base64,PHN2ZwogICAgd2lkdGg9IjIwcHgiCiAgICBoZWlnaHQ9IjIwcHgiCiAgICB2aWV3Qm94PSIwIDAgMjAgMjAiCiAgICB2ZXJzaW9uPSIxLjEiCiAgICB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgICB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8cGF0aAogICAgICAgIGQ9Ik0xMC4wMDAxLDE0LjU2ODQgQzEwLjA4MTEsMTQuNTY4NCAxMC4xNjExLDE0LjU4NDQgMTAuMjM2MSwxNC42MTY0IEwxNC42MDkxLDE2LjQ5MDQgTDE0LjYwOTEsNC4wODg0IEMxNC42MDkxLDMuNTk4NCAxNC4yMTAxLDMuMjAwNCAxMy43MjExLDMuMjAwNCBMNi4yNzkxLDMuMjAwNCBDNS43OTAxLDMuMjAwNCA1LjM5MTEsMy41OTg0IDUuMzkxMSw0LjA4ODQgTDUuMzkxMSwxNi40OTA0IEw5Ljc2NDEsMTQuNjE2NCBDOS44MzkxLDE0LjU4NDQgOS45MTkxLDE0LjU2ODQgMTAuMDAwMSwxNC41Njg0IEwxMC4wMDAxLDE0LjU2ODQgWiBNMTUuMjA5MSwxOC4wMDA0IEMxNS4xMjkxLDE4LjAwMDQgMTUuMDQ4MSwxNy45ODQ0IDE0Ljk3MzEsMTcuOTUyNCBMMTAuMDAwMSwxNS44MjA0IEw1LjAyNzEsMTcuOTUyNCBDNC44NDIxLDE4LjAzMTQgNC42MjgxLDE4LjAxMjQgNC40NjExLDE3LjkwMTQgQzQuMjkyMSwxNy43OTA0IDQuMTkxMSwxNy42MDI0IDQuMTkxMSwxNy40MDA0IEw0LjE5MTEsNC4wODg0IEM0LjE5MTEsMi45Mzc0IDUuMTI4MSwyLjAwMDQgNi4yNzkxLDIuMDAwNCBMMTMuNzIxMSwyLjAwMDQgQzE0Ljg3MjEsMi4wMDA0IDE1LjgwOTEsMi45Mzc0IDE1LjgwOTEsNC4wODg0IEwxNS44MDkxLDE3LjQwMDQgQzE1LjgwOTEsMTcuNjAyNCAxNS43MDgxLDE3Ljc5MDQgMTUuNTM5MSwxNy45MDE0IEMxNS40NDAxLDE3Ljk2NjQgMTUuMzI1MSwxOC4wMDA0IDE1LjIwOTEsMTguMDAwNCBMMTUuMjA5MSwxOC4wMDA0IFoiCiAgICAgICAgaWQ9ImJvb2ttYXJrIgogICAgICAgIGZpbGw9IiNBNkE2QTYiPjwvcGF0aD4KPC9zdmc+");
            }
            [data-type="DATE"] {
                color: #808080;
                background-image: url("data:image/svg+xml;base64,PHN2ZwogICAgd2lkdGg9IjIwcHgiCiAgICBoZWlnaHQ9IjIwcHgiCiAgICB2aWV3Qm94PSIwIDAgMjAgMjAiCiAgICB2ZXJzaW9uPSIxLjEiCiAgICB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgICB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8cGF0aAogICAgICAgIGQ9Ik0xNS4yOTQsMy40MTIgQzE2LjM5NCwzLjQxMiAxNy4yOTQsNC4zMTIgMTcuMjk0LDUuNDEyIEwxNy4yOTQsMTYgQzE3LjI5NCwxNy4xIDE2LjM5NCwxOCAxNS4yOTQsMTggTDQuNzA2LDE4IEMzLjYwNiwxOCAyLjcwNiwxNy4xIDIuNzA2LDE2IEwyLjcwNiw1LjQxMiBDMi43MDYsNC4zMTIgMy42MDYsMy40MTIgNC43MDYsMy40MTIgTDYuMTQ2LDMuNDEyIEw2LjE0NiwyLjYgQzYuMTQ2LDIuMjY5IDYuNDE1LDIgNi43NDYsMiBDNy4wNzgsMiA3LjM0NiwyLjI2OSA3LjM0NiwyLjYgTDcuMzQ2LDMuNDEyIEwxMi42NTQsMy40MTIgTDEyLjY1NCwyLjYgQzEyLjY1NCwyLjI2OSAxMi45MjIsMiAxMy4yNTQsMiBDMTMuNTg2LDIgMTMuODU0LDIuMjY5IDEzLjg1NCwyLjYgTDEzLjg1NCwzLjQxMiBMMTUuMjk0LDMuNDEyIFogTTE1LjI5NCwxNi44IEMxNS43MjgsMTYuOCAxNi4wOTQsMTYuNDM0IDE2LjA5NCwxNiBMMTYuMDk0LDguMjgyIEwzLjkwNiw4LjI4MiBMMy45MDYsMTYgQzMuOTA2LDE2LjQzNCA0LjI3MiwxNi44IDQuNzA2LDE2LjggTDE1LjI5NCwxNi44IFogTTQuNzA2LDQuNjEyIEM0LjI3Miw0LjYxMiAzLjkwNiw0Ljk3OCAzLjkwNiw1LjQxMiBMMy45MDYsNy4wODIgTDE2LjA5NCw3LjA4MiBMMTYuMDk0LDUuNDEyIEMxNi4wOTQsNC45NzggMTUuNzI4LDQuNjEyIDE1LjI5NCw0LjYxMiBMMTMuODU0LDQuNjEyIEwxMy44NTQsNS4wMzggQzEzLjg1NCw1LjM2OSAxMy41ODYsNS42MzggMTMuMjU0LDUuNjM4IEMxMi45MjIsNS42MzggMTIuNjU0LDUuMzY5IDEyLjY1NCw1LjAzOCBMMTIuNjU0LDQuNjEyIEw3LjM0Niw0LjYxMiBMNy4zNDYsNS4wMzggQzcuMzQ2LDUuMzY5IDcuMDc4LDUuNjM4IDYuNzQ2LDUuNjM4IEM2LjQxNSw1LjYzOCA2LjE0Niw1LjM2OSA2LjE0Niw1LjAzOCBMNi4xNDYsNC42MTIgTDQuNzA2LDQuNjEyIFoiCiAgICAgICAgZmlsbD0iI0E2QTZBNiI+PC9wYXRoPgo8L3N2Zz4=");
            }
            [data-type="attachment"] a {
                background-image: url("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMjBweCIgaGVpZ2h0PSIyMHB4IiB2aWV3Qm94PSIwIDAgMjAgMjAiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDU0ICg3NjQ4MCkgLSBodHRwczovL3NrZXRjaGFwcC5jb20gLS0+CiAgICA8dGl0bGU+ZnVqaWFuPC90aXRsZT4KICAgIDxkZXNjPkNyZWF0ZWQgd2l0aCBTa2V0Y2guPC9kZXNjPgogICAgPGRlZnM+CiAgICAgICAgPHBhdGggZD0iTTE0LDQgTDcuNiw0IEM0LjUxMiw0IDIsNi41MTIgMiw5LjYgQzIsMTIuNjg4IDQuNTEyLDE1LjIgNy42LDE1LjIgTDEyLjk5NiwxNS4yIEMxMy4zMjcsMTUuMiAxMy41OTYsMTQuOTMxIDEzLjU5NiwxNC42IEMxMy41OTYsMTQuMjY5IDEzLjMyNywxNCAxMi45OTYsMTQgTDcuNiwxNCBDNS4xNzQsMTQgMy4yLDEyLjAyNiAzLjIsOS42IEMzLjIsNy4xNzQgNS4xNzQsNS4yIDcuNiw1LjIgTDE0LDUuMiBDMTUuNTQ0LDUuMiAxNi44LDYuNDU2IDE2LjgsOCBDMTYuOCw5LjU0NCAxNS41NDQsMTAuOCAxNCwxMC44IEw3LjgxMywxMC44IEM3LjE1MiwxMC44IDYuNjE0LDEwLjI2MiA2LjYxNCw5LjYgQzYuNjE0LDguOTM4IDcuMTUyLDguNCA3LjgxMyw4LjQgTDEyLjk5Niw4LjQgQzEzLjMyNyw4LjQgMTMuNTk2LDguMTMyIDEzLjU5Niw3LjggQzEzLjU5Niw3LjQ2OSAxMy4zMjcsNy4yIDEyLjk5Niw3LjIgTDcuODEzLDcuMiBDNi40OSw3LjIgNS40MTQsOC4yNzcgNS40MTQsOS42IEM1LjQxNCwxMC45MjMgNi40OSwxMiA3LjgxMywxMiBMMTQsMTIgQzE2LjIwNiwxMiAxOCwxMC4yMDYgMTgsOCBDMTgsNS43OTQgMTYuMjA2LDQgMTQsNCBMMTQsNCBaIiBpZD0icGF0aC0xIj48L3BhdGg+CiAgICA8L2RlZnM+CiAgICA8ZyBpZD0iZnVqaWFuIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0iMSIgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj4KICAgICAgICA8bWFzayBpZD0ibWFzay0yIiBmaWxsPSJ3aGl0ZSI+CiAgICAgICAgICAgIDx1c2UgeGxpbms6aHJlZj0iI3BhdGgtMSI+PC91c2U+CiAgICAgICAgPC9tYXNrPgogICAgICAgIDx1c2UgaWQ9Imljb24tcGFwZXJjbGlwIiBmaWxsPSIjQTZBNkE2IiB4bGluazpocmVmPSIjcGF0aC0xIj48L3VzZT4KICAgIDwvZz4KPC9zdmc+");
            }
            [data-type="document"] {
                color: #808080;
                background-image: url("data:image/svg+xml;base64,PHN2ZwogICAgd2lkdGg9IjIwcHgiCiAgICBoZWlnaHQ9IjIwcHgiCiAgICB2aWV3Qm94PSIwIDAgMjAgMjAiCiAgICB2ZXJzaW9uPSIxLjEiCiAgICB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgICB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8cGF0aAogICAgICAgIGQ9Ik0xMS4xMDA1MDUxLDIgTDE3LDcuODk5NDk0OTQgTDE3LDE2IEMxNywxNy4xMDQ1Njk1IDE2LjEwNDU2OTUsMTggMTUsMTggTDUsMTggQzMuODk1NDMwNSwxOCAzLDE3LjEwNDU2OTUgMywxNiBMMyw0IEMzLDIuODk1NDMwNSAzLjg5NTQzMDUsMiA1LDIgTDExLjEwMDUwNTEsMiBaIgogICAgICAgIGlkPSJQYXRoIgogICAgICAgIGZpbGwtb3BhY2l0eT0iMC4zIgogICAgICAgIGZpbGw9IiM2QjcwQjgiPjwvcGF0aD4KICAgIDxwYXRoCiAgICAgICAgZD0iTTE3LDggTDEzLDggQzExLjg5NTQzMDUsOCAxMSw3LjEwNDU2OTUgMTEsNiBMMTEsMiBMMTEuMTAwNTA1MSwyIEwxNyw3Ljg5OTQ5NDk0IEwxNyw4IFoiCiAgICAgICAgaWQ9IlBhdGgiCiAgICAgICAgZmlsbD0iIzZCNzBCOCI+PC9wYXRoPgogICAgPHJlY3QKICAgICAgICBpZD0iZG9jaWNvbi90aG91Z2h0LWRvYyIKICAgICAgICBmaWxsPSIjNkI3MEI4IgogICAgICAgIHg9IjUuNSIKICAgICAgICB5PSIxMSIKICAgICAgICB3aWR0aD0iOSIKICAgICAgICBoZWlnaHQ9IjEuNiIKICAgICAgICByeD0iMC44Ij48L3JlY3Q+CiAgICA8cmVjdAogICAgICAgIGlkPSJkb2NpY29uL3Rob3VnaHQtZG9jIgogICAgICAgIGZpbGw9IiM2QjcwQjgiCiAgICAgICAgeD0iNS41IgogICAgICAgIHk9IjE0IgogICAgICAgIHdpZHRoPSI0IgogICAgICAgIGhlaWdodD0iMS42IgogICAgICAgIHJ4PSIwLjgiPjwvcmVjdD4KPC9zdmc+");
            }
            [data-type="file"] {
                color: #808080;
                background-image: url("data:image/svg+xml;base64,PHN2ZwogICAgd2lkdGg9IjIwcHgiCiAgICBoZWlnaHQ9IjIwcHgiCiAgICB2aWV3Qm94PSIwIDAgMjAgMjAiCiAgICB2ZXJzaW9uPSIxLjEiCiAgICB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgICB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8cGF0aAogICAgICAgIGQ9Ik0xMS4xMDA1MDUxLDIgTDE3LDcuODk5NDk0OTQgTDE3LDE2IEMxNywxNy4xMDQ1Njk1IDE2LjEwNDU2OTUsMTggMTUsMTggTDUsMTggQzMuODk1NDMwNSwxOCAzLDE3LjEwNDU2OTUgMywxNiBMMyw0IEMzLDIuODk1NDMwNSAzLjg5NTQzMDUsMiA1LDIgTDExLjEwMDUwNTEsMiBaIgogICAgICAgIGlkPSJQYXRoIgogICAgICAgIGZpbGwtb3BhY2l0eT0iMC4zIgogICAgICAgIGZpbGw9IiM2QjcwQjgiPjwvcGF0aD4KICAgIDxwYXRoCiAgICAgICAgZD0iTTE3LDggTDEzLDggQzExLjg5NTQzMDUsOCAxMSw3LjEwNDU2OTUgMTEsNiBMMTEsMiBMMTEuMTAwNTA1MSwyIEwxNyw3Ljg5OTQ5NDk0IEwxNyw4IFoiCiAgICAgICAgaWQ9IlBhdGgiCiAgICAgICAgZmlsbD0iIzZCNzBCOCI+PC9wYXRoPgo8L3N2Zz4=");
            }
            [data-type="folder"] {
                color: #808080;
                background-image: url("data:image/svg+xml;base64,PHN2ZwogICAgd2lkdGg9IjIwcHgiCiAgICBoZWlnaHQ9IjIwcHgiCiAgICB2aWV3Qm94PSIwIDAgMjAgMjAiCiAgICB2ZXJzaW9uPSIxLjEiCiAgICB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgICB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8cGF0aAogICAgICAgIGQ9Ik0xNi41LDUgQzE3LjYwNDU2OTUsNSAxOC41LDUuODk1NDMwNSAxOC41LDcgTDE4LjUsOCBMMS41LDggQzEuNSw3LjM3MDczNTg5IDEuNSw2LjM3MDczNTg5IDEuNSw1IEMxLjUsMy44OTU0MzA1IDIuMzk1NDMwNSwzIDMuNSwzIEw3LjI3NjQ2OTQ1LDMgQzcuNTYyNDk1NDcsMyA3LjgzNDgzMDg0LDMuMTIyNDc4ODEgOC4wMjQ2MTgwMywzLjMzNjQ2ODc3IEw5LjUsNSBMMTYuNSw1IFoiCiAgICAgICAgaWQ9ImZvbGRlcmljb24vdGhvdWdodC1mb2xkZXIiCiAgICAgICAgZmlsbD0iIzZCNzBCOCI+PC9wYXRoPgogICAgPHBhdGgKICAgICAgICBkPSJNMS41LDggTDE4LjUsOCBMMTguNSwxNSBDMTguNSwxNi4xMDQ1Njk1IDE3LjYwNDU2OTUsMTcgMTYuNSwxNyBMMy41LDE3IEMyLjM5NTQzMDUsMTcgMS41LDE2LjEwNDU2OTUgMS41LDE1IEwxLjUsOCBaIgogICAgICAgIGlkPSJmb2xkZXJpY29uL3Rob3VnaHQtZm9sZGVyIgogICAgICAgIGZpbGwtb3BhY2l0eT0iMC4zIgogICAgICAgIGZpbGw9IiM2QjcwQjgiPjwvcGF0aD4KPC9zdmc+");
            }
            [data-type="teambition-task"] {
                color: #808080;
                background-image: url("data:image/svg+xml;base64,PHN2ZwogICAgd2lkdGg9IjIwcHgiCiAgICBoZWlnaHQ9IjIwcHgiCiAgICB2aWV3Qm94PSIwIDAgMjAgMjAiCiAgICB2ZXJzaW9uPSIxLjEiCiAgICB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgICB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8cmVjdAogICAgICAgIGlkPSJ0YXNraWNvbi90Yi10YXNrIgogICAgICAgIGZpbGwtb3BhY2l0eT0iMC4zIgogICAgICAgIGZpbGw9IiMzREE4RjUiCiAgICAgICAgeD0iMyIKICAgICAgICB5PSIzIgogICAgICAgIHdpZHRoPSIxNCIKICAgICAgICBoZWlnaHQ9IjE0IgogICAgICAgIHJ4PSIyIj48L3JlY3Q+CiAgICA8cGF0aAogICAgICAgIGQ9Ik05Ljk0OTAyNzg5LDEwLjg3MDMzMTkgTDE3LjQzNjE4NTMsMy40MzI0NTAwNCBDMTcuNzQ5NjM0NSwzLjEyMTA2Mzc2IDE4LjI1NjE2MzcsMy4xMjI3MzYwOSAxOC41Njc1NSwzLjQzNjE4NTI4IEMxOC44Nzg5MzYyLDMuNzQ5NjM0NDcgMTguODc3MjYzOSw0LjI1NjE2MzY5IDE4LjU2MzgxNDcsNC41Njc1NDk5NiBMMTAuNTEwODE1MiwxMi41Njc1NSBDMTAuMTk4MDMzNywxMi44NzgyNzI5IDkuNjkyODE2MjcsMTIuODc3MzY2MiA5LjM4MTE1MjE1LDEyLjU2NTUyMjUgTDYuNDM0MTUxNzEsOS42MTY4MjQ0NyBDNi4xMjE4MjIyNSw5LjMwNDMxNTA5IDYuMTIxOTY4MSw4Ljc5Nzc4MzEzIDYuNDM0NDc3NDgsOC40ODU0NTM2NyBDNi43NDY5ODY4Niw4LjE3MzEyNDIxIDcuMjUzNTE4ODIsOC4xNzMyNzAwNiA3LjU2NTg0ODI5LDguNDg1Nzc5NDQgTDkuOTQ5MDI3ODksMTAuODcwMzMxOSBaIgogICAgICAgIGlkPSJQYXRoIgogICAgICAgIGZpbGw9IiMzREE4RjUiCiAgICAgICAgZmlsbC1ydWxlPSJub256ZXJvIj48L3BhdGg+Cjwvc3ZnPg==");
            }
            [data-type="teambition-file"] {
                color: #808080;
                background-image: url("data:image/svg+xml;base64,PHN2ZwogICAgd2lkdGg9IjIwcHgiCiAgICBoZWlnaHQ9IjIwcHgiCiAgICB2aWV3Qm94PSIwIDAgMjAgMjAiCiAgICB2ZXJzaW9uPSIxLjEiCiAgICB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgICB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8cGF0aAogICAgICAgIGQ9Ik0xMS4xMDA1MDUxLDIgTDE3LDcuODk5NDk0OTQgTDE3LDE2IEMxNywxNy4xMDQ1Njk1IDE2LjEwNDU2OTUsMTggMTUsMTggTDUsMTggQzMuODk1NDMwNSwxOCAzLDE3LjEwNDU2OTUgMywxNiBMMyw0IEMzLDIuODk1NDMwNSAzLjg5NTQzMDUsMiA1LDIgTDExLjEwMDUwNTEsMiBaIgogICAgICAgIGlkPSJQYXRoIgogICAgICAgIGZpbGwtb3BhY2l0eT0iMC4zIgogICAgICAgIGZpbGw9IiMzREE4RjUiPjwvcGF0aD4KICAgIDxwYXRoCiAgICAgICAgZD0iTTE3LDggTDEzLDggQzExLjg5NTQzMDUsOCAxMSw3LjEwNDU2OTUgMTEsNiBMMTEsMiBMMTEuMTAwNTA1MSwyIEwxNyw3Ljg5OTQ5NDk0IEwxNyw4IFoiCiAgICAgICAgaWQ9IlBhdGgiCiAgICAgICAgZmlsbD0iIzNEQThGNSI+PC9wYXRoPgo8L3N2Zz4=");
            }
            [data-type="teambition-folder"] {
                color: #808080;
                background-image: url("data:image/svg+xml;base64,PHN2ZwogICAgd2lkdGg9IjIwcHgiCiAgICBoZWlnaHQ9IjIwcHgiCiAgICB2aWV3Qm94PSIwIDAgMjAgMjAiCiAgICB2ZXJzaW9uPSIxLjEiCiAgICB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgICB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8cGF0aAogICAgICAgIGQ9Ik0xNi41LDUgQzE3LjYwNDU2OTUsNSAxOC41LDUuODk1NDMwNSAxOC41LDcgTDE4LjUsOCBMMS41LDggQzEuNSw3LjM3MDczNTg5IDEuNSw2LjM3MDczNTg5IDEuNSw1IEMxLjUsMy44OTU0MzA1IDIuMzk1NDMwNSwzIDMuNSwzIEw3LjI3NjQ2OTQ1LDMgQzcuNTYyNDk1NDcsMyA3LjgzNDgzMDg0LDMuMTIyNDc4ODEgOC4wMjQ2MTgwMywzLjMzNjQ2ODc3IEw5LjUsNSBMMTYuNSw1IFoiCiAgICAgICAgaWQ9ImZvbGRlcmljb24vdGItZm9sZGVyIgogICAgICAgIGZpbGw9IiMzREE4RjUiPjwvcGF0aD4KICAgIDxwYXRoCiAgICAgICAgZD0iTTEuNSw4IEwxOC41LDggTDE4LjUsMTUgQzE4LjUsMTYuMTA0NTY5NSAxNy42MDQ1Njk1LDE3IDE2LjUsMTcgTDMuNSwxNyBDMi4zOTU0MzA1LDE3IDEuNSwxNi4xMDQ1Njk1IDEuNSwxNSBMMS41LDggWiIKICAgICAgICBpZD0iZm9sZGVyaWNvbi90Yi1mb2xkZXIiCiAgICAgICAgZmlsbC1vcGFjaXR5PSIwLjMiCiAgICAgICAgZmlsbD0iIzNEQThGNSI+PC9wYXRoPgo8L3N2Zz4=");
            }
            [data-type="teambition-date"] {
                color: #808080;
                background-image: url("data:image/svg+xml;base64,PHN2ZwogICAgd2lkdGg9IjIwcHgiCiAgICBoZWlnaHQ9IjIwcHgiCiAgICB2aWV3Qm94PSIwIDAgMjAgMjAiCiAgICB2ZXJzaW9uPSIxLjEiCiAgICB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgICB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8cmVjdAogICAgICAgIGlkPSJkYXRlaWNvbi90Yi1kYXRlIgogICAgICAgIGZpbGwtb3BhY2l0eT0iMC4zIgogICAgICAgIGZpbGw9IiMzREE4RjUiCiAgICAgICAgeD0iMiIKICAgICAgICB5PSI0IgogICAgICAgIHdpZHRoPSIxNiIKICAgICAgICBoZWlnaHQ9IjEzIgogICAgICAgIHJ4PSIyIj48L3JlY3Q+CiAgICA8cGF0aAogICAgICAgIGQ9Ik00LDQgTDE2LDQgQzE3LjEwNDU2OTUsNCAxOCw0Ljg5NTQzMDUgMTgsNiBMMTgsOCBMMiw4IEwyLDYgQzIsNC44OTU0MzA1IDIuODk1NDMwNSw0IDQsNCBaIgogICAgICAgIGlkPSJkYXRlaWNvbi90Yi1kYXRlIgogICAgICAgIGZpbGw9IiMzREE4RjUiPjwvcGF0aD4KICAgIDxwYXRoCiAgICAgICAgZD0iTTYuNiwyIEw2LjYsMiBDNy4wNDE4Mjc4LDIgNy40LDIuMzU4MTcyMiA3LjQsMi44IEw3LjQsNiBMNS44LDYgTDUuOCwyLjggQzUuOCwyLjM1ODE3MjIgNi4xNTgxNzIyLDIgNi42LDIgWiIKICAgICAgICBpZD0iZGF0ZWljb24vdGItZGF0ZSIKICAgICAgICBmaWxsPSIjM0RBOEY1Ij48L3BhdGg+CiAgICA8cGF0aAogICAgICAgIGQ9Ik0xMy40LDIgTDEzLjQsMiBDMTMuODQxODI3OCwyIDE0LjIsMi4zNTgxNzIyIDE0LjIsMi44IEwxNC4yLDYgTDEyLjYsNiBMMTIuNiwyLjggQzEyLjYsMi4zNTgxNzIyIDEyLjk1ODE3MjIsMiAxMy40LDIgWiIKICAgICAgICBpZD0iZGF0ZWljb24vdGItZGF0ZSIKICAgICAgICBmaWxsPSIjM0RBOEY1Ij48L3BhdGg+Cjwvc3ZnPg==");
            }
        </style>
    <title>持续交付-jenkins+kubernetes持续集成流水线搭建</title></head>
    <body>
        <div id="page"><div id="title">持续交付-jenkins+kubernetes持续集成流水线搭建</div><h1 data-key="63720511b6ed07be13077f2f" data-type="header-one">jenkins是什么？</h1><p data-key="6374aae1ca6aa6a636fbd69f" data-type="paragraph">Jenkins是一款开源 CICD 软件，用于自动化各种任务，包括构建、测试和部署软件。</p><p data-key="6374aae1ca6aa63a32fbd6a0" data-type="paragraph">Jenkins 支持各种运行方式，可通过系统包、Docker 或者通过一个独立的 Java 程序。</p><h1 data-key="6374aae1ca6aa63492fbd6a1" data-type="header-one">why jenkins kubernetes</h1><p data-key="6374ab1dca6aa68320fbd6a4" data-type="paragraph">持续构建与发布是我们日常工作中必不可少的一个步骤，jenkins需要的资源有时候单台机器不一定能满足全公司的构建发布需求，所以使用一般需要Jenkins 集群来搭建符合需求的 CI/CD 流程，然而传统的 Jenkins Slave 一主多从方式会存在一些痛点:</p><p data-key="6374ab5eca6aa6028cfbd6a6" data-type="paragraph">痛点1：主 Master 发生单点故障时，整个流程都不可用了；</p><p data-key="6374ab7cca6aa6e4c7fbd6a9" data-type="paragraph">痛点2：每个 Slave 的配置环境不一样，来完成不同语言的编译打包等操作，但是这些差异化的配置导致管理起来非常不方便，维护起来也是比较费劲；</p><p data-key="6374ab7cca6aa67edefbd6aa" data-type="paragraph">痛点3：资源分配不均衡，有的 Slave 要运行的 job 出现排队等待，而有的 Slave 处于空闲状态；</p><p data-key="6374ab7cca6aa6c01bfbd6ab" data-type="paragraph">痛点4：最后资源有浪费，每台 Slave 可能是实体机或者 VM，当 Slave 处于空闲状态时，也不会完全释放掉资源。</p><h1 data-key="6374aae1ca6aa605a9fbd6a2" data-type="header-one">如何解决传统jenkins 集群问题：</h1><p data-key="6374ac3fca6aa6de93fbd6f0" data-type="paragraph">1.kubernetes deployment可以检测到jenkins master实例挂掉后在新的节点上重启一个新的jenkins master示例，重启的这段时间内jenkins还是无法使用，这个方案暂时不完美，但是可以通过冷备的方式解决master单点故障问题。</p><p data-key="63c655f0ed6aa638a6f8b379" data-type="paragraph">2.由docker提供slave节点需要的系统配置，确保了按需提供slave节点的软件环境，在pipline里声明任务所需的系统和软件环境，非常自由方便</p><p data-key="63c6567ced6aa6f908f8b37c" data-type="paragraph">3.slave节点由kubernetes管理，按需创建，使用完slave节点pod就销毁了，资源释放给其他任务使用，不会出现slave节点资源闲置浪费或等待排队的情况</p><h1 data-key="6374ac62ca6aa67eb3fbd6f4" data-type="header-one">kubernetes集群安装</h1><h2 data-key="63a129af35bfc95bad9379a3" data-type="header-two">动态存储</h2><h3 data-key="63a129af35bfc942009379a4" data-type="header-three">安装nfs</h3><p data-key="63a129af35bfc976969379a5" data-type="paragraph">在主机192.168.0.105的centos系统下安装nfs：</p><pre data-key="63a129af35bfc90e619379a6" data-type="code-wrapper"><code data-key="thoughts-12627" data-type="code-block">#安装nfs</code><code data-key="thoughts-12628" data-type="code-block">sudo yum install nfs-utils</code><code data-key="thoughts-12629" data-type="code-block"></code><code data-key="thoughts-12630" data-type="code-block">#创建nfs数据文件夹夹</code><code data-key="thoughts-12631" data-type="code-block">sudo mkdir /data</code><code data-key="thoughts-12632" data-type="code-block">sudo chmod 755 /data</code><code data-key="thoughts-12633" data-type="code-block">#nfs配置</code><code data-key="thoughts-12634" data-type="code-block">sudo echo  "/data/    *(rw,sync,no_root_squash,no_all_squash)" &gt;&gt; /etc/exports</code><code data-key="thoughts-12635" data-type="code-block">#启动nfs相关服务</code><code data-key="thoughts-12636" data-type="code-block"> sudo systemctl enable rpcbind</code><code data-key="thoughts-12637" data-type="code-block">sudo systemctl enable nfs</code><code data-key="thoughts-12638" data-type="code-block">#可选操作，如果开启了防火墙，则需要使用如下命令开放nfs相关服务的端口</code><code data-key="thoughts-12639" data-type="code-block">sudo firewall-cmd --zone=public --permanent --add-service={rpc-bind,mountd,nfs}</code><code data-key="thoughts-12640" data-type="code-block">sudo firewall-cmd --reload</code><code data-key="thoughts-12641" data-type="code-block"></code></pre><p data-key="63a129af35bfc93da39379a7" data-type="paragraph">nfs配置说明</p><ol data-key="thoughts-13694" data-type="ordered-list-wrapper"><li data-key="thoughts-12642" data-type="ordered-list-item"><code>/data</code>: 共享目录位置。</li><li data-key="thoughts-12643" data-type="ordered-list-item"><code>*</code>: 客户端 IP 范围<code>*</code> 代表所有，即没有限制。<code>192.168.0.0/24</code>客户端 IP 范围在192.168.0.0-192.168.255.255之间的ip可以访问</li><li data-key="thoughts-12644" data-type="ordered-list-item"><code>rw</code>: 权限设置，可读可写。</li><li data-key="thoughts-12645" data-type="ordered-list-item"><code>sync</code>: 同步共享目录。</li><li data-key="thoughts-12646" data-type="ordered-list-item"><code>no_root_squash</code>: 可以使用 root 授权。</li><li data-key="thoughts-12647" data-type="ordered-list-item"><code>no_all_squash</code>: 可以使用普通用户授权。</li></ol><p data-key="63a129af35bfc947eb9379a9" data-type="paragraph"></p><h3 data-key="63a129af35bfc970f19379aa" data-type="header-three">安装StorageClass使用nfs提供动态存储卷</h3><ul data-key="thoughts-13695" data-type="unordered-list-wrapper"><li data-key="thoughts-12648" data-type="unordered-list-item">说明：假设nfs安装在192.168.0.105主机上，以下创建nfs-storage.yaml文件,内容如下:</li></ul><pre data-key="63a129af35bfc9de5d9379ac" data-type="code-wrapper"><code data-key="thoughts-12649" data-type="code-block">---</code><code data-key="thoughts-12650" data-type="code-block">apiVersion: v1</code><code data-key="thoughts-12651" data-type="code-block">kind: ServiceAccount</code><code data-key="thoughts-12652" data-type="code-block">metadata:</code><code data-key="thoughts-12653" data-type="code-block">  name: nfs-provisioner</code><code data-key="thoughts-12654" data-type="code-block">---</code><code data-key="thoughts-12655" data-type="code-block">kind: ClusterRole</code><code data-key="thoughts-12656" data-type="code-block">apiVersion: rbac.authorization.k8s.io/v1</code><code data-key="thoughts-12657" data-type="code-block">metadata:</code><code data-key="thoughts-12658" data-type="code-block">  name: nfs-provisioner-runner</code><code data-key="thoughts-12659" data-type="code-block">rules:</code><code data-key="thoughts-12660" data-type="code-block">  -  apiGroups: [""]</code><code data-key="thoughts-12661" data-type="code-block">     resources: ["persistentvolumes"]</code><code data-key="thoughts-12662" data-type="code-block">     verbs: ["get", "list", "watch", "create", "delete"]</code><code data-key="thoughts-12663" data-type="code-block">  -  apiGroups: [""]</code><code data-key="thoughts-12664" data-type="code-block">     resources: ["persistentvolumeclaims"]</code><code data-key="thoughts-12665" data-type="code-block">     verbs: ["get", "list", "watch", "update"]</code><code data-key="thoughts-12666" data-type="code-block">  -  apiGroups: ["storage.k8s.io"]</code><code data-key="thoughts-12667" data-type="code-block">     resources: ["storageclasses"]</code><code data-key="thoughts-12668" data-type="code-block">     verbs: ["get", "list", "watch"]</code><code data-key="thoughts-12669" data-type="code-block">  -  apiGroups: [""]</code><code data-key="thoughts-12670" data-type="code-block">     resources: ["events"]</code><code data-key="thoughts-12671" data-type="code-block">     verbs: ["watch", "create", "update", "patch"]</code><code data-key="thoughts-12672" data-type="code-block">  -  apiGroups: [""]</code><code data-key="thoughts-12673" data-type="code-block">     resources: ["services", "endpoints"]</code><code data-key="thoughts-12674" data-type="code-block">     verbs: ["get","create","list", "watch","update"]</code><code data-key="thoughts-12675" data-type="code-block">  -  apiGroups: ["extensions"]</code><code data-key="thoughts-12676" data-type="code-block">     resources: ["podsecuritypolicies"]</code><code data-key="thoughts-12677" data-type="code-block">     resourceNames: ["nfs-provisioner"]</code><code data-key="thoughts-12678" data-type="code-block">     verbs: ["use"]</code><code data-key="thoughts-12679" data-type="code-block">---</code><code data-key="thoughts-12680" data-type="code-block">kind: ClusterRoleBinding</code><code data-key="thoughts-12681" data-type="code-block">apiVersion: rbac.authorization.k8s.io/v1</code><code data-key="thoughts-12682" data-type="code-block">metadata:</code><code data-key="thoughts-12683" data-type="code-block">  name: run-nfs-provisioner</code><code data-key="thoughts-12684" data-type="code-block">subjects:</code><code data-key="thoughts-12685" data-type="code-block">  - kind: ServiceAccount</code><code data-key="thoughts-12686" data-type="code-block">    name: nfs-provisioner</code><code data-key="thoughts-12687" data-type="code-block">    namespace: default</code><code data-key="thoughts-12688" data-type="code-block">roleRef:</code><code data-key="thoughts-12689" data-type="code-block">  kind: ClusterRole</code><code data-key="thoughts-12690" data-type="code-block">  name: nfs-provisioner-runner</code><code data-key="thoughts-12691" data-type="code-block">  apiGroup: rbac.authorization.k8s.io</code><code data-key="thoughts-12692" data-type="code-block">---</code><code data-key="thoughts-12693" data-type="code-block">kind: Deployment</code><code data-key="thoughts-12694" data-type="code-block">apiVersion: apps/v1</code><code data-key="thoughts-12695" data-type="code-block">metadata:</code><code data-key="thoughts-12696" data-type="code-block">  name: nfs-client-provisioner</code><code data-key="thoughts-12697" data-type="code-block">  # namespace: default</code><code data-key="thoughts-12698" data-type="code-block">  labels:</code><code data-key="thoughts-12699" data-type="code-block">    app: nfs-client-provisioner</code><code data-key="thoughts-12700" data-type="code-block">spec:</code><code data-key="thoughts-12701" data-type="code-block">  selector:</code><code data-key="thoughts-12702" data-type="code-block">    matchLabels:</code><code data-key="thoughts-12703" data-type="code-block">      app: nfs-client-provisioner</code><code data-key="thoughts-12704" data-type="code-block">  replicas: 1</code><code data-key="thoughts-12705" data-type="code-block">  strategy:</code><code data-key="thoughts-12706" data-type="code-block">    type: Recreate</code><code data-key="thoughts-12707" data-type="code-block">  template:</code><code data-key="thoughts-12708" data-type="code-block">    metadata:</code><code data-key="thoughts-12709" data-type="code-block">      labels:</code><code data-key="thoughts-12710" data-type="code-block">        app: nfs-client-provisioner</code><code data-key="thoughts-12711" data-type="code-block">    spec:</code><code data-key="thoughts-12712" data-type="code-block">      serviceAccountName: nfs-provisioner</code><code data-key="thoughts-12713" data-type="code-block">      containers:</code><code data-key="thoughts-12714" data-type="code-block">        -  name: nfs-client-provisioner</code><code data-key="thoughts-12715" data-type="code-block">           image: quay.io/external_storage/nfs-client-provisioner:v3.1.0-k8s1.11</code><code data-key="thoughts-12716" data-type="code-block">           volumeMounts:</code><code data-key="thoughts-12717" data-type="code-block">             -  name: nfs-client-root</code><code data-key="thoughts-12718" data-type="code-block">                mountPath:  /persistentvolumes</code><code data-key="thoughts-12719" data-type="code-block">           env:</code><code data-key="thoughts-12720" data-type="code-block">             -  name: PROVISIONER_NAME</code><code data-key="thoughts-12721" data-type="code-block">                value: fuseim.pri/nfs</code><code data-key="thoughts-12722" data-type="code-block">             -  name: NFS_SERVER</code><code data-key="thoughts-12723" data-type="code-block">                value:  192.168.0.105</code><code data-key="thoughts-12724" data-type="code-block">             -  name: NFS_PATH</code><code data-key="thoughts-12725" data-type="code-block">                value: /data/</code><code data-key="thoughts-12726" data-type="code-block">      volumes:</code><code data-key="thoughts-12727" data-type="code-block">        - name: nfs-client-root</code><code data-key="thoughts-12728" data-type="code-block">          nfs:</code><code data-key="thoughts-12729" data-type="code-block">            server:  192.168.0.105</code><code data-key="thoughts-12730" data-type="code-block">            path: /data/</code><code data-key="thoughts-12731" data-type="code-block">---</code><code data-key="thoughts-12732" data-type="code-block">apiVersion: storage.k8s.io/v1</code><code data-key="thoughts-12733" data-type="code-block">kind: StorageClass</code><code data-key="thoughts-12734" data-type="code-block">metadata:</code><code data-key="thoughts-12735" data-type="code-block">  name: nfs-storage</code><code data-key="thoughts-12736" data-type="code-block">  # namespace: default</code><code data-key="thoughts-12737" data-type="code-block">  annotations:</code><code data-key="thoughts-12738" data-type="code-block">    storageclass.kubernetes.io/is-default-class: true</code><code data-key="thoughts-12739" data-type="code-block"># 存储分配器，和PROVISIONER_NAME环境变量一直，其他可选值可以参看：https://kubernetes.io/zh/docs/concepts/storage/storage-classes/#%e4%bb%8b%e7%bb%8d</code><code data-key="thoughts-12740" data-type="code-block">provisioner: fuseim.pri/nfs</code><code data-key="thoughts-12741" data-type="code-block">reclaimPolicy: Retain</code><code data-key="thoughts-12742" data-type="code-block"></code></pre><ul data-key="thoughts-13696" data-type="unordered-list-wrapper"><li data-key="thoughts-12743" data-type="unordered-list-item">执行命令：</li></ul><pre data-key="63a129af35bfc909279379ae" data-type="code-wrapper"><code data-key="thoughts-12744" data-type="code-block">kubectl apply  -f nfs-storage.yaml</code></pre><p data-key="6374ac62ca6aa67bf5fbd6f5" data-type="paragraph">yaml说明：</p><blockquote data-key="63dcb1467de23ab939c7aeca" data-type="blockquote-wrapper"><p data-key="thoughts-12745" data-type="blockquote">1.创建了名称为nfs-provisioner的serviceAccount,</p><p data-key="thoughts-12746" data-type="blockquote">2.创建了名称为nfs-provisioner-runner的cluterRole，指定该角色的资源权限用于访问集群的pv和pvc，storageclasses等kubernetes资。</p><p data-key="thoughts-12747" data-type="blockquote">3.创建名称为run-nfs-provisioner的ClusterRoleBinding，用于绑定serviceaccount和clusterrole,将该nfs-provisioner-runner角色赋给nfs-provisioner的serviceAccount，使该sa可以访问改角色指定的资源</p><p data-key="thoughts-12748" data-type="blockquote">4.创建nfs-client-provisioner的deployment，运行nfs的客户端应用，挂载了nsf到pod内部的 /persistentvolumes目录，通过环境变量NFS_SERVER来指定nfs的服务器地址为192.168.0.105，NFS_PATH来指定nfs服务器路径为：/nfs，PROVISIONER_NAME指定一个名称用于绑定给StorageClass，由他该来提供nfs的动态存储给其他pod使用。</p><p data-key="thoughts-12749" data-type="blockquote">5.创建nfs-storage的StorageClass，通过provisioner指定的名称绑定具体的实际存储提供者。为pod提供动态的存储服务</p></blockquote><h1 data-key="63c5f035580c0d4a654e0b1f" data-type="header-one">安装jenkins</h1><h2 data-key="637590476fb273de45c0e0b1" data-type="header-two">安装jenkins应用</h2><p data-key="63758fde6fb273f9cac0e0ae" data-type="paragraph">使用了nfs动态存储卷提供存储服务，创建jenkins-master.yaml文件，内容如下：</p><pre data-key="637598b36fb273b3fec0e18b" data-type="code-wrapper"><code data-key="thoughts-12750" data-type="code-block">## 创建namespace</code><code data-key="thoughts-12751" data-type="code-block">---</code><code data-key="thoughts-12752" data-type="code-block">apiVersion: v1</code><code data-key="thoughts-12753" data-type="code-block">kind: Namespace</code><code data-key="thoughts-12754" data-type="code-block">metadata:</code><code data-key="thoughts-12755" data-type="code-block">  name: jenkins</code><code data-key="thoughts-12756" data-type="code-block">---</code><code data-key="thoughts-12757" data-type="code-block">##创建nfs-pvc</code><code data-key="thoughts-12758" data-type="code-block">apiVersion: v1</code><code data-key="thoughts-12759" data-type="code-block">kind: PersistentVolumeClaim</code><code data-key="thoughts-12760" data-type="code-block">metadata:</code><code data-key="thoughts-12761" data-type="code-block">  name: jenkins-pvc</code><code data-key="thoughts-12762" data-type="code-block">  namespace: jenkins</code><code data-key="thoughts-12763" data-type="code-block">spec:</code><code data-key="thoughts-12764" data-type="code-block">  # 引用指定的StorageClass</code><code data-key="thoughts-12765" data-type="code-block">  storageClassName: nfs-storage</code><code data-key="thoughts-12766" data-type="code-block">  accessModes:</code><code data-key="thoughts-12767" data-type="code-block">    - ReadWriteMany</code><code data-key="thoughts-12768" data-type="code-block">  resources:</code><code data-key="thoughts-12769" data-type="code-block">    requests:</code><code data-key="thoughts-12770" data-type="code-block">      storage: 1024Mi</code><code data-key="thoughts-12771" data-type="code-block">## namespace jenkins 的RBAC授权配置</code><code data-key="thoughts-12772" data-type="code-block">---</code><code data-key="thoughts-12773" data-type="code-block">apiVersion: v1</code><code data-key="thoughts-12774" data-type="code-block">kind: ServiceAccount</code><code data-key="thoughts-12775" data-type="code-block">metadata:</code><code data-key="thoughts-12776" data-type="code-block">  name: jenkins</code><code data-key="thoughts-12777" data-type="code-block">  namespace: jenkins</code><code data-key="thoughts-12778" data-type="code-block">---</code><code data-key="thoughts-12779" data-type="code-block">kind: Role</code><code data-key="thoughts-12780" data-type="code-block">apiVersion: rbac.authorization.k8s.io/v1</code><code data-key="thoughts-12781" data-type="code-block">metadata:</code><code data-key="thoughts-12782" data-type="code-block">  name: jenkins</code><code data-key="thoughts-12783" data-type="code-block">  namespace: jenkins</code><code data-key="thoughts-12784" data-type="code-block">rules:</code><code data-key="thoughts-12785" data-type="code-block">  - apiGroups: [""]</code><code data-key="thoughts-12786" data-type="code-block">    resources: ["pods"]</code><code data-key="thoughts-12787" data-type="code-block">    verbs: ["create","delete","get","list","patch","update","watch"]</code><code data-key="thoughts-12788" data-type="code-block">  - apiGroups: [""]</code><code data-key="thoughts-12789" data-type="code-block">    resources: ["pods/exec"]</code><code data-key="thoughts-12790" data-type="code-block">    verbs: ["create","delete","get","list","patch","update","watch"]</code><code data-key="thoughts-12791" data-type="code-block">  - apiGroups: [""]</code><code data-key="thoughts-12792" data-type="code-block">    resources: ["pods/log"]</code><code data-key="thoughts-12793" data-type="code-block">    verbs: ["get","list","watch"]</code><code data-key="thoughts-12794" data-type="code-block">  - apiGroups: [""]</code><code data-key="thoughts-12795" data-type="code-block">    resources: ["events"]</code><code data-key="thoughts-12796" data-type="code-block">    verbs: ["watch"]</code><code data-key="thoughts-12797" data-type="code-block">  - apiGroups: [""]</code><code data-key="thoughts-12798" data-type="code-block">    resources: ["secrets"]</code><code data-key="thoughts-12799" data-type="code-block">    verbs: ["get"]</code><code data-key="thoughts-12800" data-type="code-block">  - apiGroups: [""]</code><code data-key="thoughts-12801" data-type="code-block">    resources: ["configmap"]</code><code data-key="thoughts-12802" data-type="code-block">    verbs: ["get"]</code><code data-key="thoughts-12803" data-type="code-block"></code><code data-key="thoughts-12804" data-type="code-block">---</code><code data-key="thoughts-12805" data-type="code-block">apiVersion: rbac.authorization.k8s.io/v1</code><code data-key="thoughts-12806" data-type="code-block">kind: RoleBinding</code><code data-key="thoughts-12807" data-type="code-block">metadata:</code><code data-key="thoughts-12808" data-type="code-block">  name: jenkins</code><code data-key="thoughts-12809" data-type="code-block">  namespace: jenkins</code><code data-key="thoughts-12810" data-type="code-block">roleRef:</code><code data-key="thoughts-12811" data-type="code-block">  apiGroup: rbac.authorization.k8s.io</code><code data-key="thoughts-12812" data-type="code-block">  kind: Role</code><code data-key="thoughts-12813" data-type="code-block">  name: jenkins</code><code data-key="thoughts-12814" data-type="code-block">subjects:</code><code data-key="thoughts-12815" data-type="code-block">  - kind: ServiceAccount</code><code data-key="thoughts-12816" data-type="code-block">    name: jenkins</code><code data-key="thoughts-12817" data-type="code-block">---</code><code data-key="thoughts-12818" data-type="code-block">##创建jenkins master</code><code data-key="thoughts-12819" data-type="code-block">apiVersion:  apps/v1</code><code data-key="thoughts-12820" data-type="code-block">kind: Deployment</code><code data-key="thoughts-12821" data-type="code-block">metadata:</code><code data-key="thoughts-12822" data-type="code-block">  name: jenkins-master</code><code data-key="thoughts-12823" data-type="code-block">  namespace: jenkins</code><code data-key="thoughts-12824" data-type="code-block">spec:</code><code data-key="thoughts-12825" data-type="code-block">  replicas: 1</code><code data-key="thoughts-12826" data-type="code-block">  template:</code><code data-key="thoughts-12827" data-type="code-block">    metadata:</code><code data-key="thoughts-12828" data-type="code-block">      labels:</code><code data-key="thoughts-12829" data-type="code-block">        app: jenkins-master</code><code data-key="thoughts-12830" data-type="code-block">    spec:</code><code data-key="thoughts-12831" data-type="code-block">      # 指定serviceAccount，便于控制jenkins访问kubernetes集群的权限</code><code data-key="thoughts-12832" data-type="code-block">      serviceAccountName: jenkins</code><code data-key="thoughts-12833" data-type="code-block">      containers:</code><code data-key="thoughts-12834" data-type="code-block">        - name: jenkins-master</code><code data-key="thoughts-12835" data-type="code-block">          image: jenkins/jenkins:lts-alpine</code><code data-key="thoughts-12836" data-type="code-block">          imagePullPolicy: IfNotPresent</code><code data-key="thoughts-12837" data-type="code-block">          #        env:</code><code data-key="thoughts-12838" data-type="code-block">          #          - name: JAVA_OPTS</code><code data-key="thoughts-12839" data-type="code-block">          #            value: -Dhttp.proxyPort=1082 -Dhttp.proxyHost=192.168.0.109 -Dhttps.proxyPort=1082 -Dhttp.nonProxyHosts='localhost|127.0.0.1' -Dhttps.proxyHost=192.168.0.109 -Dhttps.nonProxyHosts='localhost|127.0.0.1'</code><code data-key="thoughts-12840" data-type="code-block">          volumeMounts:</code><code data-key="thoughts-12841" data-type="code-block">            - name: jenkins-home</code><code data-key="thoughts-12842" data-type="code-block">              mountPath: /var/jenkins_home</code><code data-key="thoughts-12843" data-type="code-block">          ports:</code><code data-key="thoughts-12844" data-type="code-block">            - containerPort: 8080</code><code data-key="thoughts-12845" data-type="code-block">              name: web</code><code data-key="thoughts-12846" data-type="code-block">            - containerPort: 50000</code><code data-key="thoughts-12847" data-type="code-block">              name: agent</code><code data-key="thoughts-12848" data-type="code-block">      volumes:</code><code data-key="thoughts-12849" data-type="code-block">        - name: jenkins-home</code><code data-key="thoughts-12850" data-type="code-block">          persistentVolumeClaim:</code><code data-key="thoughts-12851" data-type="code-block">            claimName: jenkins-pvc</code><code data-key="thoughts-12852" data-type="code-block">---</code><code data-key="thoughts-12853" data-type="code-block">apiVersion: v1</code><code data-key="thoughts-12854" data-type="code-block">kind: Service</code><code data-key="thoughts-12855" data-type="code-block">metadata:</code><code data-key="thoughts-12856" data-type="code-block">  name: jenkins-master-service</code><code data-key="thoughts-12857" data-type="code-block">  namespace: jenkins</code><code data-key="thoughts-12858" data-type="code-block">  labels:</code><code data-key="thoughts-12859" data-type="code-block">    name: jenkins-master</code><code data-key="thoughts-12860" data-type="code-block">spec:</code><code data-key="thoughts-12861" data-type="code-block">  type: ClusterIP</code><code data-key="thoughts-12862" data-type="code-block">  ports:</code><code data-key="thoughts-12863" data-type="code-block">    - port: 8080</code><code data-key="thoughts-12864" data-type="code-block">      name: web</code><code data-key="thoughts-12865" data-type="code-block">      targetPort: 8080</code><code data-key="thoughts-12866" data-type="code-block">    - port: 50000</code><code data-key="thoughts-12867" data-type="code-block">      name: agent</code><code data-key="thoughts-12868" data-type="code-block">      targetPort: 50000</code><code data-key="thoughts-12869" data-type="code-block">  selector:</code><code data-key="thoughts-12870" data-type="code-block">    app: jenkins-master</code><code data-key="thoughts-12871" data-type="code-block">---</code><code data-key="thoughts-12872" data-type="code-block">apiVersion: networking.k8s.io/v1beta1</code><code data-key="thoughts-12873" data-type="code-block">kind: Ingress</code><code data-key="thoughts-12874" data-type="code-block">metadata:</code><code data-key="thoughts-12875" data-type="code-block">  name: jenkins-master-ingress</code><code data-key="thoughts-12876" data-type="code-block">  namespace: jenkins</code><code data-key="thoughts-12877" data-type="code-block">spec:</code><code data-key="thoughts-12878" data-type="code-block">  rules:</code><code data-key="thoughts-12879" data-type="code-block">    # 将xxx.xxx.xxx修改成指定域名</code><code data-key="thoughts-12880" data-type="code-block">    - host: xxx.xxx.xxx</code><code data-key="thoughts-12881" data-type="code-block">      http:</code><code data-key="thoughts-12882" data-type="code-block">        paths:</code><code data-key="thoughts-12883" data-type="code-block">          - path: /</code><code data-key="thoughts-12884" data-type="code-block">            backend:</code><code data-key="thoughts-12885" data-type="code-block">              serviceName: jenkins-master-service</code><code data-key="thoughts-12886" data-type="code-block">              servicePort: 8080</code></pre><p data-key="637590246fb2734494c0e0b0" data-type="paragraph">yaml说明：</p><blockquote data-key="63dcb1697de23a6a11c7aecb" data-type="blockquote-wrapper"><p data-key="thoughts-12887" data-type="blockquote">1.创建jenkins-pvc，用于持久化存储jenkins的应用数据，防止重启后jenkins的数据丢失，通过storageClassName绑定使用那个动态存储卷提供持久化存储服务</p><p data-key="thoughts-12888" data-type="blockquote">2.创建名称为jenkins的namespace，用于将jenkins的相关service，deployment等等资源部署在该命名空间下</p><p data-key="thoughts-12889" data-type="blockquote">3.创建名称为jenkins的ServiceAccount，用于部署deployment时指定serviceAccont，这样deployment创建出来的pod就可以通过该serviceAccount方法kubernetes的资源</p><p data-key="thoughts-12890" data-type="blockquote">4.创建一个Role，权限只包含了访问kubernetes集群jenkins命名空间下的pod资源。</p><p data-key="thoughts-12891" data-type="blockquote">5.创建RoleBinding，用于给serviceAccount指定一个上面创建的角色，让jenkins可以访问kubernetes集群以动态的创建和销毁执行jenkins任务的pod</p><p data-key="thoughts-12892" data-type="blockquote">6.创建deployment，指定serviceAccountName为jenkins，让jenkins执行构建任务时会通过jenkins这个ServiceAccount身份操作kubernetes集群，在集群内生成一个pod作为jenkins agent节点执行任务</p><p data-key="thoughts-12893" data-type="blockquote">7.创建service，暴露8080和50000两个端口，8080是jenkins的web页面访问端口，50000是jnpl端口，用于slave节点连接到master节点的端口</p><p data-key="thoughts-12894" data-type="blockquote">8.创建ingress，用于向外提供访问域名，ingress host 的值“xxx.xxx.xxx”修改成自己的域名</p></blockquote><p data-key="63a12c4d35bfc9e7819379be" data-type="paragraph"></p><h2 data-key="6375a0ce6fb273fc07c0e269" data-type="header-two">安装并配置jenkins kubernetes插件</h2><h3 data-key="63c657b2ed6aa64104f8b394" data-type="header-three">安装</h3><p data-key="6375e4f4ca6aa657c3fbe076" data-type="paragraph"><span style="color: #333333"><span style="background: #FFFFFF">管理员账户登录 Jenkins Master 页面，点击 “系统管理” —&gt; “管理插件” —&gt; “可选插件” —&gt; “Kubernetes plugin” 勾选安装即可。</span></span></p><img data-key="63a12bee35bfc967499379bc" data-type="image" src="static3a12bee35bfc967499379bc.png" alt="image.png"><h3 data-key="6375e4d1ca6aa65c02fbe075" data-type="header-three">配置</h3><p data-key="63c657d5ed6aa60645f8b395" data-type="paragraph">点击"系统管理"-&gt;"节点管理"-&gt;"configure Clouds"-&gt;</p><img data-key="63c658fced6aa6dbaef8b39e" data-type="image" src="static3c658fced6aa6dbaef8b39e.png" alt="image.png"><img data-key="63c658b6ed6aa6ae12f8b39c" data-type="image" src="static3c658b6ed6aa6ae12f8b39c.png" alt="image.png"><p data-key="63c65988ed6aa642e2f8b3a2" data-type="paragraph">1.配置kubernetes集群地址</p><img data-key="63c65965ed6aa64f97f8b3a1" data-type="image" src="static3c65965ed6aa64f97f8b3a1.png" alt="image.png"><blockquote data-key="63c659abed6aa64fbbf8b3a3" data-type="blockquote-wrapper"><p data-key="thoughts-12895" data-type="blockquote">配置说明：</p><p data-key="thoughts-12896" data-type="blockquote">1.配置kubernetes集群地址，这里填写kubernetes.default。kubernetes集群在安装的时候都会在default命名空间下创建一个kubernetes的service，该service是kubernetes apiserver的服务，所以在集群内的任何pod都可以使用kubernetes.default来访问kubernetes集群的api。由于jenkins master部署在kubernetes内该，所以也jenkins master可以以serviceAccount指定的身份通过kubernetes.default这个服务名访问kubernetes的相关api。</p><p data-key="thoughts-12897" data-type="blockquote">2.在jenkins mster安装的那个步骤有访问权限相关配置和说明，所以kubernetes服务证书key这些我们可以不用再填写了</p><p data-key="thoughts-12898" data-type="blockquote">3.点击“连接测试”按钮，如果出现“<span style="color: #333333"><span style="background: #FFFFFF">Connected to Kubernetes v x.xx</span></span>”字样，则表示连接kubernetes集群成功</p></blockquote><img data-key="63c65d62ed6aa64825f8b3b0" data-type="image" src="static3c65d62ed6aa64825f8b3b0.png" alt="image.png"><blockquote data-key="63c65d85ed6aa6436af8b3b8" data-type="blockquote-wrapper"><p data-key="thoughts-12899" data-type="blockquote">1.jenkins地址：http://jenkins-master-service:8080,</p><p data-key="thoughts-12900" data-type="blockquote">说明：jenkins web服务的地址，在安装jenkins时为jenkins的web服务声明jenkins-master-service服务名。通过该服务名+端口号就可访问到jenkins </p><p data-key="thoughts-12901" data-type="blockquote">2.jenkins 通道： jenkins-master-service:5000</p><p data-key="thoughts-12902" data-type="blockquote">说明：用于jenkins的slave节点和jenkins master通信的地址</p></blockquote><h2 data-key="63c65d85ed6aa69d2bf8b3b9" data-type="header-two">安装jenkins 钉钉通知插件</h2><p data-key="6375e517ca6aa68f26fbe07d" data-type="paragraph">在群设置的-&gt;"智能群助手"-&gt;"添加机器人"-&gt;"自定义机器人"</p><img data-key="63c75dbfed6aa626a0f8b853" data-type="image" src="static3c75dbfed6aa626a0f8b853.png" alt="image.png"><img data-key="63c75e05ed6aa62a82f8b855" data-type="image" src="static3c75e05ed6aa62a82f8b855.png" alt="image.png"><img data-key="63c75e73ed6aa688bef8b859" data-type="image" src="static3c75e73ed6aa688bef8b859.png" alt="image.png"><img data-key="6375e594ca6aa61042fbe08c" data-type="image" src="static375e594ca6aa61042fbe08c.png" alt="image.png"><p data-key="63c75e91ed6aa6407af8b85a" data-type="paragraph">配置说明：</p><blockquote data-key="63c75f4aed6aa68d64f8b860" data-type="blockquote-wrapper"><p data-key="thoughts-12903" data-type="blockquote">在钉钉群设置中添加一个机器人，安全配置选择加签方式，最后会获得一个带access_token的webhook地址</p></blockquote><p data-key="63c76117ed6aa619edf8b86c" data-type="paragraph">在jenkins中安装钉钉插件：“系统管理”-&gt;“插件管理”搜索“Dindtalk”</p><img data-key="63c7680bed6aa6ebd3f8b8ac" data-type="image" src="static3c7680bed6aa6ebd3f8b8ac.png" alt="image.png"><p data-key="63c75e50ed6aa65161f8b858" data-type="paragraph">在jenkins的配置钉钉机器人：“系统管理”-&gt;"系统配置"-&gt;"钉钉"</p><img data-key="63c76117ed6aa68033f8b86e" data-type="image" src="static3c76117ed6aa68033f8b86e.png" alt="image.png"><blockquote data-key="63c7613aed6aa61f0ef8b870" data-type="blockquote-wrapper"><p data-key="thoughts-12904" data-type="blockquote">配置说明：</p><p data-key="thoughts-12905" data-type="blockquote">id：自定义字符串，机器人的唯一身份标识，后续需通过该id指定访问该机器人</p><p data-key="thoughts-12906" data-type="blockquote">名称：机器人名称</p><p data-key="thoughts-12907" data-type="blockquote"><span style="color: #333333"><span style="background: #FFFFFF">webhook： 钉钉webhook地址，在上面配置钉钉机器人时钉钉生成的带access_token的webhook地址</span></span></p><p data-key="thoughts-12908" data-type="blockquote">加密：消息加密字符串，在上面配置钉钉机器人时，选择“加签”方式，钉钉会生成一个加签用的“sec”开头的字符串，将该字符串填入当前选项</p></blockquote><p data-key="63c764b4ed6aa60b9ff8b897" data-type="paragraph"></p><h1 data-key="63c76004ed6aa6797df8b862" data-type="header-one">安装nexus</h1><p data-key="637f339b92d448bd51c6e58e" data-type="paragraph">详见<a data-key="thoughts-13697" data-type="LINK" href="https://thoughts.aliyun.com/workspaces/5f37778f55b90500238b43cb/docs/637f33d0e4178b00019890fa"><u>nexus安装配置教程</u></a></p><h1 data-key="6375afc56fb2731829c0e433" data-type="header-one">创建pipeline</h1><p data-key="63c8eb9f4f522b2ca1129491" data-type="paragraph">以下以java项目为例子的一个持续集成的时序图：</p><img data-key="63c8ef414f522b79141294ac" data-type="image" src="static3c8ef414f522b79141294ac.png" alt="持续集成时序图.png"><blockquote data-key="63dcb1eb7de23aaf4ac7af01" data-type="blockquote-wrapper"><p data-key="thoughts-12909" data-type="blockquote">说明：</p><p data-key="thoughts-12910" data-type="blockquote">万事开头难，所有应该尽量在满足持续集成的需求和配置复杂度之间取一个平衡点。</p><p data-key="thoughts-12911" data-type="blockquote">以上是经过团队的试错和磨合推敲出的一个可行的持续集成步骤。</p><p data-key="thoughts-12912" data-type="blockquote">1.持续集成的规约：</p><p data-key="thoughts-12913" data-type="blockquote">1.1 一个微服务一个源码仓库</p><p data-key="thoughts-12914" data-type="blockquote">1.2 配置也是代码的一部分，配置也要纳入版本管理</p><p data-key="thoughts-12915" data-type="blockquote">1.3 每个源码仓库包含2个分支，dev分支和master分支</p><p data-key="thoughts-12916" data-type="blockquote">1.4 产品严格按照功能优先级定义和开发，测试验收通过后的功能能马上发布生产环境，尽量避免功能做好了却不发布生产环境进行使用。（如果积累着测试完成的功能不发布也已经和持续集成目标相矛盾了）</p><p data-key="thoughts-12917" data-type="blockquote">1.5 合并master分支的代码必须是dev环境测试通过的的</p><p data-key="thoughts-12918" data-type="blockquote">1.6 单元测试必须覆盖所有public的方法</p><p data-key="thoughts-12919" data-type="blockquote">1.7  每天15点后必须将当天完成的某些功能添加/修改，bug修复的代码合并到master分支，如果合并master后部署失败，当天必须解决</p><p data-key="thoughts-12920" data-type="blockquote">1.8 提倡单个功能新增/修改或单个bug修复，提交dev构建测试完成后马上合并master进行测试环境的构建</p><p data-key="thoughts-12921" data-type="blockquote"></p><p data-key="thoughts-12922" data-type="blockquote">2.步骤说明：</p><p data-key="thoughts-12923" data-type="blockquote">一、所有开发人员在dev分支开发和push代码，开发人员尽量保证每次push代码需要是一次可发布的产品；</p><p data-key="thoughts-12924" data-type="blockquote">二、开发人员在dev push代码后，源码仓库将通过webhook的方式通知jenkins执行pipeline的一系列步骤，编译源码-&gt;单元测试-&gt;构建docker镜像（版本号为latest）-&gt;推送镜像到nexus私人docker仓库的-&gt;部署最新镜像到开发k8s集群</p><p data-key="thoughts-12925" data-type="blockquote">三、开发人员在开发环境自行验证相关功能正常后将代码合并到master分支</p><p data-key="thoughts-12926" data-type="blockquote">四、jenkins收到master分支push代码的webhook通知后执行pipeline：</p><p data-key="thoughts-12927" data-type="blockquote">编译源码-&gt;单元测试-&gt;构建docker镜像（版本号为此时源码的commit id）-&gt;推送该镜像到nexus私人docker仓库-&gt;部署最新镜像到测试k8s集群</p><p data-key="thoughts-12928" data-type="blockquote">五、通知测试人员对测试环境镜像测试</p><p data-key="thoughts-12929" data-type="blockquote">六、测试人员测试验收通过后，在源码仓库的master分支打上test-over标签。此标签类似记录了一个commit id</p><p data-key="thoughts-12930" data-type="blockquote">七、通知产品负责人确认是否部署到生产环境</p><p data-key="thoughts-12931" data-type="blockquote">八、得到确认后，相关人员对指定test-over标签再次进行打打release-vxxx的标签，并删除对应的test-over标签</p><p data-key="thoughts-12932" data-type="blockquote">九、jenkins收到master分支push代码的webhook通知后执行pipeline：拉取指定commit id对应的docker镜像-&gt;推送该镜像到生产环境docker仓库-&gt;部署最新镜像到生产k8s集群</p></blockquote><p data-key="63c8faa04f522b68a71294bc" data-type="paragraph"></p><h2 data-key="6375e82dca6aa6702efbe0a2" data-type="header-two">环境准备</h2><ul data-key="thoughts-13698" data-type="unordered-list-wrapper"><li data-key="thoughts-12933" data-type="unordered-list-item">配置jenkins命名空间的免密拉取镜像，用于jenkins slave pod执行时拉取特殊镜像</li><li data-key="thoughts-12934" data-type="unordered-list-item">准备maven仓库本地共享卷，用于在构建任务中缓存到maven本地仓库</li><li data-key="thoughts-12935" data-type="unordered-list-item">准备yarn缓存仓库本地共享卷，用于在构建任务中使用yarn缓存仓库</li><li data-key="thoughts-12936" data-type="unordered-list-item">准备docker的配置文件，用于docker in docker中推送和拉取镜像</li><li data-key="thoughts-12937" data-type="unordered-list-item">准备kubectl的配置文件，用于持续集成中操作对应的kubernetes集群，主要是部署应用到对应集群</li><li data-key="thoughts-12938" data-type="unordered-list-item">准备maven的setting.xml配置文件</li><li data-key="thoughts-12939" data-type="unordered-list-item">准备阿里云oss的client配置文件。流水线打包好的静态文件上传到阿里oss需要客户端配置交互凭证</li><li data-key="thoughts-12940" data-type="unordered-list-item">准备node modules文件夹压缩包存放目录本地共享卷，用于前端项目缓存node_modules文件夹</li></ul><h3 data-key="63d72016b2f847b8fa132c75" data-type="header-three">1.配置文件格式：</h3><pre data-key="63c904ba4f522b69a3129530" data-type="code-wrapper"><code data-key="thoughts-12941" data-type="code-block"># 一：创建docker.conf文件，内容如下：</code><code data-key="thoughts-12942" data-type="code-block">cat&gt;docker.conf&lt;&lt;EOF</code><code data-key="thoughts-12943" data-type="code-block">{"auths":</code><code data-key="thoughts-12944" data-type="code-block">    {</code><code data-key="thoughts-12945" data-type="code-block">        "registry.cn-shanghai.aliyuncs.com":</code><code data-key="thoughts-12946" data-type="code-block">        { </code><code data-key="thoughts-12947" data-type="code-block">            "auth":"YWRtaW46MTIzNDU2Cg=="</code><code data-key="thoughts-12948" data-type="code-block">        },</code><code data-key="thoughts-12949" data-type="code-block">        "registry-vpc.cn-shanghai.aliyuncs.com":</code><code data-key="thoughts-12950" data-type="code-block">        {</code><code data-key="thoughts-12951" data-type="code-block">            "auth":"YWRtaW46MTIzNDU2Cg=="</code><code data-key="thoughts-12952" data-type="code-block">        },</code><code data-key="thoughts-12953" data-type="code-block">        "docker-repo-dev.xxx.xxx":{</code><code data-key="thoughts-12954" data-type="code-block">            "auth": "YWRtaW46MTIzNDU2Cg=="</code><code data-key="thoughts-12955" data-type="code-block">        }</code><code data-key="thoughts-12956" data-type="code-block">    }</code><code data-key="thoughts-12957" data-type="code-block">}</code><code data-key="thoughts-12958" data-type="code-block">EOF</code><code data-key="thoughts-12959" data-type="code-block">#这里假设访问几个仓库的用户名是admin,密码是：123456，字符串"admin:123456"得到的base64编码就是：YWRtaW46MTIzNDU2Cg==</code><code data-key="thoughts-12960" data-type="code-block"># 二：对docker.conf文件镜像base64编码，得到base64字符串</code><code data-key="thoughts-12961" data-type="code-block">base64 docker.conf</code><code data-key="thoughts-12962" data-type="code-block">eyJhdXRocyI6CiAgICB7CiAgICAgICAgInJlZ2lzdHJ5LmNuLXNoYW5naGFpLmFsaXl1bmNzLmNv</code><code data-key="thoughts-12963" data-type="code-block">bSI6CiAgICAgICAgeyAKICAgICAgICAgICAgImF1dGgiOiJZV1J0YVc0Nk1USXpORFUyQ2c9PSIK</code><code data-key="thoughts-12964" data-type="code-block">ICAgICAgICB9LAogICAgICAgICJyZWdpc3RyeS12cGMuY24tc2hhbmdoYWkuYWxpeXVuY3MuY29t</code><code data-key="thoughts-12965" data-type="code-block">IjoKICAgICAgICB7CiAgICAgICAgICAgICJhdXRoIjoiWVdSdGFXNDZNVEl6TkRVMkNnPT0iCiAg</code><code data-key="thoughts-12966" data-type="code-block">ICAgICAgfSwKICAgICAgICAiZG9ja2VyLXJlcG8tZGV2Lnh4eC54eHgiOnsKICAgICAgICAgICAg</code><code data-key="thoughts-12967" data-type="code-block">ImF1dGgiOiAiWVdSdGFXNDZNVEl6TkRVMkNnPT0iCiAgICAgICAgfQogICAgfQp9Cg==</code><code data-key="thoughts-12968" data-type="code-block">#三：创建oss.conf文件，内容如下：</code><code data-key="thoughts-12969" data-type="code-block">cat&gt;oss.conf&lt;&lt;EOF</code><code data-key="thoughts-12970" data-type="code-block">[Credentials]</code><code data-key="thoughts-12971" data-type="code-block">language=CH</code><code data-key="thoughts-12972" data-type="code-block">accessKeyID=********</code><code data-key="thoughts-12973" data-type="code-block">accessKeySecret=******</code><code data-key="thoughts-12974" data-type="code-block">endpoint=oss-cn-shanghai.aliyuncs.com</code><code data-key="thoughts-12975" data-type="code-block">EOF</code><code data-key="thoughts-12976" data-type="code-block">#请将星号替换成具体的值</code><code data-key="thoughts-12977" data-type="code-block">#四：对oss.conf文件base64编码，得到字符串：</code><code data-key="thoughts-12978" data-type="code-block">base64 oss.conf</code><code data-key="thoughts-12979" data-type="code-block">W0NyZWRlbnRpYWxzXQpsYW5ndWFnZT1DSAphY2Nlc3NLZXlJRD0qKioqKioqKgphY2Nlc3NLZXlTZWNyZXQ9KioqKioqCmVuZHBvaW50PW9zcy1jbi1zaGFuZ2hhaS5hbGl5dW5jcy5jb20K</code></pre><h3 data-key="63d71fd0b2f8474e62132c72" data-type="header-three">2.将base64字符串用于创建的对应的config.yaml文件：</h3><pre data-key="63d71f44b2f8475532132c68" data-type="code-wrapper"><code data-key="thoughts-12980" data-type="code-block"># maven仓库本地共享卷</code><code data-key="thoughts-12981" data-type="code-block">apiVersion: v1</code><code data-key="thoughts-12982" data-type="code-block">kind: PersistentVolumeClaim</code><code data-key="thoughts-12983" data-type="code-block">metadata:</code><code data-key="thoughts-12984" data-type="code-block">  name: mvn-pvc</code><code data-key="thoughts-12985" data-type="code-block">  namespace: jenkins</code><code data-key="thoughts-12986" data-type="code-block">spec:</code><code data-key="thoughts-12987" data-type="code-block">  accessModes:</code><code data-key="thoughts-12988" data-type="code-block">    - ReadWriteMany</code><code data-key="thoughts-12989" data-type="code-block">  resources:</code><code data-key="thoughts-12990" data-type="code-block">    requests:</code><code data-key="thoughts-12991" data-type="code-block">      storage: 4Gi</code><code data-key="thoughts-12992" data-type="code-block">  storageClassName: nfs-storage</code><code data-key="thoughts-12993" data-type="code-block">---</code><code data-key="thoughts-12994" data-type="code-block"># node modules文件夹压缩包存放目录本地共享卷</code><code data-key="thoughts-12995" data-type="code-block">apiVersion: v1</code><code data-key="thoughts-12996" data-type="code-block">kind: PersistentVolumeClaim</code><code data-key="thoughts-12997" data-type="code-block">metadata:</code><code data-key="thoughts-12998" data-type="code-block">  name: node-modules-pvc</code><code data-key="thoughts-12999" data-type="code-block">  namespace: jenkins</code><code data-key="thoughts-13000" data-type="code-block">spec:</code><code data-key="thoughts-13001" data-type="code-block">  accessModes:</code><code data-key="thoughts-13002" data-type="code-block">    - ReadWriteMany</code><code data-key="thoughts-13003" data-type="code-block">  resources:</code><code data-key="thoughts-13004" data-type="code-block">    requests:</code><code data-key="thoughts-13005" data-type="code-block">      storage: 4Gi</code><code data-key="thoughts-13006" data-type="code-block">  storageClassName: nfs-storage</code><code data-key="thoughts-13007" data-type="code-block"></code><code data-key="thoughts-13008" data-type="code-block">---</code><code data-key="thoughts-13009" data-type="code-block"># yarn缓存仓库本地共享卷</code><code data-key="thoughts-13010" data-type="code-block">apiVersion: v1</code><code data-key="thoughts-13011" data-type="code-block">kind: PersistentVolumeClaim</code><code data-key="thoughts-13012" data-type="code-block">metadata:</code><code data-key="thoughts-13013" data-type="code-block">  name: yarn-cache-pvc</code><code data-key="thoughts-13014" data-type="code-block">  namespace: jenkins</code><code data-key="thoughts-13015" data-type="code-block">spec:</code><code data-key="thoughts-13016" data-type="code-block">  accessModes:</code><code data-key="thoughts-13017" data-type="code-block">    - ReadWriteMany</code><code data-key="thoughts-13018" data-type="code-block">  resources:</code><code data-key="thoughts-13019" data-type="code-block">    requests:</code><code data-key="thoughts-13020" data-type="code-block">      storage: 4Gi</code><code data-key="thoughts-13021" data-type="code-block">  storageClassName: nfs-storage</code><code data-key="thoughts-13022" data-type="code-block">---</code><code data-key="thoughts-13023" data-type="code-block">apiVersion: v1</code><code data-key="thoughts-13024" data-type="code-block">data:</code><code data-key="thoughts-13025" data-type="code-block">  .dockerconfigjson: eyJhdXRocyI6CiAgICB7CiAgICAgICAgInJlZ2lzdHJ5LmNuLXNoYW5naGFpLmFsaXl1bmNzLmNvbSI6CiAgICAgICAgeyAKICAgICAgICAgICAgImF1dGgiOiJZV1J0YVc0Nk1USXpORFUyQ2c9PSIKICAgICAgICB9LAogICAgICAgICJyZWdpc3RyeS12cGMuY24tc2hhbmdoYWkuYWxpeXVuY3MuY29tIjoKICAgICAgICB7CiAgICAgICAgICAgICJhdXRoIjoiWVdSdGFXNDZNVEl6TkRVMkNnPT0iCiAgICAgICAgfSwKICAgICAgICAiZG9ja2VyLXJlcG8tZGV2Lnh4eC54eHgiOnsKICAgICAgICAgICAgImF1dGgiOiAiWVdSdGFXNDZNVEl6TkRVMkNnPT0iCiAgICAgICAgfQogICAgfQp9Cg==</code><code data-key="thoughts-13026" data-type="code-block">kind: Secret</code><code data-key="thoughts-13027" data-type="code-block">metadata:</code><code data-key="thoughts-13028" data-type="code-block">  name: docker-secret</code><code data-key="thoughts-13029" data-type="code-block">  namespace: jenkins</code><code data-key="thoughts-13030" data-type="code-block">type: kubernetes.io/dockerconfigjson</code><code data-key="thoughts-13031" data-type="code-block">---</code><code data-key="thoughts-13032" data-type="code-block">apiVersion: v1</code><code data-key="thoughts-13033" data-type="code-block">data:</code><code data-key="thoughts-13034" data-type="code-block">  .ossutilconfig: W0NyZWRlbnRpYWxzXQpsYW5ndWFnZT1DSAphY2Nlc3NLZXlJRD0qKioqKioqKgphY2Nlc3NLZXlTZWNyZXQ9KioqKioqCmVuZHBvaW50PW9zcy1jbi1zaGFuZ2hhaS5hbGl5dW5jcy5jb20K</code><code data-key="thoughts-13035" data-type="code-block">kind: Secret</code><code data-key="thoughts-13036" data-type="code-block">metadata:</code><code data-key="thoughts-13037" data-type="code-block">  name: oss-config-secret</code><code data-key="thoughts-13038" data-type="code-block">  namespace: jenkins</code><code data-key="thoughts-13039" data-type="code-block">type: Opaque</code><code data-key="thoughts-13040" data-type="code-block">---</code><code data-key="thoughts-13041" data-type="code-block">apiVersion: v1</code><code data-key="thoughts-13042" data-type="code-block">data:</code><code data-key="thoughts-13043" data-type="code-block">  docker.config.json: |</code><code data-key="thoughts-13044" data-type="code-block">    {</code><code data-key="thoughts-13045" data-type="code-block">        "auths": {</code><code data-key="thoughts-13046" data-type="code-block">            "registry.cn-shanghai.aliyuncs.com":</code><code data-key="thoughts-13047" data-type="code-block">            {   </code><code data-key="thoughts-13048" data-type="code-block">                "auth":"YWRtaW46MTIzNDU2Cg=="</code><code data-key="thoughts-13049" data-type="code-block">            },</code><code data-key="thoughts-13050" data-type="code-block">            "registry-vpc.cn-shanghai.aliyuncs.com":</code><code data-key="thoughts-13051" data-type="code-block">            {</code><code data-key="thoughts-13052" data-type="code-block">                "auth":"YWRtaW46MTIzNDU2Cg=="</code><code data-key="thoughts-13053" data-type="code-block">            },</code><code data-key="thoughts-13054" data-type="code-block">            "https://docker-repo-dev.xxx.xxx/v1":{</code><code data-key="thoughts-13055" data-type="code-block">                "auth": "YWRtaW46MTIzNDU2Cg=="</code><code data-key="thoughts-13056" data-type="code-block">            },</code><code data-key="thoughts-13057" data-type="code-block">            "docker-repo-dev.xxx.xxx":{</code><code data-key="thoughts-13058" data-type="code-block">                "auth": "YWRtaW46MTIzNDU2Cg=="</code><code data-key="thoughts-13059" data-type="code-block">            },</code><code data-key="thoughts-13060" data-type="code-block">            "http://docker-public.nexus:80/v1/": {</code><code data-key="thoughts-13061" data-type="code-block">                "auth": "YWRtaW46MTIzNDU2Cg=="</code><code data-key="thoughts-13062" data-type="code-block">            },</code><code data-key="thoughts-13063" data-type="code-block">            "docker-public.nexus:80": {</code><code data-key="thoughts-13064" data-type="code-block">                "auth": "YWRtaW46MTIzNDU2Cg=="</code><code data-key="thoughts-13065" data-type="code-block">            },</code><code data-key="thoughts-13066" data-type="code-block">            "http://docker-private.nexus:80/v1/": {</code><code data-key="thoughts-13067" data-type="code-block">                "auth": "YWRtaW46MTIzNDU2Cg=="</code><code data-key="thoughts-13068" data-type="code-block">            },</code><code data-key="thoughts-13069" data-type="code-block">            "docker-private.nexus:80": {</code><code data-key="thoughts-13070" data-type="code-block">                "auth": "YWRtaW46MTIzNDU2Cg=="</code><code data-key="thoughts-13071" data-type="code-block">            }</code><code data-key="thoughts-13072" data-type="code-block">        }</code><code data-key="thoughts-13073" data-type="code-block">    }</code><code data-key="thoughts-13074" data-type="code-block">kind: ConfigMap</code><code data-key="thoughts-13075" data-type="code-block">metadata:</code><code data-key="thoughts-13076" data-type="code-block">  name: docker-config-json</code><code data-key="thoughts-13077" data-type="code-block">  namespace: jenkins</code><code data-key="thoughts-13078" data-type="code-block">---</code><code data-key="thoughts-13079" data-type="code-block">apiVersion: v1</code><code data-key="thoughts-13080" data-type="code-block">data:</code><code data-key="thoughts-13081" data-type="code-block">  settings.xml: |-</code><code data-key="thoughts-13082" data-type="code-block">    &lt;?xml version="1.0" encoding="UTF-8"?&gt;</code><code data-key="thoughts-13083" data-type="code-block">    &lt;settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"</code><code data-key="thoughts-13084" data-type="code-block">              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"</code><code data-key="thoughts-13085" data-type="code-block">              xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd"&gt;</code><code data-key="thoughts-13086" data-type="code-block">        &lt;localRepository&gt;/root/.m2/repository&lt;/localRepository&gt;</code><code data-key="thoughts-13087" data-type="code-block">        &lt;pluginGroups&gt;</code><code data-key="thoughts-13088" data-type="code-block">        &lt;/pluginGroups&gt;</code><code data-key="thoughts-13089" data-type="code-block">        &lt;proxies&gt;</code><code data-key="thoughts-13090" data-type="code-block">        &lt;/proxies&gt;</code><code data-key="thoughts-13091" data-type="code-block">        &lt;servers&gt;</code><code data-key="thoughts-13092" data-type="code-block">            &lt;server&gt;</code><code data-key="thoughts-13093" data-type="code-block">                &lt;id&gt;nexus-public&lt;/id&gt;</code><code data-key="thoughts-13094" data-type="code-block">                &lt;username&gt;admin&lt;/username&gt;</code><code data-key="thoughts-13095" data-type="code-block">                &lt;password&gt;123456&lt;/password&gt;</code><code data-key="thoughts-13096" data-type="code-block">            &lt;/server&gt;</code><code data-key="thoughts-13097" data-type="code-block">        &lt;/servers&gt;</code><code data-key="thoughts-13098" data-type="code-block">        &lt;mirrors&gt;</code><code data-key="thoughts-13099" data-type="code-block">            &lt;mirror&gt;</code><code data-key="thoughts-13100" data-type="code-block">                &lt;id&gt;nexus-public&lt;/id&gt;</code><code data-key="thoughts-13101" data-type="code-block">                &lt;name&gt;nexus repo&lt;/name&gt;</code><code data-key="thoughts-13102" data-type="code-block">                &lt;url&gt;http://nexus3.nexus/repository/maven-public/&lt;/url&gt;</code><code data-key="thoughts-13103" data-type="code-block">                &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;</code><code data-key="thoughts-13104" data-type="code-block">            &lt;/mirror&gt;</code><code data-key="thoughts-13105" data-type="code-block">        &lt;/mirrors&gt;</code><code data-key="thoughts-13106" data-type="code-block">        &lt;profiles&gt;</code><code data-key="thoughts-13107" data-type="code-block">            &lt;profile&gt;</code><code data-key="thoughts-13108" data-type="code-block">                &lt;id&gt;public&lt;/id&gt;</code><code data-key="thoughts-13109" data-type="code-block">                &lt;repositories&gt;</code><code data-key="thoughts-13110" data-type="code-block">                    &lt;repository&gt;</code><code data-key="thoughts-13111" data-type="code-block">                        &lt;id&gt;nexus-public&lt;/id&gt;</code><code data-key="thoughts-13112" data-type="code-block">                        &lt;name&gt;maven-public&lt;/name&gt;</code><code data-key="thoughts-13113" data-type="code-block">                        &lt;url&gt;http://nexus3.nexus/repository/maven-public&lt;/url&gt;</code><code data-key="thoughts-13114" data-type="code-block">                        &lt;releases&gt;</code><code data-key="thoughts-13115" data-type="code-block">                            &lt;enabled&gt;true&lt;/enabled&gt;</code><code data-key="thoughts-13116" data-type="code-block">                        &lt;/releases&gt;</code><code data-key="thoughts-13117" data-type="code-block">                        &lt;snapshots&gt;</code><code data-key="thoughts-13118" data-type="code-block">                            &lt;enabled&gt;true&lt;/enabled&gt;</code><code data-key="thoughts-13119" data-type="code-block">                        &lt;/snapshots&gt;</code><code data-key="thoughts-13120" data-type="code-block">                    &lt;/repository&gt;</code><code data-key="thoughts-13121" data-type="code-block">                &lt;/repositories&gt;</code><code data-key="thoughts-13122" data-type="code-block">                &lt;pluginRepositories&gt;</code><code data-key="thoughts-13123" data-type="code-block">                    &lt;pluginRepository&gt;</code><code data-key="thoughts-13124" data-type="code-block">                        &lt;id&gt;maven-public&lt;/id&gt;</code><code data-key="thoughts-13125" data-type="code-block">                        &lt;name&gt;maven-public&lt;/name&gt;</code><code data-key="thoughts-13126" data-type="code-block">                        &lt;url&gt;http://nexus3.nexus/repository/maven-public&lt;/url&gt;</code><code data-key="thoughts-13127" data-type="code-block">                    &lt;/pluginRepository&gt;</code><code data-key="thoughts-13128" data-type="code-block">                &lt;/pluginRepositories&gt;</code><code data-key="thoughts-13129" data-type="code-block">            &lt;/profile&gt;</code><code data-key="thoughts-13130" data-type="code-block">        &lt;/profiles&gt;</code><code data-key="thoughts-13131" data-type="code-block">        &lt;activeProfiles&gt;</code><code data-key="thoughts-13132" data-type="code-block">            &lt;activeProfile&gt;public&lt;/activeProfile&gt;</code><code data-key="thoughts-13133" data-type="code-block">        &lt;/activeProfiles&gt;</code><code data-key="thoughts-13134" data-type="code-block">    &lt;/settings&gt;</code><code data-key="thoughts-13135" data-type="code-block">kind: ConfigMap</code><code data-key="thoughts-13136" data-type="code-block">metadata:</code><code data-key="thoughts-13137" data-type="code-block">  name: maven-setting-xml</code><code data-key="thoughts-13138" data-type="code-block">  namespace: jenkins</code><code data-key="thoughts-13139" data-type="code-block">---</code><code data-key="thoughts-13140" data-type="code-block">apiVersion: v1</code><code data-key="thoughts-13141" data-type="code-block">data:</code><code data-key="thoughts-13142" data-type="code-block">  config: |-</code><code data-key="thoughts-13143" data-type="code-block">    apiVersion: v1</code><code data-key="thoughts-13144" data-type="code-block">    clusters:</code><code data-key="thoughts-13145" data-type="code-block">    - cluster:</code><code data-key="thoughts-13146" data-type="code-block">        certificate-authority-data: LS0tL***S0tLQo=</code><code data-key="thoughts-13147" data-type="code-block">        server: https://kubernetes.default</code><code data-key="thoughts-13148" data-type="code-block">      name: kubernetes</code><code data-key="thoughts-13149" data-type="code-block">    contexts:</code><code data-key="thoughts-13150" data-type="code-block">    - context:</code><code data-key="thoughts-13151" data-type="code-block">        cluster: kubernetes</code><code data-key="thoughts-13152" data-type="code-block">        user: kubernetes-admin</code><code data-key="thoughts-13153" data-type="code-block">      name: kubernetes-admin@kubernetes</code><code data-key="thoughts-13154" data-type="code-block">    current-context: kubernetes-admin@kubernetes</code><code data-key="thoughts-13155" data-type="code-block">    kind: Config</code><code data-key="thoughts-13156" data-type="code-block">    preferences: {}</code><code data-key="thoughts-13157" data-type="code-block">    users:</code><code data-key="thoughts-13158" data-type="code-block">    - name: kubernetes-admin</code><code data-key="thoughts-13159" data-type="code-block">      user:</code><code data-key="thoughts-13160" data-type="code-block">        client-certificate-data: LS0tLS1CRUd***LQo=</code><code data-key="thoughts-13161" data-type="code-block">        client-key-data: LS0t***LQo=</code><code data-key="thoughts-13162" data-type="code-block">kind: ConfigMap</code><code data-key="thoughts-13163" data-type="code-block">metadata:</code><code data-key="thoughts-13164" data-type="code-block">  name: kube-config</code><code data-key="thoughts-13165" data-type="code-block">  namespace: jenkins</code><code data-key="thoughts-13166" data-type="code-block">---</code><code data-key="thoughts-13167" data-type="code-block">apiVersion: v1</code><code data-key="thoughts-13168" data-type="code-block">data:</code><code data-key="thoughts-13169" data-type="code-block">  daemon.json: |-</code><code data-key="thoughts-13170" data-type="code-block">    {</code><code data-key="thoughts-13171" data-type="code-block">        "debug": true,</code><code data-key="thoughts-13172" data-type="code-block">        "registry-mirrors": ["https://docker-repo-dev.xxx.xxx"],</code><code data-key="thoughts-13173" data-type="code-block">        "insecure-registries": ["docker-public.nexus:80","docker-private.nexus:80" ]</code><code data-key="thoughts-13174" data-type="code-block">    }</code><code data-key="thoughts-13175" data-type="code-block">kind: ConfigMap</code><code data-key="thoughts-13176" data-type="code-block">metadata:</code><code data-key="thoughts-13177" data-type="code-block">  name: docker-daemon-json</code><code data-key="thoughts-13178" data-type="code-block">  namespace: jenkins</code><code data-key="thoughts-13179" data-type="code-block"></code></pre><h3 data-key="63d71f21b2f8470eaa132c66" data-type="header-three">3.执行命令：</h3><pre data-key="63d71fadb2f847b001132c70" data-type="code-wrapper"><code data-key="thoughts-13180" data-type="code-block">kubectl  apply -f  config.yaml -n jenkins</code></pre><h2 data-key="63d71f67b2f8473652132c6b" data-type="header-two">配置jenkins命名空间的免密拉取镜像，用于jenkins slave pod执行时拉取私有镜像仓库的镜像</h2><p data-key="63c8fb904f522b28dc1294ca" data-type="paragraph"><a data-key="thoughts-13699" data-type="LINK" href="https://thoughts.aliyun.com/workspaces/5f37778f55b90500238b43cb/docs/63bf6504e87e050001aeb61d"><u>kubernetes免密拉取镜像</u></a></p><h2 data-key="63c8fc304f522b22291294cb" data-type="header-two">创建jenkins pipeline</h2><p data-key="63c8fcdf4f522b68421294d2" data-type="paragraph">"dashboard"-&gt;"新建任务"</p><img data-key="63c8fe6a4f522b02261294da" data-type="image" src="static3c8fe6a4f522b02261294da.png" alt="image.png"><img data-key="63c8fe0b4f522b202e1294d9" data-type="image" src="static3c8fe0b4f522b202e1294d9.png" alt="image.png"><img data-key="63c8ff194f522b37061294df" data-type="image" src="static3c8ff194f522b37061294df.png" alt="image.png"><img data-key="63c8fef64f522ba32e1294de" data-type="image" src="static3c8fef64f522ba32e1294de.png" alt="image.png"><img data-key="63c8ff5f4f522b8bc41294e1" data-type="image" src="static3c8ff5f4f522b8bc41294e1.png" alt="image.png"><img data-key="63c8ff5f4f522b1b181294e2" data-type="image" src="static3c8ff5f4f522b1b181294e2.png" alt="image.png"><img data-key="63c8ffb94f522b425f1294e4" data-type="image" src="static3c8ffb94f522b425f1294e4.png" alt="image.png"><img data-key="63c8ffdc4f522b4b771294e8" data-type="image" src="static3c8ffdc4f522b4b771294e8.png" alt="image.png"><img data-key="63c900314f522bf62f1294eb" data-type="image" src="static3c900314f522bf62f1294eb.png" alt="image.png"><img data-key="63c901264f522b6cf91294fc" data-type="image" src="static3c901264f522b6cf91294fc.png" alt="image.png"><img data-key="63c902a84f522b04a5129507" data-type="image" src="static3c902a84f522b04a5129507.png" alt="image.png"><blockquote data-key="63c8fd484f522b8b4c1294d6" data-type="blockquote-wrapper"><p data-key="thoughts-13181" data-type="blockquote">新建一个名称为pbm-server的流水线任务</p><p data-key="thoughts-13182" data-type="blockquote">1.定义了两个手动构建参数，</p><p data-key="thoughts-13183" data-type="blockquote">2.定义了两个环境变量，从webhook通知的请求体中提取两个参数，赋值给对应的环境变量</p><p data-key="thoughts-13184" data-type="blockquote">3.配置webhook请求授权token</p><p data-key="thoughts-13185" data-type="blockquote">4.配置过滤需要监听的分支</p><p data-key="thoughts-13186" data-type="blockquote">5.配置源码仓库</p><p data-key="thoughts-13187" data-type="blockquote">6.配置构建时加载的源码分支</p></blockquote><h2 data-key="63c8fd254f522b400a1294d4" data-type="header-two">前端项目jenkinsfile</h2><p data-key="63d72250b2f8477dfc132c77" data-type="paragraph"></p><ul data-key="thoughts-13700" data-type="unordered-list-wrapper"><li data-key="thoughts-13188" data-type="unordered-list-item">在项目根目录创建Jenkinsfile文件，内容如下：</li></ul><pre data-key="637dce723f53732bc43e3efd" data-type="code-wrapper"><code data-key="thoughts-13189" data-type="code-block">#!/usr/bin/env groovy</code><code data-key="thoughts-13190" data-type="code-block">import java.text.SimpleDateFormat</code><code data-key="thoughts-13191" data-type="code-block"></code><code data-key="thoughts-13192" data-type="code-block">pipeline {</code><code data-key="thoughts-13193" data-type="code-block">    agent {</code><code data-key="thoughts-13194" data-type="code-block">        kubernetes {</code><code data-key="thoughts-13195" data-type="code-block">            yamlFile 'KubernetesPod.yaml'</code><code data-key="thoughts-13196" data-type="code-block">            workspaceVolume emptyDirWorkspaceVolume("memory": true)</code><code data-key="thoughts-13197" data-type="code-block">        }</code><code data-key="thoughts-13198" data-type="code-block">    }</code><code data-key="thoughts-13199" data-type="code-block">    environment {</code><code data-key="thoughts-13200" data-type="code-block">        DEPLOY_FOLDER_NAME='mp4agency-ui'</code><code data-key="thoughts-13201" data-type="code-block">        ACCESS_ADDR="http://192.168.1.33:8080/dev/${DEPLOY_FOLDER_NAME}/index.html"</code><code data-key="thoughts-13202" data-type="code-block">        OSS_bucket_4_test="kycic-site-test"</code><code data-key="thoughts-13203" data-type="code-block">        OSS_bucket_4_prod="kycic-site"</code><code data-key="thoughts-13204" data-type="code-block"></code><code data-key="thoughts-13205" data-type="code-block">    }</code><code data-key="thoughts-13206" data-type="code-block">    stages {</code><code data-key="thoughts-13207" data-type="code-block">        stage('npm install') {</code><code data-key="thoughts-13208" data-type="code-block">            steps {</code><code data-key="thoughts-13209" data-type="code-block">                script {</code><code data-key="thoughts-13210" data-type="code-block">                    env.PACKAGE_MD5 = sh (script: "md5sum -t package.json |awk '{print \$1}'", returnStdout: true).trim()</code><code data-key="thoughts-13211" data-type="code-block">                }</code><code data-key="thoughts-13212" data-type="code-block">                container('node') {</code><code data-key="thoughts-13213" data-type="code-block">                    sh '''</code><code data-key="thoughts-13214" data-type="code-block">                        if [ ! -f "/root/node-modules-zip/${DEPLOY_FOLDER_NAME}-${PACKAGE_MD5}.tar.gz" ]; then</code><code data-key="thoughts-13215" data-type="code-block">                            echo 'yarn install'</code><code data-key="thoughts-13216" data-type="code-block">                            yarn config list</code><code data-key="thoughts-13217" data-type="code-block">                            #删除代理</code><code data-key="thoughts-13218" data-type="code-block">                            yarn config delete proxy</code><code data-key="thoughts-13219" data-type="code-block">                            #更换淘宝镜像</code><code data-key="thoughts-13220" data-type="code-block">                            yarn config set registry https://registry.npm.taobao.org</code><code data-key="thoughts-13221" data-type="code-block">                            yarn install</code><code data-key="thoughts-13222" data-type="code-block">                            tar -zcf /root/node-modules-zip/${DEPLOY_FOLDER_NAME}-${PACKAGE_MD5}.tar.gz node_modules</code><code data-key="thoughts-13223" data-type="code-block">                            md5sum -t package.json&gt;/root/node-modules-zip/${DEPLOY_FOLDER_NAME}.md5sum</code><code data-key="thoughts-13224" data-type="code-block">                        else</code><code data-key="thoughts-13225" data-type="code-block">                            echo 'uzip node_modules'</code><code data-key="thoughts-13226" data-type="code-block">                            tar -zxf /root/node-modules-zip/${DEPLOY_FOLDER_NAME}-${PACKAGE_MD5}.tar.gz</code><code data-key="thoughts-13227" data-type="code-block">                        fi</code><code data-key="thoughts-13228" data-type="code-block">                    '''</code><code data-key="thoughts-13229" data-type="code-block">                }</code><code data-key="thoughts-13230" data-type="code-block">            }</code><code data-key="thoughts-13231" data-type="code-block">        }</code><code data-key="thoughts-13232" data-type="code-block">        stage('deploy-dev') {</code><code data-key="thoughts-13233" data-type="code-block">            when {</code><code data-key="thoughts-13234" data-type="code-block">                anyOf {</code><code data-key="thoughts-13235" data-type="code-block">                    environment name: 'gitlabTargetBranch', value: 'heads/dev'</code><code data-key="thoughts-13236" data-type="code-block">                }</code><code data-key="thoughts-13237" data-type="code-block">            }</code><code data-key="thoughts-13238" data-type="code-block">            steps {</code><code data-key="thoughts-13239" data-type="code-block">                container('node') {</code><code data-key="thoughts-13240" data-type="code-block">                    sh '''</code><code data-key="thoughts-13241" data-type="code-block">                      rm -rf dist &amp;&amp; \</code><code data-key="thoughts-13242" data-type="code-block">                       npm run build:dev</code><code data-key="thoughts-13243" data-type="code-block">                    '''</code><code data-key="thoughts-13244" data-type="code-block">                }</code><code data-key="thoughts-13245" data-type="code-block">                container('aliyun-tools') {</code><code data-key="thoughts-13246" data-type="code-block">                    sh '''</code><code data-key="thoughts-13247" data-type="code-block">                      ossutil64 rm -f -r oss://${OSS_bucket_4_test}/dev/${DEPLOY_FOLDER_NAME}/ --config-file=/root/.ossutilconfig &amp;&amp; \</code><code data-key="thoughts-13248" data-type="code-block">                      ossutil64 cp -r dist/ oss://${OSS_bucket_4_test}/dev/${DEPLOY_FOLDER_NAME} --config-file=/root/.ossutilconfig</code><code data-key="thoughts-13249" data-type="code-block">                    '''</code><code data-key="thoughts-13250" data-type="code-block">                }</code><code data-key="thoughts-13251" data-type="code-block">                script {</code><code data-key="thoughts-13252" data-type="code-block">                    ACCESS_ADDR = "http://192.168.1.33/dev/${DEPLOY_FOLDER_NAME}/index.html"</code><code data-key="thoughts-13253" data-type="code-block">                }</code><code data-key="thoughts-13254" data-type="code-block">            }</code><code data-key="thoughts-13255" data-type="code-block">        }</code><code data-key="thoughts-13256" data-type="code-block">        stage('deploy-test') {</code><code data-key="thoughts-13257" data-type="code-block">            when {</code><code data-key="thoughts-13258" data-type="code-block">                anyOf {</code><code data-key="thoughts-13259" data-type="code-block">                    environment name: 'gitlabTargetBranch', value: 'heads/master'</code><code data-key="thoughts-13260" data-type="code-block">                }</code><code data-key="thoughts-13261" data-type="code-block">            }</code><code data-key="thoughts-13262" data-type="code-block"></code><code data-key="thoughts-13263" data-type="code-block">            steps {</code><code data-key="thoughts-13264" data-type="code-block">                container('node') {</code><code data-key="thoughts-13265" data-type="code-block">                    sh '''</code><code data-key="thoughts-13266" data-type="code-block">                      rm -rf dist &amp;&amp; \</code><code data-key="thoughts-13267" data-type="code-block">                      npm run build:test</code><code data-key="thoughts-13268" data-type="code-block">                    '''</code><code data-key="thoughts-13269" data-type="code-block">                }</code><code data-key="thoughts-13270" data-type="code-block">                container('aliyun-tools') {</code><code data-key="thoughts-13271" data-type="code-block">                    sh '''</code><code data-key="thoughts-13272" data-type="code-block">                      ossutil64 rm -f -r oss://${OSS_bucket_4_test}/test/${DEPLOY_FOLDER_NAME}/ --config-file=/root/.ossutilconfig &amp;&amp; \</code><code data-key="thoughts-13273" data-type="code-block">                      ossutil64 cp -r dist/ oss://${OSS_bucket_4_test}/test/${DEPLOY_FOLDER_NAME} --config-file=/root/.ossutilconfig</code><code data-key="thoughts-13274" data-type="code-block">                    '''</code><code data-key="thoughts-13275" data-type="code-block">                }</code><code data-key="thoughts-13276" data-type="code-block">                script {</code><code data-key="thoughts-13277" data-type="code-block">                    ACCESS_ADDR = "http://192.168.1.33/test/${DEPLOY_FOLDER_NAME}/index.html"</code><code data-key="thoughts-13278" data-type="code-block">                }</code><code data-key="thoughts-13279" data-type="code-block">            }</code><code data-key="thoughts-13280" data-type="code-block">        }</code><code data-key="thoughts-13281" data-type="code-block">        stage('deploy-staging') {</code><code data-key="thoughts-13282" data-type="code-block">                    when {</code><code data-key="thoughts-13283" data-type="code-block">                        allOf {</code><code data-key="thoughts-13284" data-type="code-block">                            environment ignoreCase: true, name: 'gitlabActionType', value: 'TAG_PUSH'</code><code data-key="thoughts-13285" data-type="code-block">                            expression { return env.gitlabTargetBranch ==~ /tags\/staging-.*/ }</code><code data-key="thoughts-13286" data-type="code-block">                        }</code><code data-key="thoughts-13287" data-type="code-block">                    }</code><code data-key="thoughts-13288" data-type="code-block">                    steps {</code><code data-key="thoughts-13289" data-type="code-block">                        container('node') {</code><code data-key="thoughts-13290" data-type="code-block">                            sh '''</code><code data-key="thoughts-13291" data-type="code-block">                              rm -rf dist &amp;&amp; \</code><code data-key="thoughts-13292" data-type="code-block">                              npm run build:staging</code><code data-key="thoughts-13293" data-type="code-block">                            '''</code><code data-key="thoughts-13294" data-type="code-block">                        }</code><code data-key="thoughts-13295" data-type="code-block">                        container('aliyun-tools') {</code><code data-key="thoughts-13296" data-type="code-block">                            sh '''</code><code data-key="thoughts-13297" data-type="code-block">                              ossutil64 rm -f -r oss://${OSS_bucket_4_test}/staging/${DEPLOY_FOLDER_NAME}/ --config-file=/root/.ossutilconfig &amp;&amp; \</code><code data-key="thoughts-13298" data-type="code-block">                              ossutil64 cp -r dist/ oss://${OSS_bucket_4_test}/staging/${DEPLOY_FOLDER_NAME} --config-file=/root/.ossutilconfig</code><code data-key="thoughts-13299" data-type="code-block">                            '''</code><code data-key="thoughts-13300" data-type="code-block">                        }</code><code data-key="thoughts-13301" data-type="code-block">                        script {</code><code data-key="thoughts-13302" data-type="code-block">                            ACCESS_ADDR = "http://192.168.1.33/staging/${DEPLOY_FOLDER_NAME}/index.html"</code><code data-key="thoughts-13303" data-type="code-block">                        }</code><code data-key="thoughts-13304" data-type="code-block">                    }</code><code data-key="thoughts-13305" data-type="code-block">        }</code><code data-key="thoughts-13306" data-type="code-block">        stage('deploy-prod') {</code><code data-key="thoughts-13307" data-type="code-block">            when {</code><code data-key="thoughts-13308" data-type="code-block">                allOf {</code><code data-key="thoughts-13309" data-type="code-block">                    environment ignoreCase: true, name: 'gitlabActionType', value: 'TAG_PUSH'</code><code data-key="thoughts-13310" data-type="code-block">                    expression { return env.gitlabTargetBranch ==~ /tags\/release-.*/ }</code><code data-key="thoughts-13311" data-type="code-block">                }</code><code data-key="thoughts-13312" data-type="code-block">            }</code><code data-key="thoughts-13313" data-type="code-block">            steps {</code><code data-key="thoughts-13314" data-type="code-block">                container('node') {</code><code data-key="thoughts-13315" data-type="code-block">                    sh '''</code><code data-key="thoughts-13316" data-type="code-block">                      rm -rf dist &amp;&amp; \</code><code data-key="thoughts-13317" data-type="code-block">                      npm run build</code><code data-key="thoughts-13318" data-type="code-block">                    '''</code><code data-key="thoughts-13319" data-type="code-block">                }</code><code data-key="thoughts-13320" data-type="code-block">                container('aliyun-tools') {</code><code data-key="thoughts-13321" data-type="code-block">                    sh '''</code><code data-key="thoughts-13322" data-type="code-block">                      echo '备份目录：/prod/temp/${DEPLOY_FOLDER_NAME}-'`date +%Y%m%d%H%M` --config-file=/root/.ossutilconfig&amp;&amp; \</code><code data-key="thoughts-13323" data-type="code-block">                      ossutil64 cp -r oss://kyhk-site/prod/${DEPLOY_FOLDER_NAME} oss://kyhk-site/prod/temp/${DEPLOY_FOLDER_NAME}-`date +%Y%m%d%H%M`/ --config-file=/root/.ossutilconfig&amp;&amp; \</code><code data-key="thoughts-13324" data-type="code-block">                      ossutil64 rm -f -r oss://${OSS_bucket_4_prod}/prod/${DEPLOY_FOLDER_NAME}/ --config-file=/root/.ossutilconfig&amp;&amp; \</code><code data-key="thoughts-13325" data-type="code-block">                      ossutil64 cp -r dist/ oss://${OSS_bucket_4_prod}/prod/${DEPLOY_FOLDER_NAME} --config-file=/root/.ossutilconfig</code><code data-key="thoughts-13326" data-type="code-block">                    '''</code><code data-key="thoughts-13327" data-type="code-block">                }</code><code data-key="thoughts-13328" data-type="code-block">                script {</code><code data-key="thoughts-13329" data-type="code-block">                    ACCESS_ADDR = "http://192.168.1.33/prod/${DEPLOY_FOLDER_NAME}/index.html"</code><code data-key="thoughts-13330" data-type="code-block">                }</code><code data-key="thoughts-13331" data-type="code-block">            }</code><code data-key="thoughts-13332" data-type="code-block">        }</code><code data-key="thoughts-13333" data-type="code-block">    }</code><code data-key="thoughts-13334" data-type="code-block">    post {</code><code data-key="thoughts-13335" data-type="code-block">        success {</code><code data-key="thoughts-13336" data-type="code-block">            echo 'do somethings after success'</code><code data-key="thoughts-13337" data-type="code-block">            dingtalk (</code><code data-key="thoughts-13338" data-type="code-block">                    robot: '3fff9e6a',</code><code data-key="thoughts-13339" data-type="code-block">                    type: 'ACTION_CARD',</code><code data-key="thoughts-13340" data-type="code-block">                    text: [</code><code data-key="thoughts-13341" data-type="code-block">                            "# $JOB_NAME 构建成功",</code><code data-key="thoughts-13342" data-type="code-block">                            "# 页面链接：$ACCESS_ADDR",</code><code data-key="thoughts-13343" data-type="code-block">                            getChangeString()</code><code data-key="thoughts-13344" data-type="code-block">                    ],</code><code data-key="thoughts-13345" data-type="code-block">                    btns: [</code><code data-key="thoughts-13346" data-type="code-block">                            [</code><code data-key="thoughts-13347" data-type="code-block">                                    title: '查看详情',</code><code data-key="thoughts-13348" data-type="code-block">                                    actionUrl: blueOceanUrl()</code><code data-key="thoughts-13349" data-type="code-block">                            ],</code><code data-key="thoughts-13350" data-type="code-block">                            [</code><code data-key="thoughts-13351" data-type="code-block">                                    title: '访问地址',</code><code data-key="thoughts-13352" data-type="code-block">                                    actionUrl: "$ACCESS_ADDR"</code><code data-key="thoughts-13353" data-type="code-block">                            ]</code><code data-key="thoughts-13354" data-type="code-block">                    ],</code><code data-key="thoughts-13355" data-type="code-block">                    btnLayout: 'V',</code><code data-key="thoughts-13356" data-type="code-block">                    at: ["${env.gitlabUserName}",]</code><code data-key="thoughts-13357" data-type="code-block">            )</code><code data-key="thoughts-13358" data-type="code-block">        }</code><code data-key="thoughts-13359" data-type="code-block">        failure {</code><code data-key="thoughts-13360" data-type="code-block">            echo 'do somethings after failure'</code><code data-key="thoughts-13361" data-type="code-block">            dingtalk (</code><code data-key="thoughts-13362" data-type="code-block">                    robot: '3fff9e6a',</code><code data-key="thoughts-13363" data-type="code-block">                    type: 'ACTION_CARD',</code><code data-key="thoughts-13364" data-type="code-block">                    text: [</code><code data-key="thoughts-13365" data-type="code-block">                            "# $JOB_NAME 构建失败",</code><code data-key="thoughts-13366" data-type="code-block">                            getChangeString()</code><code data-key="thoughts-13367" data-type="code-block">                    ],</code><code data-key="thoughts-13368" data-type="code-block">                    btns: [</code><code data-key="thoughts-13369" data-type="code-block">                            [</code><code data-key="thoughts-13370" data-type="code-block">                                    title: '查看详情',</code><code data-key="thoughts-13371" data-type="code-block">                                    actionUrl: blueOceanUrl()</code><code data-key="thoughts-13372" data-type="code-block">                            ],</code><code data-key="thoughts-13373" data-type="code-block">                            [</code><code data-key="thoughts-13374" data-type="code-block">                                    title: '访问地址',</code><code data-key="thoughts-13375" data-type="code-block">                                    actionUrl: "$ACCESS_ADDR"</code><code data-key="thoughts-13376" data-type="code-block">                            ]</code><code data-key="thoughts-13377" data-type="code-block">                    ],</code><code data-key="thoughts-13378" data-type="code-block">                    btnLayout: 'V',</code><code data-key="thoughts-13379" data-type="code-block">                    at: ["${env.gitlabUserName}",]</code><code data-key="thoughts-13380" data-type="code-block">            )</code><code data-key="thoughts-13381" data-type="code-block">        }</code><code data-key="thoughts-13382" data-type="code-block">        always {</code><code data-key="thoughts-13383" data-type="code-block">            echo 'do somethings always'</code><code data-key="thoughts-13384" data-type="code-block">        }</code><code data-key="thoughts-13385" data-type="code-block">    }</code><code data-key="thoughts-13386" data-type="code-block">}</code><code data-key="thoughts-13387" data-type="code-block">@NonCPS</code><code data-key="thoughts-13388" data-type="code-block">def getChangeString() {</code><code data-key="thoughts-13389" data-type="code-block">    def MAX_MSG_LEN = 100</code><code data-key="thoughts-13390" data-type="code-block">    def changeString = ""</code><code data-key="thoughts-13391" data-type="code-block">    echo "Gathering SCM changes"</code><code data-key="thoughts-13392" data-type="code-block">    def duration = currentBuild.duration</code><code data-key="thoughts-13393" data-type="code-block">    def changeLogSets = currentBuild.changeSets</code><code data-key="thoughts-13394" data-type="code-block">    changeString+=" --- \n - 持续时间： ${duration/1000} s\n"</code><code data-key="thoughts-13395" data-type="code-block">    SimpleDateFormat f = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss")</code><code data-key="thoughts-13396" data-type="code-block">    for (int i = 0; i &lt; changeLogSets.size(); i++) {</code><code data-key="thoughts-13397" data-type="code-block">        def entries = changeLogSets[i].items</code><code data-key="thoughts-13398" data-type="code-block">        for (int j = 0; j &lt; entries.length; j++) {</code><code data-key="thoughts-13399" data-type="code-block">            def entry = entries[j]</code><code data-key="thoughts-13400" data-type="code-block">            def truncated_msg = entry.msg.take(MAX_MSG_LEN)</code><code data-key="thoughts-13401" data-type="code-block">            changeString += " - 提交内容：${truncated_msg}  \n - 提交人：${entry.author.displayName}\n"</code><code data-key="thoughts-13402" data-type="code-block">            def date=new Date(entry.timestamp)</code><code data-key="thoughts-13403" data-type="code-block">            def timeFormat=f.format(date)</code><code data-key="thoughts-13404" data-type="code-block">            changeString+=" - 时间：${timeFormat}\n"</code><code data-key="thoughts-13405" data-type="code-block">            for (int z = 0; z &lt; entry.affectedFiles.size(); z++) {</code><code data-key="thoughts-13406" data-type="code-block">                def affectedFile=entry.affectedFiles[z]</code><code data-key="thoughts-13407" data-type="code-block">                changeString+=" - 文件：${affectedFile.path} \n - 操作：${affectedFile.editType.name}\n"</code><code data-key="thoughts-13408" data-type="code-block">            }</code><code data-key="thoughts-13409" data-type="code-block">            changeString+="---\n"</code><code data-key="thoughts-13410" data-type="code-block">        }</code><code data-key="thoughts-13411" data-type="code-block">    }</code><code data-key="thoughts-13412" data-type="code-block">    if (!changeString) {</code><code data-key="thoughts-13413" data-type="code-block">        changeString = " - No new changes"</code><code data-key="thoughts-13414" data-type="code-block">    }</code><code data-key="thoughts-13415" data-type="code-block"></code><code data-key="thoughts-13416" data-type="code-block">    return changeString</code><code data-key="thoughts-13417" data-type="code-block">}</code><code data-key="thoughts-13418" data-type="code-block"></code><code data-key="thoughts-13419" data-type="code-block">def blueOceanUrl(){</code><code data-key="thoughts-13420" data-type="code-block">    def jobName=URLEncoder.encode("$JOB_NAME", "UTF-8")</code><code data-key="thoughts-13421" data-type="code-block">    def url="http://192.168.1.33:8080/blue/organizations/jenkins/${jobName}/detail/$JOB_BASE_NAME/$BUILD_NUMBER/pipeline"</code><code data-key="thoughts-13422" data-type="code-block">    return url</code><code data-key="thoughts-13423" data-type="code-block">}</code></pre><p data-key="6375c9d1db9b0645081be1d8" data-type="paragraph">在项目根目录下创建KubernetesPod.yaml，内容如下：</p><pre data-key="637dda713f53736fed3e3fd9" data-type="code-wrapper"><code data-key="thoughts-13424" data-type="code-block">apiVersion: v1</code><code data-key="thoughts-13425" data-type="code-block"></code><code data-key="thoughts-13426" data-type="code-block">kind: Pod</code><code data-key="thoughts-13427" data-type="code-block">metadata:</code><code data-key="thoughts-13428" data-type="code-block">  labels:</code><code data-key="thoughts-13429" data-type="code-block">    app: mp4agency-ui</code><code data-key="thoughts-13430" data-type="code-block">    name: mp4agency-ui</code><code data-key="thoughts-13431" data-type="code-block">spec:</code><code data-key="thoughts-13432" data-type="code-block">  containers:</code><code data-key="thoughts-13433" data-type="code-block">    - name: node</code><code data-key="thoughts-13434" data-type="code-block">      image: node:14</code><code data-key="thoughts-13435" data-type="code-block">      imagePullPolicy: IfNotPresent</code><code data-key="thoughts-13436" data-type="code-block">      command:</code><code data-key="thoughts-13437" data-type="code-block">        - cat</code><code data-key="thoughts-13438" data-type="code-block">      tty: true</code><code data-key="thoughts-13439" data-type="code-block">      volumeMounts:</code><code data-key="thoughts-13440" data-type="code-block">        - name: yarn-cache-repo</code><code data-key="thoughts-13441" data-type="code-block">          mountPath: /root/.cache/yarn</code><code data-key="thoughts-13442" data-type="code-block">        - mountPath: /root/node-modules-zip/</code><code data-key="thoughts-13443" data-type="code-block">          name: node-modules-pvc</code><code data-key="thoughts-13444" data-type="code-block">      resources:</code><code data-key="thoughts-13445" data-type="code-block">        requests:</code><code data-key="thoughts-13446" data-type="code-block">          cpu: 100m</code><code data-key="thoughts-13447" data-type="code-block">          memory: 512Mi</code><code data-key="thoughts-13448" data-type="code-block">    - name: aliyun-tools</code><code data-key="thoughts-13449" data-type="code-block">      image: nathanhuang/aliyun-tools:0.0.1</code><code data-key="thoughts-13450" data-type="code-block">      imagePullPolicy: IfNotPresent</code><code data-key="thoughts-13451" data-type="code-block">      command:</code><code data-key="thoughts-13452" data-type="code-block">        - cat</code><code data-key="thoughts-13453" data-type="code-block">      tty: true</code><code data-key="thoughts-13454" data-type="code-block">      volumeMounts:</code><code data-key="thoughts-13455" data-type="code-block">        - name: oss-config</code><code data-key="thoughts-13456" data-type="code-block">          mountPath: /root/.ossutilconfig</code><code data-key="thoughts-13457" data-type="code-block">          subPath: .ossutilconfig</code><code data-key="thoughts-13458" data-type="code-block">  volumes:</code><code data-key="thoughts-13459" data-type="code-block">    - name: yarn-cache-repo</code><code data-key="thoughts-13460" data-type="code-block">      persistentVolumeClaim:</code><code data-key="thoughts-13461" data-type="code-block">        claimName: yarn-cache-pvc</code><code data-key="thoughts-13462" data-type="code-block">    - name: oss-config</code><code data-key="thoughts-13463" data-type="code-block">      secret:</code><code data-key="thoughts-13464" data-type="code-block">        secretName: oss-config-secret</code><code data-key="thoughts-13465" data-type="code-block">    - name: node-modules-pvc</code><code data-key="thoughts-13466" data-type="code-block">      persistentVolumeClaim:</code><code data-key="thoughts-13467" data-type="code-block">        claimName: node-modules-pvc</code></pre><h3 data-key="637dda4e3f537371d83e3fd7" data-type="header-three">说明：</h3><blockquote data-key="63d7877d8456f63e5b9c8f26" data-type="blockquote-wrapper"><p data-key="thoughts-13468" data-type="blockquote">1、</p></blockquote><h3 data-key="63807d5dbaaa15e9cf732c62" data-type="header-three">优化点：</h3><p data-key="6380808cbaaa1551ef732ca9" data-type="paragraph">一、workspaceVolume emptyDirWorkspaceVolume("memory": true)可以让整个构建过程产生的文件在内存中进行。没有磁盘io，减轻服务器物理磁盘的压力。</p><p data-key="6380808cbaaa153905732caa" data-type="paragraph">二、对前端项目的package.json进行md5计算，判断该文件是否修改过，如果修改过则从新执行yarn install过程。将安装后的node_modelus文件夹进行压缩保存，保存的文件名称带上此次package.json计算出来的MD5值，名称格式如下：/root/node-modules-zip/${DEPLOY_FOLDER_NAME}-${PACKAGE_MD5}.tar.gz。下次再次构建此项目时，如果package.json文件没有变动过，则直接解压该文件，无需执行耗时的yarn install 过程。</p><p data-key="638081e5baaa15435d732cb9" data-type="paragraph">三、使用yarn install 替代npm install 让多个项目依赖同一个组件时可以复用缓存，加快前端安装过程。</p><p data-key="63808271baaa1548d6732cc5" data-type="paragraph">四、使用淘宝仓库镜像替代npm官方的仓库地址，提高前端项目第一次初始化的安装过程</p><p data-key="638082b7baaa15dce0732cc9" data-type="paragraph">五、使用阿里云oss作为静态网页的托管网站服务器，简化自建静态资源服务器的复杂度</p><h2 data-key="63807d3abaaa150f50732c61" data-type="header-two">后端项目jenkinsfile</h2><p data-key="6375c9d1db9b060c3b1be1d9" data-type="paragraph">在项目根目录创建Jenkinsfile文件，内容如下：</p><pre data-key="6375e4aeca6aa67671fbe072" data-type="code-wrapper"><code data-key="thoughts-13469" data-type="code-block">#!/usr/bin/env groovy</code><code data-key="thoughts-13470" data-type="code-block"></code><code data-key="thoughts-13471" data-type="code-block">pipeline {</code><code data-key="thoughts-13472" data-type="code-block">    agent {</code><code data-key="thoughts-13473" data-type="code-block">        kubernetes {</code><code data-key="thoughts-13474" data-type="code-block">            yamlFile 'KubernetesPod.yaml'</code><code data-key="thoughts-13475" data-type="code-block">            workspaceVolume emptyDirWorkspaceVolume("memory": true)</code><code data-key="thoughts-13476" data-type="code-block">        }</code><code data-key="thoughts-13477" data-type="code-block">    }</code><code data-key="thoughts-13478" data-type="code-block">    environment {</code><code data-key="thoughts-13479" data-type="code-block"></code><code data-key="thoughts-13480" data-type="code-block">        WORK_DIR = "."</code><code data-key="thoughts-13481" data-type="code-block">        SVC_NAME = "sensitive-words"</code><code data-key="thoughts-13482" data-type="code-block">        DEV_DEPLOY_DIR = "kustomize/overlays/dev/${SVC_NAME}"</code><code data-key="thoughts-13483" data-type="code-block">        TEST_DEPLOY_DIR = "kustomize/overlays/dev/${SVC_NAME}"</code><code data-key="thoughts-13484" data-type="code-block"></code><code data-key="thoughts-13485" data-type="code-block">        IMAGE_NAME = "sensitive-words"</code><code data-key="thoughts-13486" data-type="code-block">        DEPLOYMENT_NAME = "sensitive-words"</code><code data-key="thoughts-13487" data-type="code-block">        DOCKER_REG = "docker-private.nexus:80"</code><code data-key="thoughts-13488" data-type="code-block">        //docker镜像完整路径名</code><code data-key="thoughts-13489" data-type="code-block">        IMG_FULL_NAME = "${DOCKER_REG}/app/${IMAGE_NAME}"</code><code data-key="thoughts-13490" data-type="code-block">		//一般有一个内网镜像地址，和公网可访问的镜像地址，一般使用公网作为默认镜像地址，</code><code data-key="thoughts-13491" data-type="code-block">        SOURCE_IMG_NAME = "public.xxx.xxx/app/${IMAGE_NAME}"</code><code data-key="thoughts-13492" data-type="code-block">        //发布正式环境时，一般使用内网镜像地址可以加快镜像拉取速度，</code><code data-key="thoughts-13493" data-type="code-block">        TAG_IMG_NAME = "private.xxx.xxx/app/${IMAGE_NAME}"</code><code data-key="thoughts-13494" data-type="code-block">    }</code><code data-key="thoughts-13495" data-type="code-block">    stages {</code><code data-key="thoughts-13496" data-type="code-block">        stage('init build evn') {</code><code data-key="thoughts-13497" data-type="code-block">            steps {</code><code data-key="thoughts-13498" data-type="code-block">                script {</code><code data-key="thoughts-13499" data-type="code-block">                    env.imageTag = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()</code><code data-key="thoughts-13500" data-type="code-block">                    env.gitCommitId = sh(script: 'git rev-parse HEAD', returnStdout: true).trim()</code><code data-key="thoughts-13501" data-type="code-block">                }</code><code data-key="thoughts-13502" data-type="code-block">                container('docker') {</code><code data-key="thoughts-13503" data-type="code-block">                    sh '''</code><code data-key="thoughts-13504" data-type="code-block">                        mkdir ~/.docker</code><code data-key="thoughts-13505" data-type="code-block">                        cp /etc/docker/docker.config.json ~/.docker/config.json</code><code data-key="thoughts-13506" data-type="code-block">                        docker login ${DOCKER_REG}</code><code data-key="thoughts-13507" data-type="code-block">                       '''</code><code data-key="thoughts-13508" data-type="code-block">                }</code><code data-key="thoughts-13509" data-type="code-block">            }</code><code data-key="thoughts-13510" data-type="code-block">        }</code><code data-key="thoughts-13511" data-type="code-block">        stage('build sensitive-words') {</code><code data-key="thoughts-13512" data-type="code-block">            steps {</code><code data-key="thoughts-13513" data-type="code-block">                container('maven') {</code><code data-key="thoughts-13514" data-type="code-block">                    sh 'mvn package'</code><code data-key="thoughts-13515" data-type="code-block">                }</code><code data-key="thoughts-13516" data-type="code-block">                container('docker') {</code><code data-key="thoughts-13517" data-type="code-block">                    sh '''</code><code data-key="thoughts-13518" data-type="code-block">                        echo "imageTag:"${imageTag}";gitCommitId:"${gitCommitId}</code><code data-key="thoughts-13519" data-type="code-block">                        cd ${WORK_DIR}</code><code data-key="thoughts-13520" data-type="code-block">                        docker build --cache-from=${IMG_FULL_NAME}:latest -t ${IMG_FULL_NAME}:latest .</code><code data-key="thoughts-13521" data-type="code-block">                        docker push ${IMG_FULL_NAME}:latest</code><code data-key="thoughts-13522" data-type="code-block">                       '''</code><code data-key="thoughts-13523" data-type="code-block">                }</code><code data-key="thoughts-13524" data-type="code-block">            }</code><code data-key="thoughts-13525" data-type="code-block">        }</code><code data-key="thoughts-13526" data-type="code-block">        stage('deploy-dev') {</code><code data-key="thoughts-13527" data-type="code-block">            when {</code><code data-key="thoughts-13528" data-type="code-block">                anyOf {</code><code data-key="thoughts-13529" data-type="code-block">                    environment name: 'gitlabTargetBranch', value: 'heads/dev'</code><code data-key="thoughts-13530" data-type="code-block">                }</code><code data-key="thoughts-13531" data-type="code-block">            }</code><code data-key="thoughts-13532" data-type="code-block">            steps {</code><code data-key="thoughts-13533" data-type="code-block">                container('kubetools') {</code><code data-key="thoughts-13534" data-type="code-block"></code><code data-key="thoughts-13535" data-type="code-block">                    sh '''</code><code data-key="thoughts-13536" data-type="code-block">                         cd ${DEV_DEPLOY_DIR}</code><code data-key="thoughts-13537" data-type="code-block">                         kustomize edit add annotation git-version:${gitCommitId}</code><code data-key="thoughts-13538" data-type="code-block">                         kustomize build .</code><code data-key="thoughts-13539" data-type="code-block">                         kustomize build . | kubectl apply -n dev-sensitive-words -f-</code><code data-key="thoughts-13540" data-type="code-block">                         kubectl rollout status deployment ${DEPLOYMENT_NAME} -n dev-sensitive-words</code><code data-key="thoughts-13541" data-type="code-block">                       '''</code><code data-key="thoughts-13542" data-type="code-block">                }</code><code data-key="thoughts-13543" data-type="code-block">            }</code><code data-key="thoughts-13544" data-type="code-block">        }</code><code data-key="thoughts-13545" data-type="code-block">        stage('deploy-test') {</code><code data-key="thoughts-13546" data-type="code-block">            when {</code><code data-key="thoughts-13547" data-type="code-block">                anyOf {</code><code data-key="thoughts-13548" data-type="code-block">                    environment name: 'gitlabTargetBranch', value: 'heads/master'</code><code data-key="thoughts-13549" data-type="code-block">                }</code><code data-key="thoughts-13550" data-type="code-block">            }</code><code data-key="thoughts-13551" data-type="code-block">            steps {</code><code data-key="thoughts-13552" data-type="code-block"></code><code data-key="thoughts-13553" data-type="code-block">                container('docker') {</code><code data-key="thoughts-13554" data-type="code-block">                    sh '''</code><code data-key="thoughts-13555" data-type="code-block">                        docker tag ${IMG_FULL_NAME}:latest ${IMG_FULL_NAME}:${imageTag}-test</code><code data-key="thoughts-13556" data-type="code-block">                        docker push ${IMG_FULL_NAME}:${imageTag}-test</code><code data-key="thoughts-13557" data-type="code-block">                       '''</code><code data-key="thoughts-13558" data-type="code-block">                }</code><code data-key="thoughts-13559" data-type="code-block">                container('kubetools') {</code><code data-key="thoughts-13560" data-type="code-block"></code><code data-key="thoughts-13561" data-type="code-block">                    sh '''</code><code data-key="thoughts-13562" data-type="code-block">                         cd ${TEST_DEPLOY_DIR}</code><code data-key="thoughts-13563" data-type="code-block">                         kustomize edit set image ${SOURCE_IMG_NAME}=${TAG_IMG_NAME}:${imageTag}-test</code><code data-key="thoughts-13564" data-type="code-block">                         kustomize build .</code><code data-key="thoughts-13565" data-type="code-block">                         kustomize build . | kubectl apply -n test-sensitive-words -f-</code><code data-key="thoughts-13566" data-type="code-block">                         kubectl rollout status deployment ${DEPLOYMENT_NAME} -n test-sensitive-words --timeout=300s</code><code data-key="thoughts-13567" data-type="code-block">                       '''</code><code data-key="thoughts-13568" data-type="code-block">                }</code><code data-key="thoughts-13569" data-type="code-block">            }</code><code data-key="thoughts-13570" data-type="code-block">        }</code><code data-key="thoughts-13571" data-type="code-block">        stage('deploy-prod') {</code><code data-key="thoughts-13572" data-type="code-block">            when {</code><code data-key="thoughts-13573" data-type="code-block">                allOf {</code><code data-key="thoughts-13574" data-type="code-block">                    environment ignoreCase: true, name: 'gitlabActionType', value: 'TAG_PUSH'</code><code data-key="thoughts-13575" data-type="code-block">                    expression { return env.gitlabTargetBranch ==~ /tags\/release-.*/ }</code><code data-key="thoughts-13576" data-type="code-block">                }</code><code data-key="thoughts-13577" data-type="code-block">            }</code><code data-key="thoughts-13578" data-type="code-block">            steps {</code><code data-key="thoughts-13579" data-type="code-block">                container('docker') {</code><code data-key="thoughts-13580" data-type="code-block">                    sh '''</code><code data-key="thoughts-13581" data-type="code-block">                        docker pull ${IMG_FULL_NAME}:${imageTag}</code><code data-key="thoughts-13582" data-type="code-block">                        docker tag ${IMG_FULL_NAME}:${imageTag} ${IMG_FULL_NAME_ALIYUN}:${imageTag}</code><code data-key="thoughts-13583" data-type="code-block">                        docker login ${DOCKER_REG_ALIYUN}</code><code data-key="thoughts-13584" data-type="code-block">                        docker push ${IMG_FULL_NAME_ALIYUN}:${imageTag}</code><code data-key="thoughts-13585" data-type="code-block">                       '''</code><code data-key="thoughts-13586" data-type="code-block">                }</code><code data-key="thoughts-13587" data-type="code-block">                container('kubetools') {</code><code data-key="thoughts-13588" data-type="code-block">                    sh '''</code><code data-key="thoughts-13589" data-type="code-block">                         cd ${PROD_DEPLOY_DIR}</code><code data-key="thoughts-13590" data-type="code-block">                         kustomize edit set image ${IMG_FULL_NAME_ALIYUN}=${IMG_FULL_NAME_ALIYUN}:${imageTag}</code><code data-key="thoughts-13591" data-type="code-block">                         kustomize build . &gt;target.yaml</code><code data-key="thoughts-13592" data-type="code-block">                       '''</code><code data-key="thoughts-13593" data-type="code-block">                }</code><code data-key="thoughts-13594" data-type="code-block">                container('huawei-tools') {</code><code data-key="thoughts-13595" data-type="code-block">                    sh '''</code><code data-key="thoughts-13596" data-type="code-block">                         cd ${PROD_DEPLOY_DIR}</code><code data-key="thoughts-13597" data-type="code-block">                         cat target.yaml</code><code data-key="thoughts-13598" data-type="code-block">                         kubectl apply -n nfkyows -f target.yaml</code><code data-key="thoughts-13599" data-type="code-block">                         kubectl rollout status deployment keyu-ows -n nfkyows</code><code data-key="thoughts-13600" data-type="code-block">                       '''</code><code data-key="thoughts-13601" data-type="code-block">                }</code><code data-key="thoughts-13602" data-type="code-block">                script {</code><code data-key="thoughts-13603" data-type="code-block">                    ACCESS_ADDR="https://nfkyows-admin-ui.haokangbao.cn"</code><code data-key="thoughts-13604" data-type="code-block">                }</code><code data-key="thoughts-13605" data-type="code-block">            }</code><code data-key="thoughts-13606" data-type="code-block">        }</code><code data-key="thoughts-13607" data-type="code-block">    }</code><code data-key="thoughts-13608" data-type="code-block">    post {</code><code data-key="thoughts-13609" data-type="code-block">        success {</code><code data-key="thoughts-13610" data-type="code-block">            echo 'do somethings after success'</code><code data-key="thoughts-13611" data-type="code-block">            dingtalk(</code><code data-key="thoughts-13612" data-type="code-block">                    robot: '3fff9e6a-devops',</code><code data-key="thoughts-13613" data-type="code-block">                    type: 'TEXT',</code><code data-key="thoughts-13614" data-type="code-block">                    title: 'build success',</code><code data-key="thoughts-13615" data-type="code-block">                    text: ["$SVC_NAME build success"],</code><code data-key="thoughts-13616" data-type="code-block">            )</code><code data-key="thoughts-13617" data-type="code-block">        }</code><code data-key="thoughts-13618" data-type="code-block">        failure {</code><code data-key="thoughts-13619" data-type="code-block">            echo 'do somethings after failure'</code><code data-key="thoughts-13620" data-type="code-block">            dingtalk(</code><code data-key="thoughts-13621" data-type="code-block">                    robot: '3fff9e6a-devops',</code><code data-key="thoughts-13622" data-type="code-block">                    type: 'TEXT',</code><code data-key="thoughts-13623" data-type="code-block">                    title: 'build success',</code><code data-key="thoughts-13624" data-type="code-block">                    text: ["$SVC_NAME build success"],</code><code data-key="thoughts-13625" data-type="code-block">            )</code><code data-key="thoughts-13626" data-type="code-block">        }</code><code data-key="thoughts-13627" data-type="code-block">        always {</code><code data-key="thoughts-13628" data-type="code-block">            echo 'do somethings always'</code><code data-key="thoughts-13629" data-type="code-block">        }</code><code data-key="thoughts-13630" data-type="code-block">    }</code><code data-key="thoughts-13631" data-type="code-block">}</code><code data-key="thoughts-13632" data-type="code-block"></code></pre><p data-key="6375e4aeca6aa6970efbe073" data-type="paragraph">在项目根目录下创建KubernetesPod.yaml，内容如下：</p><pre data-key="6375e73dca6aa6a381fbe093" data-type="code-wrapper"><code data-key="thoughts-13633" data-type="code-block">apiVersion: v1</code><code data-key="thoughts-13634" data-type="code-block">kind: Pod</code><code data-key="thoughts-13635" data-type="code-block">metadata:</code><code data-key="thoughts-13636" data-type="code-block">  labels:</code><code data-key="thoughts-13637" data-type="code-block">    app: sensitive-words-ci</code><code data-key="thoughts-13638" data-type="code-block">spec:</code><code data-key="thoughts-13639" data-type="code-block">  containers:</code><code data-key="thoughts-13640" data-type="code-block">    - name: maven</code><code data-key="thoughts-13641" data-type="code-block">      image: maven:alpine</code><code data-key="thoughts-13642" data-type="code-block">      command:</code><code data-key="thoughts-13643" data-type="code-block">        - cat</code><code data-key="thoughts-13644" data-type="code-block">      tty: true</code><code data-key="thoughts-13645" data-type="code-block">      volumeMounts:</code><code data-key="thoughts-13646" data-type="code-block">        - name: maven-repo</code><code data-key="thoughts-13647" data-type="code-block">          mountPath: /root/.m2/repository</code><code data-key="thoughts-13648" data-type="code-block">          subPath: repository</code><code data-key="thoughts-13649" data-type="code-block">        - name: maven-setting-xml</code><code data-key="thoughts-13650" data-type="code-block">          mountPath: /root/.m2/settings.xml</code><code data-key="thoughts-13651" data-type="code-block">          subPath: settings.xml</code><code data-key="thoughts-13652" data-type="code-block">    - name: newman</code><code data-key="thoughts-13653" data-type="code-block">      image: postman/newman:5-alpine</code><code data-key="thoughts-13654" data-type="code-block">      command:</code><code data-key="thoughts-13655" data-type="code-block">        - cat</code><code data-key="thoughts-13656" data-type="code-block">      tty: true</code><code data-key="thoughts-13657" data-type="code-block">    - name: kubetools</code><code data-key="thoughts-13658" data-type="code-block">      image: nathanhuang/kubetools:0.0.1-alpine</code><code data-key="thoughts-13659" data-type="code-block">      command:</code><code data-key="thoughts-13660" data-type="code-block">        - cat</code><code data-key="thoughts-13661" data-type="code-block">      tty: true</code><code data-key="thoughts-13662" data-type="code-block">      volumeMounts:</code><code data-key="thoughts-13663" data-type="code-block">        - name: kube-config</code><code data-key="thoughts-13664" data-type="code-block">          mountPath: /root/.kube/config</code><code data-key="thoughts-13665" data-type="code-block">          subPath: config</code><code data-key="thoughts-13666" data-type="code-block">    - name: docker</code><code data-key="thoughts-13667" data-type="code-block">      image: docker:18.09.7-dind</code><code data-key="thoughts-13668" data-type="code-block">      securityContext:</code><code data-key="thoughts-13669" data-type="code-block">        allowPrivilegeEscalation: true</code><code data-key="thoughts-13670" data-type="code-block">        privileged: true</code><code data-key="thoughts-13671" data-type="code-block">      volumeMounts:</code><code data-key="thoughts-13672" data-type="code-block">        - mountPath: /etc/docker/daemon.json</code><code data-key="thoughts-13673" data-type="code-block">          name: docker-daemon-json</code><code data-key="thoughts-13674" data-type="code-block">          subPath: daemon.json</code><code data-key="thoughts-13675" data-type="code-block">        - mountPath: /etc/docker/docker.config.json</code><code data-key="thoughts-13676" data-type="code-block">          name: docker-config-json</code><code data-key="thoughts-13677" data-type="code-block">          subPath: docker.config.json</code><code data-key="thoughts-13678" data-type="code-block">  volumes:</code><code data-key="thoughts-13679" data-type="code-block">    - name: maven-repo</code><code data-key="thoughts-13680" data-type="code-block">      persistentVolumeClaim:</code><code data-key="thoughts-13681" data-type="code-block">        claimName: mvn-pvc</code><code data-key="thoughts-13682" data-type="code-block">    - name: maven-setting-xml</code><code data-key="thoughts-13683" data-type="code-block">      configMap:</code><code data-key="thoughts-13684" data-type="code-block">        name: maven-setting-xml</code><code data-key="thoughts-13685" data-type="code-block">    - name: docker-daemon-json</code><code data-key="thoughts-13686" data-type="code-block">      configMap:</code><code data-key="thoughts-13687" data-type="code-block">        name: docker-daemon-json</code><code data-key="thoughts-13688" data-type="code-block">    - name: docker-config-json</code><code data-key="thoughts-13689" data-type="code-block">      configMap:</code><code data-key="thoughts-13690" data-type="code-block">        name: docker-config-json</code><code data-key="thoughts-13691" data-type="code-block">    - name: kube-config</code><code data-key="thoughts-13692" data-type="code-block">      configMap:</code><code data-key="thoughts-13693" data-type="code-block">        name: kube-config</code></pre><h3 data-key="6375e71aca6aa6fb1bfbe092" data-type="header-three">优化点：</h3><p data-key="63808361baaa159a40732d08" data-type="paragraph">一、使用nexus私有仓库代理maven中央仓库，加快项目构建速度</p><p data-key="6384573ebaaa151138733ef9" data-type="paragraph">二、使用linux 的tmpfs内存文件系统，使得项目构建过程产生的文件在内存中操作，加快构建速度和减少服务器磁盘压力</p><p data-key="638457c5baaa151a13733f04" data-type="paragraph">三、使用docker in docker 技术，实现每次构建都是原始的、全新的、完整的构建环境</p></div>

        <footer>
            <a href="https://thoughts.teambition.com/" target="_blank">Thoughts</a>
        </footer>
    

</body></html>